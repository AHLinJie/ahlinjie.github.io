<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>LinJie'sBook</title>
        
        <meta name="robots" content="noindex" />
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "light" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="db/index.html"><strong aria-hidden="true">1.</strong> DataBase</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="db/mysql.html"><strong aria-hidden="true">1.1.</strong> MySQL</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="db/mysql-base.html"><strong aria-hidden="true">1.1.1.</strong> MySQL</a></li><li class="chapter-item expanded "><a href="db/mysql-performance.html"><strong aria-hidden="true">1.1.2.</strong> MySQL</a></li></ol></li><li class="chapter-item expanded "><a href="db/redis.html"><strong aria-hidden="true">1.2.</strong> Redis</a></li></ol></li><li class="chapter-item expanded "><a href="js/index.html"><strong aria-hidden="true">2.</strong> Js</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="js/simple-case.html"><strong aria-hidden="true">2.1.</strong> Sample Codes</a></li></ol></li><li class="chapter-item expanded "><a href="rust/index.html"><strong aria-hidden="true">3.</strong> Rust</a></li><li class="chapter-item expanded "><a href="ops/index.html"><strong aria-hidden="true">4.</strong> Ops</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="ops/abtest.html"><strong aria-hidden="true">4.1.</strong> ABtest</a></li><li class="chapter-item expanded "><a href="ops/aliyun.html"><strong aria-hidden="true">4.2.</strong> aliyun</a></li><li class="chapter-item expanded "><a href="ops/bashscript.html"><strong aria-hidden="true">4.3.</strong> bashscript</a></li><li class="chapter-item expanded "><a href="ops/django-gunicorn-nginx.html"><strong aria-hidden="true">4.4.</strong> django-gunicorn-nginx</a></li><li class="chapter-item expanded "><a href="ops/docker.html"><strong aria-hidden="true">4.5.</strong> docker</a></li><li class="chapter-item expanded "><a href="ops/flower.html"><strong aria-hidden="true">4.6.</strong> flower</a></li><li class="chapter-item expanded "><a href="ops/linux-cmd.html"><strong aria-hidden="true">4.7.</strong> linux-cmd</a></li><li class="chapter-item expanded "><a href="ops/markdown.html"><strong aria-hidden="true">4.8.</strong> markdown</a></li><li class="chapter-item expanded "><a href="ops/other.html"><strong aria-hidden="true">4.9.</strong> other</a></li><li class="chapter-item expanded "><a href="ops/supervisor.html"><strong aria-hidden="true">4.10.</strong> supervisor</a></li></ol></li><li class="chapter-item expanded "><a href="py/index.html"><strong aria-hidden="true">5.</strong> Python</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="py/action-exaple.html"><strong aria-hidden="true">5.1.</strong> action-example</a></li><li class="chapter-item expanded "><a href="py/algorithm.html"><strong aria-hidden="true">5.2.</strong> algorithm</a></li><li class="chapter-item expanded "><a href="py/base.html"><strong aria-hidden="true">5.3.</strong> base</a></li><li class="chapter-item expanded "><a href="py/big_float_plus.html"><strong aria-hidden="true">5.4.</strong> big_float_plus</a></li><li class="chapter-item expanded "><a href="py/buildin.html"><strong aria-hidden="true">5.5.</strong> buildin</a></li><li class="chapter-item expanded "><a href="py/code-style.html"><strong aria-hidden="true">5.6.</strong> code-style</a></li><li class="chapter-item expanded "><a href="py/cprofile.html"><strong aria-hidden="true">5.7.</strong> cprofile</a></li><li class="chapter-item expanded "><a href="py/design-model.html"><strong aria-hidden="true">5.8.</strong> design-model</a></li><li class="chapter-item expanded "><a href="py/django-case.html"><strong aria-hidden="true">5.9.</strong> django-case</a></li><li class="chapter-item expanded "><a href="py/django-on-commit.html"><strong aria-hidden="true">5.10.</strong> django-on-commit</a></li><li class="chapter-item expanded "><a href="py/django-queryset-cache.html"><strong aria-hidden="true">5.11.</strong> django-queryset-cache</a></li><li class="chapter-item expanded "><a href="py/django-signal.html"><strong aria-hidden="true">5.12.</strong> django-signal</a></li><li class="chapter-item expanded "><a href="py/django-sql-debug.html"><strong aria-hidden="true">5.13.</strong> django-sql-debug</a></li><li class="chapter-item expanded "><a href="py/excel.html"><strong aria-hidden="true">5.14.</strong> excel</a></li><li class="chapter-item expanded "><a href="py/ipdb.html"><strong aria-hidden="true">5.15.</strong> ipdb</a></li><li class="chapter-item expanded "><a href="py/mypy.html"><strong aria-hidden="true">5.16.</strong> mypy</a></li><li class="chapter-item expanded "><a href="py/nose_test.html"><strong aria-hidden="true">5.17.</strong> nose_test</a></li><li class="chapter-item expanded "><a href="py/numpy.html"><strong aria-hidden="true">5.18.</strong> numpy</a></li><li class="chapter-item expanded "><a href="py/py-object.html"><strong aria-hidden="true">5.19.</strong> py-object</a></li><li class="chapter-item expanded "><a href="py/python-optimize.html"><strong aria-hidden="true">5.20.</strong> python-optimize</a></li><li class="chapter-item expanded "><a href="py/python_unittest.html"><strong aria-hidden="true">5.21.</strong> python_unittest</a></li><li class="chapter-item expanded "><a href="py/requests.html"><strong aria-hidden="true">5.22.</strong> requests</a></li><li class="chapter-item expanded "><a href="py/scrapy.html"><strong aria-hidden="true">5.23.</strong> scrapy</a></li><li class="chapter-item expanded "><a href="py/simple-case.html"><strong aria-hidden="true">5.24.</strong> simple-case</a></li><li class="chapter-item expanded "><a href="py/sort.html"><strong aria-hidden="true">5.25.</strong> sort</a></li><li class="chapter-item expanded "><a href="py/tools.html"><strong aria-hidden="true">5.26.</strong> tools</a></li><li class="chapter-item expanded "><a href="py/tornado.html"><strong aria-hidden="true">5.27.</strong> tornado</a></li><li class="chapter-item expanded "><a href="py/virtualenv.html"><strong aria-hidden="true">5.28.</strong> virtualenv</a></li></ol></li><li class="chapter-item expanded "><a href="other/index.html"><strong aria-hidden="true">6.</strong> Other</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="other/curl.html"><strong aria-hidden="true">6.1.</strong> curl</a></li><li class="chapter-item expanded "><a href="other/easy-talk.html"><strong aria-hidden="true">6.2.</strong> easy-talk</a></li><li class="chapter-item expanded "><a href="other/emacs.html"><strong aria-hidden="true">6.3.</strong> emacs</a></li><li class="chapter-item expanded "><a href="other/git.html"><strong aria-hidden="true">6.4.</strong> git</a></li><li class="chapter-item expanded "><a href="other/real-time-html.html"><strong aria-hidden="true">6.5.</strong> real-time-html</a></li><li class="chapter-item expanded "><a href="other/restful.html"><strong aria-hidden="true">6.6.</strong> restful</a></li><li class="chapter-item expanded "><a href="other/ubuntu-deps.html"><strong aria-hidden="true">6.7.</strong> ubuntu-deps</a></li><li class="chapter-item expanded "><a href="other/vim.html"><strong aria-hidden="true">6.8.</strong> vim</a></li><li class="chapter-item expanded "><a href="other/web-url-flow.html"><strong aria-hidden="true">6.9.</strong> web-url-flow</a></li></ol></li><li class="chapter-item expanded "><a href="about.html"><strong aria-hidden="true">7.</strong> About</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">LinJie'sBook</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#db" id="db">DB</a></h1>
<h1><a class="header" href="#mysql" id="mysql">MySQL</a></h1>
<hr />
<h2>layout: post
title: MySql基础
date: 2015-10-18
tag: mysql 
category: database</h2>
<p><strong>摘要:</strong>
记录mysql数据基础操作内容,增删改查,日期操作,表操作,字段操作.
信息函数,自定义函数,索引操作,数值预算等等数据库操作.存储过程和简单锁策略.</p>
<h4><a class="header" href="#mysql-usually-sentence" id="mysql-usually-sentence">MySql Usually Sentence</a></h4>
<ul>
<li>
<p>show index
<code>show index from &lt;table-name&gt;</code></p>
</li>
<li>
<p>update item field value
<code>update  table_name set field=1 where id=28176</code></p>
</li>
<li>
<p>select items witch is start with &quot;str&quot;
<code>Select * from &lt;table_name&gt;  where &lt;field_name&gt; REGEXP &quot;^str&quot;;</code></p>
</li>
</ul>
<hr />
<h4><a class="header" href="#mysql-between" id="mysql-between">mysql between</a></h4>
<p><code>mysql&gt; select * from clicks where id between 90 and 100;</code></p>
<pre><code>```
+-----+--------+----------------------+---------------------+---------+---------------------+
| id  | linkid | openid               | created             | isvalid | click_time          |
+-----+--------+----------------------+---------------------+---------+---------------------+
|  90 |      1 | 12341122222222222222 | 2015-08-29 10:47:18 |       0 | 2015-08-29 10:47:18 |
|  91 |      1 | 12341122222222222222 | 2015-08-29 10:51:36 |       0 | 2015-08-29 10:51:36 |
|  92 |      1 | 12341122222222222222 | 2015-08-29 10:51:36 |       0 | 2015-08-29 10:51:36 |
|  93 |      1 | 12341122222222222222 | 2015-08-29 10:51:36 |       0 | 2015-08-29 10:51:36 |
|  94 |      1 | 12341122222222222222 | 2015-08-29 10:51:36 |       0 | 2015-08-29 10:51:36 |
|  95 |      1 | 12341122222222222222 | 2015-08-29 10:51:36 |       0 | 2015-08-29 10:51:36 |
|  96 |      1 | 12341122222222222222 | 2015-08-29 10:51:36 |       0 | 2015-08-29 10:51:36 |
|  97 |      1 | 12341122222222222222 | 2015-08-29 10:51:36 |       0 | 2015-08-29 10:51:36 |
|  98 |      1 | 12341122222222222222 | 2015-08-29 10:51:36 |       0 | 2015-08-29 10:51:36 |
|  99 |      1 | 12341122222222222222 | 2015-08-29 10:51:36 |       0 | 2015-08-29 10:51:36 |
| 100 |      1 | 12341122222222222222 | 2015-08-29 10:51:36 |       0 | 2015-08-29 10:51:36 |
+-----+--------+----------------------+---------------------+---------+---------------------+
11 rows in set (0.00 sec)
```
</code></pre>
<hr />
<h4><a class="header" href="#assign-prompt" id="assign-prompt">Assign Prompt</a></h4>
<p><code>mysql -u root -p --prompt \h</code>  # --prompt 表示设置提示符是什么  \h 表示localhost</p>
<pre><code>\D  完整日期
\d  当前数据库
\h  当前主机
\u  当前用户
</code></pre>
<p><code>mysql -u root -p</code>
登陆后输入如下命令: prompt \u@\h \d&gt;</p>
<hr />
<h4><a class="header" href="#base" id="base">Base</a></h4>
<pre><code>root@localhost mydb&gt;select user();
+----------------+
| user()         |
+----------------+
| root@localhost |
+----------------+
1 row in set (0.00 sec)

root@localhost mydb&gt;select version();
+------------+
| version()  |
+------------+
| 5.6.21-log |
+------------+
1 row in set (0.00 sec)

root@localhost mydb&gt;
root@localhost mydb&gt;select now();
+---------------------+
| now()               |
+---------------------+
| 2015-04-05 20:52:40 |
+---------------------+
1 row in set (0.00 sec)

root@localhost mydb&gt;


root@localhost mydb&gt;CREATE DATABASE IF NOT EXISTS muke;
Query OK, 1 row affected, 1 warning (0.00 sec)

root@localhost mydb&gt;SHOW WARNINGS;    # 查看警告信息
+-------+------+-----------------------------------------------+
| Level | Code | Message                                       |
+-------+------+-----------------------------------------------+
| Note  | 1007 | Can't create database 'muke'; database exists |
+-------+------+-----------------------------------------------+
1 row in set (0.00 sec)

root@localhost mydb&gt;

root@localhost mydb&gt;SHOW CREATE DATABASE muke; # 查看新建数据库的时候是用的什么命令  查看是什么编码方式
+----------+---------------------------------------------------------------+
| Database | Create Database                                               |
+----------+---------------------------------------------------------------+
| muke     | CREATE DATABASE `muke` /*!40100 DEFAULT CHARACTER SET utf8 */ |
+----------+---------------------------------------------------------------+
1 row in set (0.00 sec)


root@localhost mydb&gt;CREATE DATABASE IF NOT EXISTS t2 CHARACTER SET gbk;  # 指定编码模式
Query OK, 1 row affected (0.00 sec)

root@localhost mydb&gt;SHOW CREATE DATABASE t2;    # 查看编码模式
+----------+------------------------------------------------------------+
| Database | Create Database                                            |
+----------+------------------------------------------------------------+
| t2       | CREATE DATABASE `t2` /*!40100 DEFAULT CHARACTER SET gbk */ |
+----------+------------------------------------------------------------+
1 row in set (0.00 sec)

root@localhost mydb&gt;
root@localhost mydb&gt;ALTER DATABASE t2 CHARACTER SET = UTF8;     # 修改编码方式
Query OK, 1 row affected (0.01 sec)

root@localhost mydb&gt;SHOW CREATE DATABASE t2;    # 查看编码方式
+----------+-------------------------------------------------------------+
| Database | Create Database                                             |
+----------+-------------------------------------------------------------+
| t2       | CREATE DATABASE `t2` /*!40100 DEFAULT CHARACTER SET utf8 */ |
+----------+-------------------------------------------------------------+
1 row in set (0.00 sec)

root@localhost mydb&gt;
root@localhost mydb&gt;DROP DATABASE IF EXISTS t2;# 删除数据库（如果存在的话）
Query OK, 0 rows affected (0.06 sec)
</code></pre>
<hr />
<h4><a class="header" href="#data-types" id="data-types">Data Types</a></h4>
<ul>
<li>日期时间类型在实际开发的过程中用的不是很多，多是以时间戳的形式使用</li>
</ul>
<hr />
<h4><a class="header" href="#table" id="table">Table</a></h4>
<ul>
<li>mysql -u root -p -P 3306 -h 127.0.0.1    # 登陆连接数据库</li>
</ul>
<pre><code>mysql&gt;USE muke;
Database changed
mysql&gt;
mysql&gt; SELECT DATABASE();    # 查看当前使用的数据库
+------------+
| DATABASE() |
+------------+
| muke       |
+------------+
1 row in set (0.00 sec)
</code></pre>
<ol>
<li>
<p>Create table</p>
<pre><code>mysql&gt; CREATE TABLE IF NOT EXISTS tb1(
    -&gt; username VARCHAR(20) NOT NULL,
    -&gt; age TINYINT UNSIGNED,
    -&gt; salary FLOAT(8,2) UNSIGNED
    -&gt; );
Query OK, 0 rows affected (0.34 sec)
</code></pre>
</li>
<li>
<p>Show table</p>
<pre><code>mysql&gt; SHOW TABLES;    # 查看数据表
+----------------+
| Tables_in_muke |
+----------------+
| tb1            |
+----------------+
1 row in set (0.00 sec)
</code></pre>
<pre><code>mysql&gt; SHOW TABLES FROM mysql;    # 从mysql数据中查看表
+---------------------------+
| Tables_in_mysql           |
+---------------------------+
| columns_priv              |
| db                        |
| event                     |
| func                      |
| general_log               |
| help_category             |
| help_keyword              |
| help_relation             |
| help_topic                |
| innodb_index_stats        |
| innodb_table_stats        |
| ndb_binlog_index          |
| plugin                    |
| proc                      |
| procs_priv                |
| proxies_priv              |
| servers                   |
| slave_master_info         |
| slave_relay_log_info      |
| slave_worker_info         |
| slow_log                  |
| tables_priv               |
| time_zone                 |
| time_zone_leap_second     |
| time_zone_name            |
| time_zone_transition      |
| time_zone_transition_type |
| user                      |
+---------------------------+
28 rows in set (0.09 sec)
</code></pre>
</li>
<li>
<p>Show table colums</p>
<pre><code>mysql&gt; SHOW COLUMNS FROM tb1;        # 查看数据表的结构(列名称)和数据类型
+----------+---------------------+------+-----+---------+-------+
| Field    | Type                | Null | Key | Default | Extra |
+----------+---------------------+------+-----+---------+-------+
| username | varchar(20)         | NO  |     | NULL    |       |
| age      | tinyint(3) unsigned | YES  |     | NULL    |       |
| salary   | float(8,2) unsigned | YES  |     | NULL    |       |
+----------+---------------------+------+-----+---------+-------+
3 rows in set (0.00 sec)
</code></pre>
</li>
<li>
<p>Insert data into table</p>
<pre><code>mysql&gt; INSERT tb1 VALUES('TOM',25,7863.65);
Query OK, 1 row affected (0.10 sec)
mysql&gt; INSERT tb1 VALUES('MAX',25,7863.65);
Query OK, 1 row affected (0.06 sec)
mysql&gt; INSERT tb1(username,salary) VALUES('Linjie',8000);    # 指定列名称插入内容
Query OK, 1 row affected (0.09 sec)
mysql&gt; SELECT * FROM tb1;
+----------+------+---------+
| username | age  | salary  |
+----------+------+---------+
| TOM      |   25 | 7863.65 |
| MAX      |   25 | 7863.65 |
| Linjie   | NULL | 8000.00 |
+----------+------+---------+
</code></pre>
</li>
</ol>
<hr />
<h4><a class="header" href="#key" id="key">Key</a></h4>
<ol>
<li>
<p>Primary key</p>
<pre><code>
mysql&gt; CREATE TABLE tb3 (
    -&gt; id SMALLINT UNSIGNED  AUTO_INCREMENT PRIMARY KEY,
    -&gt; username VARCHAR(20)
    -&gt; );
Query OK, 0 rows affected (0.62 sec)

mysql&gt; SHOW COLUMNS FROM tb3;
+----------+----------------------+------+-----+---------+----------------+
| Field    | Type                 | Null | Key | Default | Extra          |
+----------+----------------------+------+-----+---------+----------------+
| id       | smallint(5) unsigned | NO   | PRI | NULL    | auto_increment |
| username | varchar(20)          | YES  |     | NULL    |                |
+----------+----------------------+------+-----+---------+----------------+

mysql&gt; INSERT tb3 (username) VALUES('tom');
Query OK, 1 row affected (0.08 sec)

mysql&gt; INSERT tb3 (username) VALUES('tom2');
Query OK, 1 row affected (0.07 sec)

mysql&gt; INSERT tb3 (username) VALUES('MAX');
Query OK, 1 row affected (0.06 sec)

mysql&gt; SELECT * FROM tb3;
+----+----------+
| id | username |
+----+----------+
|  1 | tom      |
|  2 | tom2     |
|  3 | MAX      |
+----+----------+
</code></pre>
</li>
<li>
<p>Unique key</p>
<p>主键在一张表中只能有一个且不能为空且唯一，unique key 一张表可以多个并且可以有空值，保证字段的唯一性.</p>
<pre><code>mysql&gt; CREATE TABLE tb4
    -&gt; (
    -&gt; id SMALLINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    -&gt; username VARCHAR(20) NOT NULL UNIQUE KEY,
    -&gt; age TINYINT UNSIGNED);
Query OK, 0 rows affected (0.50 sec)

mysql&gt; SHOW COLUMNS FROM tb4;
+----------+----------------------+------+-----+---------+----------------+
| Field    | Type                 | Null | Key | Default | Extra          |
+----------+----------------------+------+-----+---------+----------------+
| id       | smallint(5) unsigned | NO   | PRI | NULL    | auto_increment |
| username | varchar(20)          | NO   | UNI | NULL    |                |
| age      | tinyint(3) unsigned  | YES  |     | NULL    |                |
+----------+----------------------+------+-----+---------+----------------+
mysql&gt; INSERT tb4(username, age)VALUES('TOM',22) ;
mysql&gt; INSERT tb4(username, age)VALUES('TOM',22);
ERROR 1062 (23000): Duplicate entry 'TOM' for key 'username'   # 唯一性约束

</code></pre>
</li>
<li>
<p>Default </p>
<pre><code>mysql&gt; CREATE TABLE tb6(
    -&gt; id SMALLINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    -&gt; username VARCHAR(20) NOT NULL UNIQUE KEY,
    -&gt; sex ENUM('M','F','S') DEFAULT 'S'
    -&gt; );
Query OK, 0 rows affected (0.31 sec)

mysql&gt; SHOW COLUMNS FROM tb6;
+----------+----------------------+------+-----+---------+----------------+
| Field    | Type                 | Null | Key | Default | Extra          |
+----------+----------------------+------+-----+---------+----------------+
| id       | smallint(5) unsigned | NO   | PRI | NULL    | auto_increment |
| username | varchar(20)          | NO   | UNI | NULL    |                |
| sex      | enum('M','F','S')    | YES  |     | S       |                |
+----------+----------------------+------+-----+---------+----------------+
3 rows in set (0.02 sec)

mysql&gt;
mysql&gt; INSERT tb6 (username) VALUES('TOM');
Query OK, 1 row affected (0.06 sec)

mysql&gt; SELECT * FROM tb6;
+----+----------+------+
| id | username | sex  |
+----+----------+------+
|  1 | TOM      | S    |
+----+----------+------+
1 row in set (0.00 sec)
</code></pre>
</li>
<li>
<p>Forning key</p>
<p>4.1 父表和子表有相同的数据引擎且为InnoDB，</p>
<p>4.2 外键列和参照列必须具有相似的数据类型，且数字的长度和有无符号必须相同，字符长度可以不同</p>
<p>4.3 外键列和参照列必须创建索引，如果参照列没有索引MySQL会自动创建索引。</p>
<pre><code>root@127.0.0.1 muke&gt;CREATE TABLE province(
    -&gt; id SMALLINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
    -&gt; pname VARCHAR(20) NOT NULL
    -&gt; );
Query OK, 0 rows affected (0.55 sec)

root@127.0.0.1 muke&gt;
root@127.0.0.1 muke&gt;SHOW CREATE TABLE provience;
ERROR 1146 (42S02): Table 'muke.provience' doesn't exist
root@127.0.0.1 muke&gt;SHOW CREATE TABLE province;

| Table    | Create Table|
| province | CREATE TABLE `province` (
  `id` smallint(5) unsigned NOT NULL AUTO_INCREMENT,
  `pname` varchar(20) NOT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 |

root@127.0.0.1 muke&gt;CREATE TABLE users(
    -&gt; id SMALLINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
    -&gt; username VARCHAR(10) NOT NULL,
    -&gt; pid SMALLINT UNSIGNED,
    -&gt; FOREIGN KEY (pid) REFERENCES province(id)
    -&gt; );
Query OK, 0 rows affected (0.29 sec)

root@127.0.0.1 muke&gt;SHOW CREATE TABLE users;

| Table | Create Table|
| users | CREATE TABLE `users` (
  `id` smallint(5) unsigned NOT NULL AUTO_INCREMENT,
  `username` varchar(10) NOT NULL,
  `pid` smallint(5) unsigned DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `pid` (`pid`),
  CONSTRAINT `users_ibfk_1` FOREIGN KEY (`pid`) REFERENCES `province` (`id`)   # 外键参照列
) ENGINE=InnoDB DEFAULT CHARSET=utf8 |

root@127.0.0.1 muke&gt;SHOW INDEXES FROM province \G;   # \G是表示以网格形式显示   这里的参照咧自动生成索引
*************************** 1. row ***************************
        Table: province
   Non_unique: 0
     Key_name: PRIMARY
 Seq_in_index: 1
  Column_name: id
    Collation: A
  Cardinality: 0
     Sub_part: NULL
       Packed: NULL
         Null:
   Index_type: BTREE
      Comment:
Index_comment:
1 row in set (0.00 sec)

ERROR:
No query specified

root@127.0.0.1 muke&gt;

root@127.0.0.1 muke&gt;SHOW INDEXES FROM users \G;
*************************** 1. row ***************************
        Table: users
   Non_unique: 0
     Key_name: PRIMARY
 Seq_in_index: 1
  Column_name: id
    Collation: A
  Cardinality: 0
     Sub_part: NULL
       Packed: NULL
         Null:
   Index_type: BTREE
      Comment:
Index_comment:
*************************** 2. row ***************************
        Table: users
   Non_unique: 1
     Key_name: pid
 Seq_in_index: 1
  Column_name: pid
    Collation: A
  Cardinality: 0
     Sub_part: NULL
       Packed: NULL
         Null: YES
   Index_type: BTREE
      Comment:
Index_comment:
2 rows in set (0.00 sec)

</code></pre>
</li>
<li>
<p>外键约束的参照操作</p>
<pre><code>root@127.0.0.1 muke&gt;CREATE TABLE users1(
    -&gt; id SMALLINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
    -&gt; username VARCHAR(10) NOT NULL,
    -&gt; pid SMALLINT UNSIGNED,
    -&gt; FOREIGN KEY (pid) REFERENCES province(id) ON DELETE CASCADE
    -&gt; );
Query OK, 0 rows affected (0.31 sec)
</code></pre>
<pre><code>root@127.0.0.1 muke&gt;
root@127.0.0.1 muke&gt;SHOW CREATE TABLE users1;
| Table  | Create Table|
| users1 | CREATE TABLE `users1` (
  `id` smallint(5) unsigned NOT NULL AUTO_INCREMENT,
  `username` varchar(10) NOT NULL,
  `pid` smallint(5) unsigned DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `pid` (`pid`),
  CONSTRAINT `users1_ibfk_1` FOREIGN KEY (`pid`) REFERENCES `province` (`id`) ON
 DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8 |
1 row in set (0.00 sec)

root@127.0.0.1 muke&gt;SHOW CREATE TABLE users1 \G;
*************************** 1. row ***************************
       Table: users1
Create Table: CREATE TABLE `users1` (
  `id` smallint(5) unsigned NOT NULL AUTO_INCREMENT,
  `username` varchar(10) NOT NULL,
  `pid` smallint(5) unsigned DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `pid` (`pid`),
  CONSTRAINT `users1_ibfk_1` FOREIGN KEY (`pid`) REFERENCES `province` (`id`) ON
 DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8
1 row in set (0.00 sec)

</code></pre>
<pre><code>root@127.0.0.1 muke&gt;
root@127.0.0.1 muke&gt;INSERT province (pname) VALUES('A');
Query OK, 1 row affected (0.07 sec)

root@127.0.0.1 muke&gt;INSERT province (pname) VALUES('B');
Query OK, 1 row affected (0.07 sec)

root@127.0.0.1 muke&gt;INSERT province (pname) VALUES('C');
Query OK, 1 row affected (0.07 sec)

root@127.0.0.1 muke&gt;SELECT * FROM province;
+----+-------+
| id | pname |
+----+-------+
|  1 | A     |
|  2 | B     |
|  3 | C     |
+----+-------+

root@127.0.0.1 muke&gt;INSERT user1 (username, pid)VALUES('john',7);
ERROR 1146 (42S02): Table 'muke.user1' doesn't exist
root@127.0.0.1 muke&gt;INSERT users1 (username, pid)VALUES('john',1);
Query OK, 1 row affected (0.07 sec)

root@127.0.0.1 muke&gt;INSERT users1 (username, pid)VALUES('john',7);    # 没有对应的参照列 
ERROR 1452 (23000): Cannot add or update a child row: a foreign key constraint f
ails (`muke`.`users1`, CONSTRAINT `users1_ibfk_1` FOREIGN KEY (`pid`) REFERENCES
 `province` (`id`) ON DELETE CASCADE)
root@127.0.0.1 muke&gt;INSERT users1 (username, pid)VALUES('MAX',3);
Query OK, 1 row affected (0.04 sec)

root@127.0.0.1 muke&gt;SELECT * FROM users1;
+----+----------+------+
| id | username | pid  |
+----+----------+------+
|  1 | john     |    1 |
|  3 | MAX      |    3 |
+----+----------+------+
2 rows in set (0.00 sec)        # 这里没有id为2的是因为，&gt;INSERT users1 (username, pid)VALUES('john',7);的时候自增长了1

root@127.0.0.1 muke&gt;
root@127.0.0.1 muke&gt;DELETE FROM province WHERE id=3;
Query OK, 1 row affected (0.06 sec)

root@127.0.0.1 muke&gt;SELECT * FROM user1;        #ON DELETE CASCADE 的作用子表中删除情况的更新
ERROR 1146 (42S02): Table 'muke.user1' doesn't exist
root@127.0.0.1 muke&gt;SELECT * FROM users1;
+----+----------+------+
| id | username | pid  |
+----+----------+------+
|  1 | john     |    1 |
+----+----------+------+
</code></pre>
<p><strong>注意</strong>实际的项目开发中，不去定义物理的外键，多去定义逻辑外键，很少用FOREIGN KEY来定义</p>
<p><strong>注意</strong>:实际开发过程中很少用 表级约束多用列级约束。</p>
<pre><code>root@127.0.0.1 muke&gt;SHOW COLUMNS FROM users1;
+----------+----------------------+------+-----+---------+----------------+
| Field    | Type                 | Null | Key | Default | Extra          |
+----------+----------------------+------+-----+---------+----------------+
| id       | smallint(5) unsigned | NO   | PRI | NULL    | auto_increment |
| username | varchar(10)          | NO   |     | NULL    |                |
| pid      | smallint(5) unsigned | YES  | MUL | NULL    |                |
+----------+----------------------+------+-----+---------+----------------+

</code></pre>
</li>
<li>
<p>Table modity</p>
<pre><code>    root@127.0.0.1 muke&gt;ALTER TABLE users1 ADD age TINYINT UNSIGNED NOT NULL DEFAULT 10;
    Query OK, 0 rows affected (1.08 sec)
    Records: 0  Duplicates: 0  Warnings: 0
    
    root@127.0.0.1 muke&gt;ALTER TABLE users1 ADD passwd VARCHARA(20) NOT NULL AFTER username;
    ERROR 1064 (42000): You have an error in your SQL syntax; check the manual that
    corresponds to your MySQL server version for the right syntax to use near 'VARCH
    ARA(20) NOT NULL AFTER username' at line 1
    root@127.0.0.1 muke&gt;ALTER TABLE users1 ADD passwd VARCHAR(20) NOT NULL AFTER username;
    Query OK, 0 rows affected (1.09 sec)
    Records: 0  Duplicates: 0  Warnings: 0
    
</code></pre>
<p><strong>注意</strong>:添加多列的时候只能添加到表的最后面。</p>
<ul>
<li>删除列：</li>
</ul>
<pre><code>root@127.0.0.1 muke&gt;ALTER TABLE users1 DROP passwd;
Query OK, 0 rows affected (1.07 sec)
Records: 0  Duplicates: 0  Warnings: 0

root@127.0.0.1 muke&gt;SHOW COLUMnS FROM users1;
+----------+----------------------+------+-----+---------+----------------+
| Field    | Type                 | Null | Key | Default | Extra          |
+----------+----------------------+------+-----+---------+----------------+
| id       | smallint(5) unsigned | NO   | PRI | NULL    | auto_increment |
| username | varchar(10)          | NO   |     | NULL    |                |
| pid      | smallint(5) unsigned | YES  | MUL | NULL    |                |
| age      | tinyint(3) unsigned  | NO   |     | 10      |                |
+----------+----------------------+------+-----+---------+----------------+
4 rows in set (0.00 sec)
</code></pre>
<ul>
<li>添加主键约束：</li>
</ul>
<pre><code>root@127.0.0.1 muke&gt;CREATE TABLE users2(
-&gt; username VARCHAR(20) NOT NULL,
-&gt; pid SMALLINT UNSIGNED
-&gt; );
Query OK, 0 rows affected (0.71 sec)
</code></pre>
<pre><code>root@127.0.0.1 muke&gt;ALTER TABLE users2 ADD id SMALLINT UNSIGNED;
Query OK, 0 rows affected (0.69 sec)
Records: 0  Duplicates: 0  Warnings: 0

root@127.0.0.1 muke&gt;ALTER TABLE users2 ADD CONSTRAINT PK_user2_id PRIMARY KEY (id);    #  CONSTRAINT PK_user2_id 表示添加操作的说明
Query OK, 0 rows affected (0.76 sec)
Records: 0  Duplicates: 0  Warnings: 0
</code></pre>
<ul>
<li>添加唯一约束：</li>
</ul>
<pre><code>root@127.0.0.1 muke&gt;ALTER TABLE users2 ADD UNIQUE(username);
Query OK, 0 rows affected (0.32 sec)
Records: 0  Duplicates: 0  Warnings: 0

root@127.0.0.1 muke&gt;SHOW CREATE TABLE users2;
| users2 | CREATE TABLE `users2` (
  `username` varchar(20) NOT NULL,
  `pid` smallint(5) unsigned DEFAULT NULL,
  `id` smallint(5) unsigned NOT NULL DEFAULT '0',
  PRIMARY KEY (`id`),
  UNIQUE KEY `username` (`username`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 |
</code></pre>
<ul>
<li>添加外键约束：</li>
</ul>
<pre><code>root@127.0.0.1 muke&gt;SHOW COLUMNS from  province;
+-------+----------------------+------+-----+---------+----------------+
| Field | Type                 | Null | Key | Default | Extra          |
+-------+----------------------+------+-----+---------+----------------+
| id    | smallint(5) unsigned | NO   | PRI | NULL    | auto_increment |
| pname | varchar(20)          | NO   |     | NULL    |                |
+-------+----------------------+------+-----+---------+----------------+

root@127.0.0.1 muke&gt;ALTER TABLE users2 ADD FOREIGN KEY (pid) REFERENCES province (id);
root@127.0.0.1 muke&gt;SHOW CREATE TABLE users2;
| users2 | CREATE TABLE `users2` (
  `username` varchar(20) NOT NULL,
  `pid` smallint(5) unsigned DEFAULT NULL,
  `id` smallint(5) unsigned NOT NULL DEFAULT '0',
  PRIMARY KEY (`id`),
  UNIQUE KEY `username` (`username`),
  KEY `pid` (`pid`),
  CONSTRAINT `users2_ibfk_1` FOREIGN KEY (`pid`) REFERENCES `province` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 |
</code></pre>
<ul>
<li>添加默认约束：</li>
</ul>
<pre><code>root@127.0.0.1 muke&gt;ALTER TABLE users2 ADD age TINYINT UNSIGNED NOT NULL;
root@127.0.0.1 muke&gt;SHOW COLUMNS FROM users2;
+----------+----------------------+------+-----+---------+-------+
| Field    | Type                 | Null | Key | Default | Extra |
+----------+----------------------+------+-----+---------+-------+
| username | varchar(20)          | NO   | UNI | NULL    |       |
| pid      | smallint(5) unsigned | YES  | MUL | NULL    |       |
| id       | smallint(5) unsigned | NO   | PRI | 0       |       |
| age      | tinyint(3) unsigned  | NO   |     | NULL    |       |
+----------+----------------------+------+-----+---------+-------+

root@127.0.0.1 muke&gt;ALTER TABLE users2 ALTER age SET DEFAULT 15;
root@127.0.0.1 muke&gt;SHOW COLUMNS FROM users2;
+----------+----------------------+------+-----+---------+-------+
| Field    | Type                 | Null | Key | Default | Extra |
+----------+----------------------+------+-----+---------+-------+
| username | varchar(20)          | NO   | UNI | NULL    |       |
| pid      | smallint(5) unsigned | YES  | MUL | NULL    |       |
| id       | smallint(5) unsigned | NO   | PRI | 0       |       |
| age      | tinyint(3) unsigned  | NO   |     | 15      |       |
+----------+----------------------+------+-----+---------+-------+
</code></pre>
<pre><code>root@127.0.0.1 muke&gt;ALTER TABLE users2 ALTER age DROP DEFAULT;
root@127.0.0.1 muke&gt;SHOW COLUMNS FROM users2;
+----------+----------------------+------+-----+---------+-------+
| Field    | Type                 | Null | Key | Default | Extra |
+----------+----------------------+------+-----+---------+-------+
| username | varchar(20)          | NO   | UNI | NULL    |       |
| pid      | smallint(5) unsigned | YES  | MUL | NULL    |       |
| id       | smallint(5) unsigned | NO   | PRI | 0       |       |
| age      | tinyint(3) unsigned  | NO   |     | NULL    |       |
+----------+----------------------+------+-----+---------+-------+

root@127.0.0.1 muke&gt;SHOW COLUMNS FROM users2;
+----------+----------------------+------+-----+---------+-------+
| Field    | Type                 | Null | Key | Default | Extra |
+----------+----------------------+------+-----+---------+-------+
| username | varchar(20)          | NO   | UNI | NULL    |       |
| pid      | smallint(5) unsigned | YES  | MUL | NULL    |       |
| id       | smallint(5) unsigned | NO   | PRI | 0       |       |
| age      | tinyint(3) unsigned  | NO   |     | NULL    |       |
+----------+----------------------+------+-----+---------+-------+
</code></pre>
<pre><code>root@127.0.0.1 muke&gt;ALTER TABLE users2 DROP  PRIMARY KEY;
root@127.0.0.1 muke&gt;SHOW COLUMNS FROM users2;
+----------+----------------------+------+-----+---------+-------+
| Field    | Type                 | Null | Key | Default | Extra |
+----------+----------------------+------+-----+---------+-------+
| username | varchar(20)          | NO   | PRI | NULL    |       |
| pid      | smallint(5) unsigned | YES  | MUL | NULL    |       |
| id       | smallint(5) unsigned | NO   |     | 0       |       |
| age      | tinyint(3) unsigned  | NO   |     | NULL    |       |
+----------+----------------------+------+-----+---------+-------+

root@127.0.0.1 muke&gt;SHOW INDEXES FROM users2 \G;
*************************** 1. row ***************************
        Table: users2
   Non_unique: 0
     Key_name: username          # 约束名称
 Seq_in_index: 1
  Column_name: username
    Collation: A
  Cardinality: 0
     Sub_part: NULL
       Packed: NULL
         Null:
   Index_type: BTREE
      Comment:
Index_comment:
*************************** 2. row ***************************
        Table: users2
   Non_unique: 1
     Key_name: pid
 Seq_in_index: 1
  Column_name: pid
    Collation: A
  Cardinality: 0
     Sub_part: NULL
       Packed: NULL
         Null: YES
   Index_type: BTREE
      Comment:
Index_comment:
2 rows in set (0.00 sec)
</code></pre>
<pre><code>ERROR:
No query specified

root@127.0.0.1 muke&gt;ALTER TABLE users2 DROP INDEX username;        #  删除索引
Query OK, 0 rows affected (0.89 sec)
Records: 0  Duplicates: 0  Warnings: 0
root@127.0.0.1 muke&gt;SHOW COLUMNS FROM users2;
+----------+----------------------+------+-----+---------+-------+
| Field    | Type                 | Null | Key | Default | Extra |
+----------+----------------------+------+-----+---------+-------+
| username | varchar(20)          | NO   |     | NULL    |       |
| pid      | smallint(5) unsigned | YES  | MUL | NULL    |       |
| id       | smallint(5) unsigned | NO   |     | 0       |       |
| age      | tinyint(3) unsigned  | NO   |     | NULL    |       |
+----------+----------------------+------+-----+---------+-------+
4 rows in set (0.00 sec)

root@127.0.0.1 muke&gt;SHOW INDExES FROM users2 \G;        # 查看索引
*************************** 1. row ***************************
        Table: users2
   Non_unique: 1
     Key_name: pid
 Seq_in_index: 1
  Column_name: pid
    Collation: A
  Cardinality: 0
     Sub_part: NULL
       Packed: NULL
         Null: YES
   Index_type: BTREE
      Comment:
Index_comment:
1 row in set (0.00 sec)
ERROR:
No query specified
</code></pre>
<ul>
<li>删除外键约束：</li>
</ul>
<pre><code>root@127.0.0.1 muke&gt;SHOW CREATE TABLE users2;
| users2 | CREATE TABLE `users2` (
  `username` varchar(20) NOT NULL,
  `pid` smallint(5) unsigned DEFAULT NULL,
  `id` smallint(5) unsigned NOT NULL DEFAULT '0',
  `age` tinyint(3) unsigned NOT NULL,
  KEY `pid` (`pid`),
  CONSTRAINT `users2_ibfk_1` FOREIGN KEY (`pid`) REFERENCES `province` (`id`)    # 外键名称
) ENGINE=InnoDB DEFAULT CHARSET=utf8 |

root@127.0.0.1 muke&gt;ALTER TABLE users2 DROP FOREIGN KEY users2_ibfk_1;   # 删除外键
Query OK, 0 rows affected (0.13 sec)
Records: 0  Duplicates: 0  Warnings: 0

root@127.0.0.1 muke&gt;SHOW CREATE TABLE users2;
| users2 | CREATE TABLE `users2` (
  `username` varchar(20) NOT NULL,
  `pid` smallint(5) unsigned DEFAULT NULL,
  `id` smallint(5) unsigned NOT NULL DEFAULT '0',
  `age` tinyint(3) unsigned NOT NULL,
  KEY `pid` (`pid`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 |
</code></pre>
<ul>
<li>数据类型有问题，位置存在问题，</li>
</ul>
<pre><code>root@127.0.0.1 muke&gt;ALTER TABLE users2 MODIFY id SMALLINT UNSIGNED NOT NULL FIRST;
Query OK, 0 rows affected (0.45 sec)
Records: 0  Duplicates: 0  Warnings: 0

root@127.0.0.1 muke&gt;SHOW COLUMNS FROM users2;
+----------+----------------------+------+-----+---------+-------+
| Field    | Type                 | Null | Key | Default | Extra |
+----------+----------------------+------+-----+---------+-------+
| id       | smallint(5) unsigned | NO   |     | NULL    |       |
| username | varchar(20)          | NO   |     | NULL    |       |
| pid      | smallint(5) unsigned | YES  | MUL | NULL    |       |
| age      | tinyint(3) unsigned  | NO   |     | NULL    |       |
+----------+----------------------+------+-----+---------+-------+
4 rows in set (0.00 sec)

root@127.0.0.1 muke&gt;ALTER TABLE users2 MODIFY id TINYINT UNSIGNED NOT NULL FIRST        #  注意这里如果从小的数据类型修改到大的数据类型 有可能会造成数据丢失
;
Query OK, 0 rows affected (0.97 sec)
Records: 0  Duplicates: 0  Warnings: 0

root@127.0.0.1 muke&gt;SHOW COLUMNS FROM users2;
+----------+----------------------+------+-----+---------+-------+
| Field    | Type                 | Null | Key | Default | Extra |
+----------+----------------------+------+-----+---------+-------+
| id       | tinyint(3) unsigned  | NO   |     | NULL    |       |
| username | varchar(20)          | NO   |     | NULL    |       |
| pid      | smallint(5) unsigned | YES  | MUL | NULL    |       |
| age      | tinyint(3) unsigned  | NO   |     | NULL    |       |
+----------+----------------------+------+-----+---------+-------+
4 rows in set (0.00 sec)
</code></pre>
<pre><code>root@127.0.0.1 muke&gt;ALTER TABLE users2 CHANGE pid p_id TINYINT UNSIGNED NOT NULL;        # CHANGE 的功能更多（可以修改列名称）
Query OK, 0 rows affected (0.87 sec)
Records: 0  Duplicates: 0  Warnings: 0

root@127.0.0.1 muke&gt;SHOW COLUMNS FROM users2;
+----------+---------------------+------+-----+---------+-------+
| Field    | Type                | Null | Key | Default | Extra |
+----------+---------------------+------+-----+---------+-------+
| id       | tinyint(3) unsigned | NO   |     | NULL    |       |
| username | varchar(20)         | NO   |     | NULL    |       |
| p_id     | tinyint(3) unsigned | NO   | MUL | NULL    |       |
| age      | tinyint(3) unsigned | NO   |     | NULL    |       |
+----------+---------------------+------+-----+---------+-------+
4 rows in set (0.01 sec)
</code></pre>
<ul>
<li>
<p>修改数据表的名称：</p>
<p><strong>注意：尽量少去修改数据表名称  ，因为有索引已经存储过程的影响。</strong></p>
</li>
</ul>
<pre><code>root@127.0.0.1 muke&gt;ALTER TABLE users2 RENAME users3;
Query OK, 0 rows affected (0.19 sec)

root@127.0.0.1 muke&gt;show tables;
+----------------+
| Tables_in_muke |
+----------------+
| province       |
| tb1            |
| tb3            |
| tb4            |
| tb6            |
| users          |
| users1         |
| users3         |
+----------------+
8 rows in set (0.00 sec)
</code></pre>
<pre><code>root@127.0.0.1 muke&gt;RENAME  TABLE users3 TO users2;        # 可以多张表修改
Query OK, 0 rows affected (0.20 sec)

root@127.0.0.1 muke&gt;show tables;
+----------------+
| Tables_in_muke |
+----------------+
| province       |
| tb1            |
| tb3            |
| tb4            |
| tb6            |
| users          |
| users1         |
| users2         |
+----------------+
8 rows in set (0.00 sec)
</code></pre>
</li>
</ol>
<hr />
<h4><a class="header" href="#insert-语句" id="insert-语句">INSERT 语句</a></h4>
<pre><code>root@127.0.0.1 muke&gt;CREATE TABLE users4(
    -&gt; id SMALLINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
    -&gt; username VARCHAR(20) NOT NULL,
    -&gt; passwd VARCHAR(20) NOT NULL,
    -&gt; age TINYINT UNSIGNED NOT NULL DEFAULT 18,
    -&gt; sex BOOLEAN
    -&gt; );
Query OK, 0 rows affected (0.41 sec)

...

mysql&gt; SELECT * FROM users4;
+----+----------+--------+-----+------+
| id | username | passwd | age | sex  |
+----+----------+--------+-----+------+
|  1 | JOHN     | 123    |  24 |    1 |
|  2 | JOHN     | 123    |  24 |    1 |
|  3 | MAX      | 223    |  24 |    1 |
|  4 | JOHN     | 123    |  22 |    1 |
|  5 | JOHN     | 123    |  18 |    1 |
+----+----------+--------+-----+------+
5 rows in set (0.00 sec)

mysql&gt;
mysql&gt; INSERT users4 VALUES(NULL,'lINJIE','520',25,1),(NULL,'ZHANG',md5'112',24,1);
ERROR 1064 (42000): You have an error in your SQL syntax; check the manual that
corresponds to your MySQL server version for the right syntax to use near ''112'
,24,1)' at line 1
mysql&gt; INSERT users4 VALUES(NULL,'lINJIE','520',25,1),(NULL,'ZHANG',md5('112'),2
4,1);
ERROR 1406 (22001): Data too long for column 'passwd' at row 2    # 提示不够长，无法存储
mysql&gt;
mysql&gt; ALTER TABLE users4 MODIFY passwd VARCHAR(32) NOT NULL;
Query OK, 5 rows affected (0.87 sec)
Records: 5  Duplicates: 0  Warnings: 0

mysql&gt; INSERT users4 VALUES(NULL,'lINJIE','520',25,1),(NULL,'ZHANG',md5('112'),24,1);
Query OK, 2 rows affected (0.08 sec)
Records: 2  Duplicates: 0  Warnings: 0

mysql&gt; SELECT * FROM users4;
+----+----------+----------------------------------+-----+------+
| id | username | passwd                           | age | sex  |
+----+----------+----------------------------------+-----+------+
|  1 | JOHN     | 123                              |  24 |    1 |
|  2 | JOHN     | 123                              |  24 |    1 |
|  3 | MAX      | 223                              |  24 |    1 |
|  4 | JOHN     | 123                              |  22 |    1 |
|  5 | JOHN     | 123                              |  18 |    1 |
|  8 | lINJIE   | 520                              |  25 |    1 |
|  9 | ZHANG    | 7f6ffaa6bb0b408017b62254211691b5 |  24 |    1 |
+----+----------+----------------------------------+-----+------+
7 rows in set (0.00 sec)
</code></pre>
<pre><code>mysql&gt; SHOW CREATE TABLE users4;
| users4 | CREATE TABLE `users4` (
  `id` smallint(5) unsigned NOT NULL AUTO_INCREMENT,
  `username` varchar(20) NOT NULL,
  `passwd` varchar(32) NOT NULL,
  `age` tinyint(3) unsigned NOT NULL DEFAULT '18',
  `sex` tinyint(1) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=10 DEFAULT CHARSET=utf8 |
</code></pre>
<ul>
<li>可以使用子查询的插入语句 INSERT SET(只能插入一条记录)：</li>
</ul>
<pre><code>```
mysql&gt; INSERT users4 SET username='wutian',passwd=md5('abc');
mysql&gt; SELECT * FROM users4;
+----+----------+----------------------------------+-----+------+
| id | username | passwd                           | age | sex  |
+----+----------+----------------------------------+-----+------+
|  1 | JOHN     | 123                              |  24 |    1 |
|  2 | JOHN     | 123                              |  24 |    1 |
|  3 | MAX      | 223                              |  24 |    1 |
|  4 | JOHN     | 123                              |  22 |    1 |
|  5 | JOHN     | 123                              |  18 |    1 |
|  8 | lINJIE   | 520                              |  25 |    1 |
|  9 | ZHANG    | 7f6ffaa6bb0b408017b62254211691b5 |  24 |    1 |
| 10 | wutian   | 900150983cd24fb0d6963f7d28e17f72 |  18 | NULL |
+----+----------+----------------------------------+-----+------+
```

- 单表更新：

```
mysql&gt; UPDATE users4 SET age = age -5,sex = 0;
mysql&gt; SELECT * FROM users4;
+----+----------+----------------------------------+-----+------+
| id | username | passwd                           | age | sex  |
+----+----------+----------------------------------+-----+------+
|  1 | JOHN     | 123                              |  24 |    0 |
|  2 | JOHN     | 123                              |  24 |    0 |
|  3 | MAX      | 223                              |  24 |    0 |
|  4 | JOHN     | 123                              |  22 |    0 |
|  5 | JOHN     | 123                              |  18 |    0 |
|  8 | lINJIE   | 520                              |  25 |    0 |
|  9 | ZHANG    | 7f6ffaa6bb0b408017b62254211691b5 |  24 |    0 |
| 10 | wutian   | 900150983cd24fb0d6963f7d28e17f72 |  18 |    0 |
+----+----------+----------------------------------+-----+------+
8 rows in set (0.00 sec)

mysql&gt; UPDATE users4 SET age = age +3 WHERE id %2 = 0;
Query OK, 4 rows affected (0.06 sec)
Rows matched: 4  Changed: 4  Warnings: 0

mysql&gt; SELECT * FROM users4;
+----+----------+----------------------------------+-----+------+
| id | username | passwd                           | age | sex  |
+----+----------+----------------------------------+-----+------+
|  1 | JOHN     | 123                              |  24 |    0 |
|  2 | JOHN     | 123                              |  27 |    0 |
|  3 | MAX      | 223                              |  24 |    0 |
|  4 | JOHN     | 123                              |  25 |    0 |
|  5 | JOHN     | 123                              |  18 |    0 |
|  8 | lINJIE   | 520                              |  28 |    0 |
|  9 | ZHANG    | 7f6ffaa6bb0b408017b62254211691b5 |  24 |    0 |
| 10 | wutian   | 900150983cd24fb0d6963f7d28e17f72 |  21 |    0 |
+----+----------+----------------------------------+-----+------+
8 rows in set (0.00 sec)
```
</code></pre>
<hr />
<h4><a class="header" href="#删除记录delete" id="删除记录delete">删除记录DELETE:</a></h4>
<pre><code>- 单表删除

```
mysql&gt;DELETE FROM users4 WHERE id = 6;
Query OK, 0 rows affected (0.00 sec)

mysql&gt; SELECT * FROM users4;
+----+----------+----------------------------------+-----+------+
| id | username | passwd                           | age | sex  |
+----+----------+----------------------------------+-----+------+
|  1 | JOHN     | 123                              |  24 |    0 |
|  2 | JOHN     | 123                              |  27 |    0 |
|  3 | MAX      | 223                              |  24 |    0 |
|  4 | JOHN     | 123                              |  25 |    0 |
|  5 | JOHN     | 123                              |  18 |    0 |
|  8 | lINJIE   | 520                              |  28 |    0 |
|  9 | ZHANG    | 7f6ffaa6bb0b408017b62254211691b5 |  24 |    0 |
| 10 | wutian   | 900150983cd24fb0d6963f7d28e17f72 |  21 |    0 |
+----+----------+----------------------------------+-----+------+
8 rows in set (0.00 sec)
mysql&gt; INSERT users4 SET username='wutian',passwd=md5('abc');
Query OK, 1 row affected (0.05 sec)

mysql&gt; SELECT * FROM users4;
+----+----------+----------------------------------+-----+------+
| id | username | passwd                           | age | sex  |
+----+----------+----------------------------------+-----+------+
|  1 | JOHN     | 123                              |  24 |    0 |
|  2 | JOHN     | 123                              |  27 |    0 |
|  3 | MAX      | 223                              |  24 |    0 |
|  4 | JOHN     | 123                              |  25 |    0 |
|  5 | JOHN     | 123                              |  18 |    0 |
|  8 | lINJIE   | 520                              |  28 |    0 |
|  9 | ZHANG    | 7f6ffaa6bb0b408017b62254211691b5 |  24 |    0 |
| 10 | wutian   | 900150983cd24fb0d6963f7d28e17f72 |  21 |    0 |
| 11 | wutian   | 900150983cd24fb0d6963f7d28e17f72 |  18 | NULL |
+----+----------+----------------------------------+-----+------+

```
</code></pre>
<hr />
<h4><a class="header" href="#select" id="select">SELECT</a></h4>
<pre><code>- 查询函数

```
mysql&gt; SELECT VERSION();
+------------+
| VERSION()  |
+------------+
| 5.6.21-log |
+------------+
1 row in set (0.00 sec)

mysql&gt; SELECT NOW();
+---------------------+
| NOW()               |
+---------------------+
| 2015-04-06 14:32:49 |
+---------------------+
1 row in set (0.00 sec)
```

```    
mysql&gt; SELECT sex FROM users4 GROUP BY sex;
+------+
| sex  |
+------+
| NULL |
|    0 |
+------+
2 rows in set (0.00 sec)
```

- 分组条件指定：

```
mysql&gt; SELECT id,age FROM users4 GROUP BY id HAVING age &gt; 22;
+----+-----+
| id | age |
+----+-----+
|  1 |  24 |
|  2 |  27 |
|  3 |  24 |
|  4 |  25 |
|  8 |  28 |
|  9 |  24 |
+----+-----+
6 rows in set (0.00 sec)

mysql&gt; SELECT sex FROM users4 GROUP BY id HAVING count(id) &gt;= 3;
Empty set (0.00 sec)

mysql&gt; SELECT sex FROM users4 GROUP BY id HAVING count(id) &gt;= 2;
Empty set (0.00 sec)

mysql&gt; SELECT age FROM users4 GROUP BY id HAVING count(id) &gt;= 2;
Empty set (0.00 sec)
```


- order by排序：

```
mysql&gt; SELECT * FROM users4 ORDER BY id DESC ;
+----+----------+----------------------------------+-----+------+
| id | username | passwd                           | age | sex  |
+----+----------+----------------------------------+-----+------+
| 11 | wutian   | 900150983cd24fb0d6963f7d28e17f72 |  18 | NULL |
| 10 | wutian   | 900150983cd24fb0d6963f7d28e17f72 |  21 |    0 |
|  9 | ZHANG    | 7f6ffaa6bb0b408017b62254211691b5 |  24 |    0 |
|  8 | lINJIE   | 520                              |  28 |    0 |
|  5 | JOHN     | 123                              |  18 |    0 |
|  4 | JOHN     | 123                              |  25 |    0 |
|  3 | MAX      | 223                              |  24 |    0 |
|  2 | JOHN     | 123                              |  27 |    0 |
|  1 | JOHN     | 123                              |  24 |    0 |
+----+----------+----------------------------------+-----+------+
9 rows in set (0.00 sec)

mysql&gt; SELECT * FROM users4 ORDER BY age,id DESC;    # 年龄相同则按照id降序排列
+----+----------+----------------------------------+-----+------+
| id | username | passwd                           | age | sex  |
+----+----------+----------------------------------+-----+------+
| 11 | wutian   | 900150983cd24fb0d6963f7d28e17f72 |  18 | NULL |
|  5 | JOHN     | 123                              |  18 |    0 |
| 10 | wutian   | 900150983cd24fb0d6963f7d28e17f72 |  21 |    0 |
|  9 | ZHANG    | 7f6ffaa6bb0b408017b62254211691b5 |  24 |    0 |
|  3 | MAX      | 223                              |  24 |    0 |
|  1 | JOHN     | 123                              |  24 |    0 |
|  4 | JOHN     | 123                              |  25 |    0 |
|  2 | JOHN     | 123                              |  27 |    0 |
|  8 | lINJIE   | 520                              |  28 |    0 |
+----+----------+----------------------------------+-----+------+
9 rows in set (0.01 sec)
```


- limit 限制

```
mysql&gt; SELECT * FROM users4 ORDER BY age,id DESC LIMIT 2;
+----+----------+----------------------------------+-----+------+
| id | username | passwd                           | age | sex  |
+----+----------+----------------------------------+-----+------+
| 11 | wutian   | 900150983cd24fb0d6963f7d28e17f72 |  18 | NULL |
|  5 | JOHN     | 123                              |  18 |    0 |
+----+----------+----------------------------------+-----+------+
2 rows in set (0.00 sec)

mysql&gt; SELECT * FROM users4 ORDER BY age,id DESC LIMIT 4;
+----+----------+----------------------------------+-----+------+
| id | username | passwd                           | age | sex  |
+----+----------+----------------------------------+-----+------+
| 11 | wutian   | 900150983cd24fb0d6963f7d28e17f72 |  18 | NULL |
|  5 | JOHN     | 123                              |  18 |    0 |
| 10 | wutian   | 900150983cd24fb0d6963f7d28e17f72 |  21 |    0 |
|  9 | ZHANG    | 7f6ffaa6bb0b408017b62254211691b5 |  24 |    0 |
+----+----------+----------------------------------+-----+------+
4 rows in set (0.01 sec)

mysql&gt; SELECT * FROM users4 ORDER BY age,id DESC LIMIT 2,4;        # 从结果集中显示第二条开始，输出四条记录
+----+----------+----------------------------------+-----+------+
| id | username | passwd                           | age | sex  |
+----+----------+----------------------------------+-----+------+
| 10 | wutian   | 900150983cd24fb0d6963f7d28e17f72 |  21 |    0 |
|  9 | ZHANG    | 7f6ffaa6bb0b408017b62254211691b5 |  24 |    0 |
|  3 | MAX      | 223                              |  24 |    0 |
|  1 | JOHN     | 123                              |  24 |    0 |
+----+----------+----------------------------------+-----+------+
```

```
mysql&gt; SELECT * FROM users4 LIMIT 2;
+----+----------+--------+-----+------+
| id | username | passwd | age | sex  |
+----+----------+--------+-----+------+
|  1 | JOHN     | 123    |  24 |    0 |
|  2 | JOHN     | 123    |  27 |    0 |
+----+----------+--------+-----+------+
2 rows in set (0.00 sec)

mysql&gt; SELECT * FROM users4 LIMIT 2,3;        # id为1的记录的是第0 条记录
+----+----------+--------+-----+------+
| id | username | passwd | age | sex  |
+----+----------+--------+-----+------+
|  3 | MAX      | 223    |  24 |    0 |
|  4 | JOHN     | 123    |  25 |    0 |
|  5 | JOHN     | 123    |  18 |    0 |
+----+----------+--------+-----+------+
3 rows in set (0.00 sec)
```

```
mysql&gt; CREATE TABLE test(
    -&gt; id TINYINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
    -&gt; username VARCHAR(20)
    -&gt; );
Query OK, 0 rows affected (0.44 sec)

mysql&gt;INSERT test(username) SELECT username FROM users4 WHERE age &gt;=22;
Query OK, 6 rows affected (0.07 sec)
Records: 6  Duplicates: 0  Warnings: 0

mysql&gt; SELECT * FROM test;
+----+----------+
| id | username |
+----+----------+
|  1 | JOHN     |
|  2 | JOHN     |
|  3 | MAX      |
|  4 | JOHN     |
|  5 | lINJIE   |
|  6 | ZHANG    |
+----+----------+
6 rows in set (0.00 sec)
```

```
mysql&gt; SET NAMES UTF8;        # 设置在终端中显示的编码方式  不影响在数据库中的编码方式
Query OK, 0 rows affected (0.00 sec)

mysql&gt; SELECT * FROM test;
+----+----------+
| id | username |
+----+----------+
|  1 | JOHN     |
|  2 | JOHN     |
|  3 | MAX      |
|  4 | JOHN     |
|  5 | lINJIE   |
|  6 | ZHANG    |
+----+----------+
6 rows in set (0.00 sec)
```

**注意：聚合函数，只有一个返回值**

```
mysql&gt; SELECT AVG (goods_price) FROM tdb_goods;        # 平均值
+-------------------+
| AVG (goods_price) |
+-------------------+
|      5636.3636364 |
+-------------------+
1 row in set (0.00 sec)

mysql&gt; SELECT ROUND(AVG(goods_price),2) FROM tdb_goods;        # 四舍五入
+---------------------------+
| ROUND(AVG(goods_price),2) |
+---------------------------+
|                   5636.36 |
+---------------------------+
1 row in set (0.00 sec)
```

```
mysql&gt; SELECT goods_id,goods_name,goods_price FROM tdb_goods WHERE goods_price &gt; =5636.36; 
+----------+-----------------------------------------+-------------+
| goods_id | goods_name                              | goods_price |
+----------+-----------------------------------------+-------------+
|        3 | G150TH 15.6英寸游戏本                   |    8499.000 |
|        7 | SVP13226SCB 13.3英寸触控超极本          |    7999.000 |
|       13 | iMac ME086CH/A 21.5英寸一体电脑         |    9188.000 |
|       17 | Mac Pro MD878CH/A 专业级台式电脑        |   28888.000 |
|       18 |  HMZ-T3W 头戴显示设备                   |    6999.000 |
|       20 | X3250 M4机架式服务器 2583i14            |    6888.000 |
|       21 |  HMZ-T3W 头戴显示设备                   |    6999.000 |
+----------+-----------------------------------------+-------------+
7 rows in set (0.00 sec)

mysql&gt; SELECT goods_id,goods_name,goods_price FROM tdb_goods WHERE goods_price &gt;
=(SELECT ROUND(AVG(goods_price),2)FROM tdb_goods);            #  子查询
+----------+-----------------------------------------+-------------+
| goods_id | goods_name                              | goods_price |
+----------+-----------------------------------------+-------------+
|        3 | G150TH 15.6英寸游戏本                   |    8499.000 |
|        7 | SVP13226SCB 13.3英寸触控超极本          |    7999.000 |
|       13 | iMac ME086CH/A 21.5英寸一体电脑         |    9188.000 |
|       17 | Mac Pro MD878CH/A 专业级台式电脑        |   28888.000 |
|       18 |  HMZ-T3W 头戴显示设备                   |    6999.000 |
|       20 | X3250 M4机架式服务器 2583i14            |    6888.000 |
|       21 |  HMZ-T3W 头戴显示设备                   |    6999.000 |
+----------+-----------------------------------------+-------------+
7 rows in set (0.04 sec)
```

- 使用外键处理重复的内容，防止表太大

```
mysql&gt; CREATE TABLE IF NOT EXISTS tdb_goods_cates(
    -&gt; cate_id SMALLINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
    -&gt; cate_name CARCHAR(40) NOT NULL
    -&gt; );
ERROR 1064 (42000): You have an error in your SQL syntax; check the manual that
corresponds to your MySQL server version for the right syntax to use near 'CARCH
AR(40) NOT NULL
)' at line 3
mysql&gt; CREATE TABLE IF NOT EXISTS tdb_goods_cates(
    -&gt; cate_id SMALLINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
    -&gt; cate_name VARCHAR(40) NOT NULL
    -&gt; );
Query OK, 0 rows affected (0.58 sec)

mysql&gt; SELECT goods_cate FROM tdb_goods GROUP BY goods_cate;
+---------------------+
| goods_cate          |
+---------------------+
| 台式机              |
| 平板电脑            |
| 服务器/工作站       |
| 游戏本              |
| 笔记本              |
| 笔记本配件          |
| 超级本              |
+---------------------+
7 rows in set (0.00 sec)

mysql&gt; INSERT tdb_goods_cates(cate_name)SELECT goods_cate FROM tdb_goods GROUP  BY goods_cate; 
Query OK, 7 rows affected (0.13 sec)
Records: 7  Duplicates: 0  Warnings: 0

mysql&gt; SELECT * FROM tdb_goods_cate;
ERROR 1146 (42S02): Table 'muke.tdb_goods_cate' doesn't exist
mysql&gt; SELECT * FROM tdb_goods_cates;
+---------+---------------------+
| cate_id | cate_name           |
+---------+---------------------+
|       1 | 台式机              |
|       2 | 平板电脑            |
|       3 | 服务器/工作站       |
|       4 | 游戏本              |
|       5 | 笔记本              |
|       6 | 笔记本配件          |
|       7 | 超级本              |
+---------+---------------------+
```
</code></pre>
<hr />
<h4><a class="header" href="#参照表更新多表更新" id="参照表更新多表更新">参照表更新——多表更新</a></h4>
<pre><code>- 表的连接

```
mysql&gt; UPDATE tdb_goods INNER JOIN tdb_goods_cates ON goods_cate = cate_name SET  goods_cate = cate_id;     # 内连接
Query OK, 22 rows affected (0.07 sec)
Rows matched: 22  Changed: 22  Warnings: 0

mysql&gt; SELECT * FROM tdb_goods\G;
*************************** 1. row ***************************
   goods_id: 1
 goods_name: R510VC 15.6英寸笔记本
 goods_cate: 5
 brand_name: 华硕
goods_price: 3399.000
    is_show: 1
 is_saleoff: 0
*************************** 2. row ***************************
   goods_id: 2
 goods_name: Y400N 14.0英寸笔记本电脑
 goods_cate: 5
 brand_name: 联想
goods_price: 4899.000
    is_show: 1
 is_saleoff: 0
*************************** 3. row ***************************
   goods_id: 3
 goods_name: G150TH 15.6英寸游戏本
 goods_cate: 4
 brand_name: 雷神
goods_price: 8499.000
    is_show: 1
 is_saleoff: 0
*************************** 4. row ***************************
```

- 多表更新一步到位:

```
mysql&gt; SELECT  brand_name FROM tdb_goods GROUP BY brand_name;
+------------+
| brand_name |
+------------+
| IBM        |
| 华硕       |
| 宏碁       |
| 惠普       |
| 戴尔       |
| 索尼       |
| 联想       |
| 苹果       |
| 雷神       |
+------------+

mysql&gt; CREATE TABLE tdb_goods_brands(
    -&gt; brand_id SMALLINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
    -&gt; brand_name VARCHAR(40) NOT NULL
    -&gt; )
    -&gt; SELECT brand_name FROM tdb_goods GROUP BY brand_name;
Query OK, 9 rows affected (0.68 sec)
Records: 9  Duplicates: 0  Warnings: 0

mysql&gt; SELECT * FROM tdb_goods_brands;
+----------+------------+
| brand_id | brand_name |
+----------+------------+
|        1 | IBM        |
|        2 | 华硕       |
|        3 | 宏碁       |
|        4 | 惠普       |
|        5 | 戴尔       |
|        6 | 索尼       |
|        7 | 联想       |
|        8 | 苹果       |
|        9 | 雷神       |
+----------+------------+
9 rows in set (0.00 sec)
```

```
mysql&gt; UPDATE tdb_goods INNER JOIN tdb_goods_brands ON brand_name = brand_name S
ET brand_name = brand_id
    -&gt; ;
ERROR 1052 (23000): Column 'brand_name' in field list is ambiguous    # 同名歧义
mysql&gt; UPDATE tdb_goods AS g INNER JOIN tdb_goods_brands AS b ON g.brand_name =b .brand_name SET g.brand_name = b.brand_id;             #  起别名 
Query OK, 22 rows affected (0.07 sec)
Rows matched: 22  Changed: 22  Warnings: 0

mysql&gt;

其中表结构没有得到修改，尽量的修改   事实外键的使用，而尽量不使用物理外键
mysql&gt; ALTER TABLE tdb_goods
    -&gt; CHANGE goods_cate cate_id SMALLINT UNSIGNED NOT NULL,
    -&gt; CHANGE brand_name brands_id SMALLINT  UNSIGNED NOT NULL;
Query OK, 22 rows affected (0.96 sec)
Records: 22  Duplicates: 0  Warnings: 0

mysql&gt; SELECT * FROM tdb_goods\G;
*************************** 1. row ***************************
   goods_id: 1
 goods_name: R510VC 15.6英寸笔记本
    cate_id: 5
  brands_id: 2
goods_price: 3399.000
    is_show: 1
 is_saleoff: 0
*************************** 2. row ***************************
   goods_id: 2
 goods_name: Y400N 14.0英寸笔记本电脑
    cate_id: 5
  brands_id: 7
goods_price: 4899.000
    is_show: 1
 is_saleoff: 0
*************************** 3. row ***************************

mysql&gt; SELECT goods_id ,goods_name,cate_name,brand_name,goods_price FROM tdb_goo
ds AS g
    -&gt; INNER JOIN tdb_goods_cates AS c ON g.cate_id = c.cate_id
    -&gt; INNER JOIN tdb_goods_brands AS b ON g.brands_id= b.brand_id \G;
*************************** 1. row ***************************
   goods_id: 1
 goods_name: R510VC 15.6英寸笔记本
  cate_name: 笔记本
 brand_name: 华硕
goods_price: 3399.000
*************************** 2. row ***************************
   goods_id: 2
 goods_name: Y400N 14.0英寸笔记本电脑
  cate_name: 笔记本
 brand_name: 联想
goods_price: 4899.000
*************************** 3. row ***************************
   goods_id: 3
 goods_name: G150TH 15.6英寸游戏本
  cate_name: 游戏本
 brand_name: 雷神
goods_price: 8499.000
*************************** 4. row ***************************
   goods_id: 4
 goods_name: X550CC 15.6英寸笔记本
  cate_name: 笔记本
 brand_name: 华硕
goods_price: 2799.000
*************************** 5. row ***************************
   goods_id: 5
 goods_name: X240(20ALA0EYCD) 12.5英寸超极本
  cate_name: 超级本
 brand_name: 联想
goods_price: 4999.000
*************************** 6. row ***************************
```

- 无限分类的数据表设计 （自连接）

```
   CREATE TABLE tdb_goods_types(
     type_id   SMALLINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
     type_name VARCHAR(20) NOT NULL,
     parent_id SMALLINT UNSIGNED NOT NULL DEFAULT 0
  );

  INSERT tdb_goods_types(type_name,parent_id) VALUES('家用电器',DEFAULT);
  INSERT tdb_goods_types(type_name,parent_id) VALUES('电脑、办公',DEFAULT);
  INSERT tdb_goods_types(type_name,parent_id) VALUES('大家电',1);
  INSERT tdb_goods_types(type_name,parent_id) VALUES('生活电器',1);
  INSERT tdb_goods_types(type_name,parent_id) VALUES('平板电视',3);
  INSERT tdb_goods_types(type_name,parent_id) VALUES('空调',3);
  INSERT tdb_goods_types(type_name,parent_id) VALUES('电风扇',4);
  INSERT tdb_goods_types(type_name,parent_id) VALUES('饮水机',4);
  INSERT tdb_goods_types(type_name,parent_id) VALUES('电脑整机',2);
  INSERT tdb_goods_types(type_name,parent_id) VALUES('电脑配件',2);
  INSERT tdb_goods_types(type_name,parent_id) VALUES('笔记本',9);
  INSERT tdb_goods_types(type_name,parent_id) VALUES('超级本',9);
  INSERT tdb_goods_types(type_name,parent_id) VALUES('游戏本',9);
  INSERT tdb_goods_types(type_name,parent_id) VALUES('CPU',10);
  INSERT tdb_goods_types(type_name,parent_id) VALUES('主机',10);

mysql&gt; SELECT * FROM   tdb_goods_types;
+---------+-----------------+-----------+
| type_id | type_name       | parent_id |
+---------+-----------------+-----------+
|       1 | 家用电器        |         0 |
|       2 | 电脑、办公      |         0 |
|       3 | 大家电          |         1 |
|       4 | 生活电器        |         1 |
|       5 | 平板电视        |         3 |
|       6 | 空调            |         3 |
|       7 | 电风扇          |         4 |
|       8 | 饮水机          |         4 |
|       9 | 电脑整机        |         2 |
|      10 | 电脑配件        |         2 |
|      11 | 笔记本          |         9 |
|      12 | 超级本          |         9 |
|      13 | 游戏本          |         9 |
|      14 | CPU             |        10 |
|      15 | 主机            |        10 |
+---------+-----------------+-----------+
15 rows in set (0.00 sec)

mysql&gt;

mysql&gt; SELECT s.type_id,s.type_name,p.type_name FROM tdb_goods_types AS s LEFT JOIN tdb_goods_types AS p ON s.parent_id = p.type_id; 
+---------+-----------------+-----------------+
| type_id | type_name       | type_name       |
+---------+-----------------+-----------------+
|       1 | 家用电器        | NULL            |
|       2 | 电脑、办公      | NULL            |
|       3 | 大家电          | 家用电器        |
|       4 | 生活电器        | 家用电器        |
|       5 | 平板电视        | 大家电          |
|       6 | 空调            | 大家电          |
|       7 | 电风扇          | 生活电器        |
|       8 | 饮水机          | 生活电器        |
|       9 | 电脑整机        | 电脑、办公      |
|      10 | 电脑配件        | 电脑、办公      |
|      11 | 笔记本          | 电脑整机        |
|      12 | 超级本          | 电脑整机        |
|      13 | 游戏本          | 电脑整机        |
|      14 | CPU             | 电脑配件        |
|      15 | 主机            | 电脑配件        |
+---------+-----------------+-----------------+
15 rows in set (0.00 sec)
```

```
mysql&gt; SELECT p.type_id,p.type_name,s.type_name FROM tdb_goods_types p LEFT JOIN
 tdb_goods_types s ON s.parent_id = p.type_id;        # 缺省AS 
+---------+-----------------+--------------+
| type_id | type_name       | type_name    |
+---------+-----------------+--------------+
|       1 | 家用电器        | 大家电       |
|       1 | 家用电器        | 生活电器     |
|       3 | 大家电          | 平板电视     |
|       3 | 大家电          | 空调         |
|       4 | 生活电器        | 电风扇       |
|       4 | 生活电器        | 饮水机       |
|       2 | 电脑、办公      | 电脑整机     |
|       2 | 电脑、办公      | 电脑配件     |
|       9 | 电脑整机        | 笔记本       |
|       9 | 电脑整机        | 超级本       |
|       9 | 电脑整机        | 游戏本       |
|      10 | 电脑配件        | CPU          |
|      10 | 电脑配件        | 主机         |
|       5 | 平板电视        | NULL         |
|       6 | 空调            | NULL         |
|       7 | 电风扇          | NULL         |
|       8 | 饮水机          | NULL         |
|      11 | 笔记本          | NULL         |
|      12 | 超级本          | NULL         |
|      13 | 游戏本          | NULL         |
|      14 | CPU             | NULL         |
|      15 | 主机            | NULL         |
+---------+-----------------+--------------+

```

mysql&gt; SELECT p.type_id,p.type_name,s.type_name FROM tdb_goods_types p LEFT JOIN
 tdb_goods_types s ON s.parent_id = p.type_id GROUP BY p.type_id;
+---------+-----------------+--------------+
| type_id | type_name       | type_name    |
+---------+-----------------+--------------+
|       1 | 家用电器        | 大家电       |
|       2 | 电脑、办公      | 电脑整机     |
|       3 | 大家电          | 平板电视     |
|       4 | 生活电器        | 电风扇       |
|       5 | 平板电视        | NULL         |
|       6 | 空调            | NULL         |
|       7 | 电风扇          | NULL         |
|       8 | 饮水机          | NULL         |
|       9 | 电脑整机        | 笔记本       |
|      10 | 电脑配件        | CPU          |
|      11 | 笔记本          | NULL         |
|      12 | 超级本          | NULL         |
|      13 | 游戏本          | NULL         |
|      14 | CPU             | NULL         |
|      15 | 主机            | NULL         |
+---------+-----------------+--------------+
15 rows in set (0.01 sec)

mysql&gt;
mysql&gt; SELECT p.type_id,p.type_name,count(s.type_name) child_count FROM tdb_good s_types p LEFT JOIN tdb_goods_types s ON s.parent_id = p.type_id GROUP BY p.type _id; 
+---------+-----------------+-------------+
| type_id | type_name       | child_count |
+---------+-----------------+-------------+
|       1 | 家用电器        |           2 |
|       2 | 电脑、办公      |           2 |
|       3 | 大家电          |           2 |
|       4 | 生活电器        |           2 |
|       5 | 平板电视        |           0 |
|       6 | 空调            |           0 |
|       7 | 电风扇          |           0 |
|       8 | 饮水机          |           0 |
|       9 | 电脑整机        |           3 |
|      10 | 电脑配件        |           2 |
|      11 | 笔记本          |           0 |
|      12 | 超级本          |           0 |
|      13 | 游戏本          |           0 |
|      14 | CPU             |           0 |
|      15 | 主机            |           0 |
+---------+-----------------+-------------+
15 rows in set (0.00 sec)
```



- 多表删除

  删除重复记录，保留ID号最小的记录（自身连接）

```
mysql&gt; DELETE t1 FROM tdb_goods AS t1 LEFT JOIN (SELECT goods_id,goods_name FROM
tdb_goods GROUP BY goods_name HAVING count(goods_name)&gt;=2) AS t2 ON t1.goods_nam
e = t2.goods_name WHERE t1.goods_id &gt;t2.goods_id;
Query OK, 2 rows affected (0.12 sec)
```
</code></pre>
<hr />
<h4><a class="header" href="#mysql函数" id="mysql函数">MySQL函数</a></h4>
<pre><code>- 字符函数

```
mysql&gt; SELECT CONCAT('LINJIE','MYSQL');
+--------------------------+
| CONCAT('LINJIE','MYSQL') |
+--------------------------+
| LINJIEMYSQL              |
+--------------------------+
1 row in set (0.01 sec)
```

```
mysql&gt; SELECT CONCAT('LINJIE','-','MYSQL');
+------------------------------+
| CONCAT('LINJIE','-','MYSQL') |
+------------------------------+
| LINJIE-MYSQL                 |
+------------------------------+
```

```
mysql&gt; select * from test;
+----+----------+
| id | username |
+----+----------+
|  1 | JOHN     |
|  2 | JOHN     |
|  3 | MAX      |
|  4 | JOHN     |
|  5 | lINJIE   |
|  6 | ZHANG    |
+----+----------+
```

```
mysql&gt; SELECT CONCAT(id,username) AS FULLNAME FROM TEST;
+----------+
| FULLNAME |
+----------+
| 1JOHN    |
| 2JOHN    |
| 3MAX     |
| 4JOHN    |
| 5lINJIE  |
| 6ZHANG   |
+----------+
```

```
mysql&gt; SELECT CONCAT(id,'-',username) AS FULLNAME FROM TEST;
+----------+
| FULLNAME |
+----------+
| 1-JOHN   |
| 2-JOHN   |
| 3-MAX    |
| 4-JOHN   |
| 5-lINJIE |
| 6-ZHANG  |
+----------+
```

```
mysql&gt; SELECT CONCAT_WS('-','LINJIE','GOOD','FUNCTIONS');
+--------------------------------------------+
| CONCAT_WS('-','LINJIE','GOOD','FUNCTIONS') |
+--------------------------------------------+
| LINJIE-GOOD-FUNCTIONS                      |
+--------------------------------------------+
1 row in set (0.00 sec)
```

```
mysql&gt; SELECT FORMAT(123456.77,2);
+---------------------+
| FORMAT(123456.77,2) |
+---------------------+
| 123,456.77          |
+---------------------+
1 row in set (0.01 sec)
```

```
mysql&gt; SELECT FORMAT(123456.778,2);
+----------------------+
| FORMAT(123456.778,2) |
+----------------------+
| 123,456.78           |
+----------------------+
```

```
mysql&gt;
mysql&gt; SELECT LOWER('MYSQl');
+----------------+
| LOWER('MYSQl') |
+----------------+
| mysql          |
+----------------+
```

```
mysql&gt; SELECT UPPER('Mysql');
+----------------+
| UPPER('Mysql') |
+----------------+
| MYSQL          |
+----------------+
```

```
mysql&gt; SELECT LEFT ('mYSQL',2);
+------------------+
| LEFT ('mYSQL',2) |
+------------------+
| mY               |                    # 取出前面指定个数的字符
+------------------+
```

```    
mysql&gt; SELECT LOWER(LEFT('MYSQL',2));
+------------------------+
| LOWER(LEFT('MYSQL',2)) |
+------------------------+
| my                     |
+------------------------+
```

```
mysql&gt; SELECT LOWER(RIGHT('MYSQL',2));
+-------------------------+
| LOWER(RIGHT('MYSQL',2)) |
+-------------------------+
| ql                      |
+-------------------------+
```

```
mysql&gt; SELECT LENGTH('MYSQL L  ');        # 求字符串长度
+---------------------+
| LENGTH('MYSQL L  ') |
+---------------------+
|                   9 |
+---------------------+
```

```
mysql&gt; SELECT LENGTH('MYSQL L      ');
+-------------------------+
| LENGTH('MYSQL L      ') |
+-------------------------+
|                      13 |
+-------------------------+
```

```
mysql&gt; SELECT LTRIM('  MYSQL LINJIE   ');        # 删除前导空格
+----------------------------+
| LTRIM('  MYSQL LINJIE   ') |
+----------------------------+
| MYSQL LINJIE               |
+----------------------------+
```


```
mysql&gt; SELECT LENGTH( LTRIM('  MYSQL LINJIE   '));      
+-------------------------------------+
| LENGTH( LTRIM('  MYSQL LINJIE   ')) |
+-------------------------------------+
|                                  15 |
+-------------------------------------+
```

```
mysql&gt; SELECT RTRIM('  MYSQL LINJIE   ');
+----------------------------+
| RTRIM('  MYSQL LINJIE   ') |
+----------------------------+
|   MYSQL LINJIE             |
+----------------------------+
```

```
mysql&gt; SELECT LENGTH( RTRIM('  MYSQL LINJIE   '));
+-------------------------------------+
| LENGTH( RTRIM('  MYSQL LINJIE   ')) |
+-------------------------------------+
|                                  14 |
+-------------------------------------+
```

```
mysql&gt; SELECT LENGTH(TRIM('  MYSQL LINJIE   '));
+-----------------------------------+
| LENGTH(TRIM('  MYSQL LINJIE   ')) |
+-----------------------------------+
|                                12 |
+-----------------------------------+
```

```
mysql&gt; SELECT TRIM(LEADING '?' FROM '???MYSQL???');        # 删除前导的？
+--------------------------------------+
| TRIM(LEADING '?' FROM '???MYSQL???') |
+--------------------------------------+
| MYSQL???                             |
+--------------------------------------+
1 row in set (0.00 sec)
```

```
mysql&gt; SELECT TRIM(TRAILING '?' FROM '???MYSQL???');        # 删除后导字符？
+---------------------------------------+
| TRIM(TRAILING '?' FROM '???MYSQL???') |
+---------------------------------------+
| ???MYSQL                              |
+---------------------------------------+
1 row in set (0.00 sec)
```

```
mysql&gt; SELECT TRIM(BOTH '?' FROM '???MYSQL???');        # 删除字符串中的？字符
+-----------------------------------+
| TRIM(BOTH '?' FROM '???MYSQL???') |
+-----------------------------------+
| MYSQL                             |
+-----------------------------------+
1 row in set (0.00 sec)
```

```
mysql&gt; SELECT REPLACE ('???MYS??QL??','?','');
+---------------------------------+
| REPLACE ('???MYS??QL??','?','') |
+---------------------------------+
| MYSQL                           |
+---------------------------------+
```

```
mysql&gt; SELECT REPLACE ('???MYS??QL??','?','!');
+----------------------------------+
| REPLACE ('???MYS??QL??','?','!') |
+----------------------------------+
| !!!MYS!!QL!!                     |
+----------------------------------+
```

```
mysql&gt; SELECT SUBSTRING('MYSQL',1,2);    # 截取字符
+------------------------+
| SUBSTRING('MYSQL',1,2) |
+------------------------+
| MY                     |
+------------------------+
```

```
mysql&gt; SELECT SUBSTRING('MYSQL',3);        # 截取字符从第三位开始到家结束
+----------------------+
| SUBSTRING('MYSQL',3) |
+----------------------+
| SQL                  |
+----------------------+
```

```
mysql&gt; SELECT SUBSTRING('LINJIE',3);
+-----------------------+
| SUBSTRING('LINJIE',3) |
+-----------------------+
| NJIE                  |
+-----------------------+
1 row in set (0.00 sec)
```

```
mysql&gt; SELECT SUBSTRING('LINJIE',-3);    # 倒数三位
+------------------------+
| SUBSTRING('LINJIE',-3) |
+------------------------+
| JIE                    |
+------------------------+
```

```
mysql&gt; SELECT 'MYSQL' LINKE 'M%';
ERROR 1064 (42000): You have an error in your SQL syntax; check the manual that
corresponds to your MySQL server version for the right syntax to use near ''M%''
 at line 1
mysql&gt; SELECT 'MYSQL' LIKE 'M%';
+-------------------+
| 'MYSQL' LIKE 'M%' |
+-------------------+
|                 1 |
+-------------------+
```

```
mysql&gt; SELECT  * FROM test;
+----+----------+
| id | username |
+----+----------+
|  1 | JOHN     |
|  2 | JOHN     |
|  3 | MAX      |
|  4 | JOHN     |
|  5 | lINJIE   |
|  6 | ZHANG    |
+----+----------+
```

```
mysql&gt; INSERT INTO test VALUES(NULL,'TOM%');
Query OK, 1 row affected (0.10 sec)

mysql&gt; SELECT  * FROM test;
+----+----------+
| id | username |
+----+----------+
|  1 | JOHN     |
|  2 | JOHN     |
|  3 | MAX      |
|  4 | JOHN     |
|  5 | lINJIE   |
|  6 | ZHANG    |
|  8 | TOM%     |
+----+----------+
```

```
mysql&gt; SELECT * FROM test WHERE username LIKE '%%%';
+----+----------+
| id | username |
+----+----------+
|  1 | JOHN     |
|  2 | JOHN     |
|  3 | MAX      |
|  4 | JOHN     |
|  5 | lINJIE   |
|  6 | ZHANG    |
|  8 | TOM%     |
+----+----------+
```

```
mysql&gt; SELECT * FROM test WHERE username LIKE '%1%%' ESCAPE 1;        # % 是通配符 忽略数字1 后面的%当做符号%来使用 而不是通配符
+----+----------+
| id | username |
+----+----------+
|  8 | TOM%     |
+----+----------+
1 row in set (0.00 sec)
```
</code></pre>
<hr />
<h4><a class="header" href="#数值运算" id="数值运算">数值运算</a></h4>
<pre><code>```
mysql&gt; SELECT 2+7;
+-----+
| 2+7 |
+-----+
|   9 |
+-----+
1 row in set (0.00 sec)
    
mysql&gt; SELECT CEIL(3.01);    #向上取整
+------------+
| CEIL(3.01) |
+------------+
|          4 |
+------------+
1 row in set (0.00 sec)
    
mysql&gt; SELECT FLOOR(3.01);        # 向下取整
+-------------+
| FLOOR(3.01) |
+-------------+
|           3 |
+-------------+
1 row in set (0.00 sec)

```

```
mysql&gt; SELECT 3 DIV 4;
+---------+
| 3 DIV 4 |
+---------+
|       0 |
+---------+
1 row in set (0.01 sec)

mysql&gt; SELECT 5 DIV 4;
+---------+
| 5 DIV 4 |
+---------+
|       1 |
+---------+
1 row in set (0.00 sec)

mysql&gt; SELECT 5 MOD 4;
+---------+
| 5 MOD 4 |
+---------+
|       1 |
+---------+
1 row in set (0.00 sec)

mysql&gt; SELECT 5 MOD 2.3;
+-----------+
| 5 MOD 2.3 |
+-----------+
|       0.4 |
+-----------+
1 row in set (0.00 sec)

mysql&gt; SELECT POWER(3,3);
+------------+
| POWER(3,3) |
+------------+
|         27 |
+------------+
1 row in set (0.00 sec)

mysql&gt; SELECT ROUND(3.6545,3);
+-----------------+
| ROUND(3.6545,3) |
+-----------------+
|           3.655 |
+-----------------+
1 row in set (0.00 sec)

mysql&gt; SELECT TRUNCATE(3.6545,3);
+--------------------+
| TRUNCATE(3.6545,3) |
+--------------------+
|              3.654 |
+--------------------+
1 row in set (0.00 sec)

mysql&gt;

mysql&gt; SELECT 15 BETWEEN 1 AND 22;
+---------------------+
| 15 BETWEEN 1 AND 22 |
+---------------------+
|                   1 |
+---------------------+
1 row in set (0.01 sec)

mysql&gt; SELECT 35 BETWEEN 1 AND 22;
+---------------------+
| 35 BETWEEN 1 AND 22 |
+---------------------+
|                   0 |
+---------------------+
1 row in set (0.00 sec)

mysql&gt; SELECT 35 NOT BETWEEN 1 AND 22;
+-------------------------+
| 35 NOT BETWEEN 1 AND 22 |
+-------------------------+
|                       1 |
+-------------------------+
1 row in set (0.00 sec)

mysql&gt; SELECT 35 IN(15,25,35);
+-----------------+
| 35 IN(15,25,35) |
+-----------------+
|               1 |
+-----------------+
1 row in set (0.00 sec)

mysql&gt; SELECT 30 IN(15,25,35);
+-----------------+
| 30 IN(15,25,35) |
+-----------------+
|               0 |
+-----------------+
1 row in set (0.00 sec)

mysql&gt; SELECT NULL IS NULL;
+--------------+
| NULL IS NULL |
+--------------+
|            1 |
+--------------+
1 row in set (0.00 sec)

mysql&gt; SELECT NULL IS NOT NULL;
+------------------+
| NULL IS NOT NULL |
+------------------+
|                0 |
+------------------+
1 row in set (0.00 sec)

mysql&gt; SELECT '' IS NOT NULL;
+----------------+
| '' IS NOT NULL |
+----------------+
|              1 |
+----------------+
1 row in set (0.00 sec)

mysql&gt; SELECT '' IS NULL;
+------------+
| '' IS NULL |
+------------+
|          0 |
+------------+
1 row in set (0.00 sec)
```
</code></pre>
<hr />
<h4><a class="header" href="#日期时间函数" id="日期时间函数">日期时间函数</a></h4>
<pre><code>```
mysql&gt; SELECT NOW();
+---------------------+
| NOW()               |
+---------------------+
| 2015-04-06 22:20:33 |
+---------------------+
1 row in set (0.00 sec)

mysql&gt; SELECT CURDATE();
+------------+
| CURDATE()  |
+------------+
| 2015-04-06 |
+------------+
1 row in set (0.00 sec)

mysql&gt; SELECT CURTIME();
+-----------+
| CURTIME() |
+-----------+
| 22:20:53  |
+-----------+
1 row in set (0.00 sec)

mysql&gt; SELECT DATE_ADD('2015-4-6',INTERVAL 365 DAY);
+---------------------------------------+
| DATE_ADD('2015-4-6',INTERVAL 365 DAY) |
+---------------------------------------+
| 2016-04-05                            |
+---------------------------------------+
1 row in set (0.00 sec)

mysql&gt; SELECT DATE_ADD('2015-4-6',INTERVAL -365 DAY);
+----------------------------------------+
| DATE_ADD('2015-4-6',INTERVAL -365 DAY) |
+----------------------------------------+
| 2014-04-06                             |
+----------------------------------------+
1 row in set (0.00 sec)

mysql&gt; SELECT DATE_ADD('2015-4-6',INTERVAL 1 YEAR);
+--------------------------------------+
| DATE_ADD('2015-4-6',INTERVAL 1 YEAR) |
+--------------------------------------+
| 2016-04-06                           |
+--------------------------------------+
1 row in set (0.00 sec)

mysql&gt; SELECT DATE_ADD('2015-4-6',INTERVAL 1 WEEK);        # 添加一个星期
+--------------------------------------+
| DATE_ADD('2015-4-6',INTERVAL 1 WEEK) |
+--------------------------------------+
| 2015-04-13                           |
+--------------------------------------+
1 row in set (0.00 sec)

mysql&gt; SELECT DATE_ADD('2015-4-6',INTERVAL 1 WEEK);
+--------------------------------------+
| DATE_ADD('2015-4-6',INTERVAL 1 WEEK) |
+--------------------------------------+
| 2015-04-13                           |
+--------------------------------------+
1 row in set (0.00 sec)

mysql&gt; SELECT DATEDIFF('2014-1-1','2015-2-2');
+---------------------------------+
| DATEDIFF('2014-1-1','2015-2-2') |
+---------------------------------+
|                            -397 |
+---------------------------------+
1 row in set (0.00 sec)


mysql&gt; SELECT DATE_FORMAT('2015-4-6','%M/%D/%Y');
+------------------------------------+
| DATE_FORMAT('2015-4-6','%M/%D/%Y') |
+------------------------------------+
| April/6th/2015                     |
+------------------------------------+
1 row in set (0.01 sec)
```
</code></pre>
<hr />
<h4><a class="header" href="#信息函数" id="信息函数">信息函数</a></h4>
<pre><code>```
mysql&gt; SELECT CONNECTION_ID();
+-----------------+
| CONNECTION_ID() |
+-----------------+
|               3 |
+-----------------+
1 row in set (0.00 sec)

mysql&gt; SELECT DATABASE();
+------------+
| DATABASE() |
+------------+
| muke       |
+------------+
1 row in set (0.01 sec)

mysql&gt; SELECT USER();
+----------------+
| USER()         |
+----------------+
| root@localhost |
+----------------+
1 row in set (0.00 sec)

mysql&gt; SELECT VERSION();
+------------+
| VERSION()  |
+------------+
| 5.6.21-log |
+------------+
1 row in set (0.00 sec)
```

```
mysql&gt; SELECT MD5('123');
+----------------------------------+
| MD5('123')                       |
+----------------------------------+
| 202cb962ac59075b964b07152d234b70 |
+----------------------------------+
1 row in set (0.00 sec)

mysql&gt; SELECT PASSWORD('123');
+-------------------------------------------+
| PASSWORD('123')                           |
+-------------------------------------------+
| *23AE809DDACAF96AF0FD78ED04B6A265E05AA257 |
+-------------------------------------------+
1 row in set (0.00 sec)

mysql&gt; SET PASSWORD = PASSWORD('linjie520');        # 修改当前用户的密码
Query OK, 0 rows affected (0.16 sec)
```
</code></pre>
<hr />
<h4><a class="header" href="#mysql自定义函数" id="mysql自定义函数">MySQL自定义函数</a></h4>
<pre><code>mysql&gt; CREATE FUNCTION f1() RETURNS VARCHAR(30)        # 定义函数
    -&gt; RETURN DATE_FORMAT(NOW(),'%Y年%m月%d日 %h点：%i分：%s秒')
    -&gt; ;
Query OK, 0 rows affected (0.01 sec)

mysql&gt; SELECT f1();        # 调用函数
+---------------------------------+
| f1()                            |
+---------------------------------+
| 2015年04月06日 10点：57分：10秒 |
+---------------------------------+
1 row in set (0.04 sec)
</code></pre>
<pre><code>mysql&gt; CREATE FUNCTION f2(num1 SMALLINT UNSIGNED,num2 SMALLINT UNSIGNED)
    -&gt; RETURNS FLOAT(10,2) UNSIGNED
    -&gt; RETURN (num1+num2)/2;
Query OK, 0 rows affected (0.00 sec)

mysql&gt; SELECT f2(10,69);
+-----------+
| f2(10,69) |
+-----------+
|     39.50 |
+-----------+
1 row in set (0.00 sec)
</code></pre>
<pre><code>mysql&gt; DELIMITER //        # 定义语句结束符 避免在写函数的时候的分号冲突
mysql&gt;
mysql&gt; CREATE FUNCTION adduser(username VARCHAR(20))
    -&gt; RETURNS INT UNSIGNED
    -&gt; BEGIN
    -&gt; INSERT test (username) VALUES(username);
    -&gt; RETURN LAST_INSERT_ID();
    -&gt; END        # 和 BEGIN 构成聚合体
    -&gt; //
Query OK, 0 rows affected (0.00 sec)

mysql&gt; SELECT adduser('bubu');
    -&gt; //
+-----------------+
| adduser('bubu') |
+-----------------+
|               9 |
+-----------------+
1 row in set (0.06 sec)
</code></pre>
<pre><code>mysql&gt; select * from test//
+----+----------+
| id | username |
+----+----------+
|  1 | JOHN     |
|  2 | JOHN     |
|  3 | MAX      |
|  4 | JOHN     |
|  5 | lINJIE   |
|  6 | ZHANG    |
|  8 | TOM%     |
|  9 | bubu     |
+----+----------+
8 rows in set (0.00 sec)

mysql&gt; DROP FUNCTION adduser; //    # 删除自定义函数
</code></pre>
<hr />
<h4><a class="header" href="#存储过程" id="存储过程">存储过程</a></h4>
<ul>
<li>
<p>默认当前用户创建存储过程（过程体）</p>
</li>
<li>
<p>增删改查，多表连接操作的存储过程！！！</p>
</li>
</ul>
<pre><code>root@localhost muke&gt;CREATE PROCEDURE sp1() SELECT VERSION();
Query OK, 0 rows affected (0.10 sec)

root@localhost muke&gt;CALL sp1;
+------------+
| VERSION()  |
+------------+
| 5.6.21-log |
+------------+
1 row in set (0.00 sec)

Query OK, 0 rows affected (0.01 sec)
</code></pre>
<pre><code>root@localhost muke&gt;CALL sp1();
+------------+
| VERSION()  |
+------------+
| 5.6.21-log |
+------------+
1 row in set (0.00 sec)

Query OK, 0 rows affected (0.01 sec)

root@localhost muke&gt;DELIMITER //

root@localhost muke&gt;CREATE PROCEDURE removeGoodsId(IN id INT UNSIGNED)
    -&gt; BEGIN
    -&gt; DELETE FROM tdb_goods WHERE id = id;        # 这里的参数和表字段同名 导致删除的时候所有的表内容都删除了
    -&gt; END
    -&gt; //
Query OK, 0 rows affected (0.00 sec)                              注意： 这里的IN id要修改为其他形参，再修改 WHERE id = 形参
</code></pre>
<pre><code>root@localhost muke&gt;DELIMITER ;
root@localhost muke&gt;CALL removeGoodsId(3);
Query OK, 20 rows affected (0.07 sec)

root@localhost muke&gt;SELECT * FROM tdb_goods;
Empty set (0.00 sec)

</code></pre>
<ul>
<li>存储过程书写错误的时候要删除后重建！！！</li>
</ul>
<pre><code>root@localhost muke&gt;DROP PROCEDURE removeGoodsId;
Query OK, 0 rows affected (0.00 sec)    
root@localhost muke&gt;DELIMITER //
root@localhost muke&gt;CREATE PROCEDURE removeUserAndReturnUserNums(IN P_ID INT UNSIGNED,OUT userNums INT UNSIGNED)
    -&gt; BEGIN
    -&gt; DELETE FROM users WHERE id = p_id;
    -&gt; SELECT count(id) FROM users INTO userNums;        #  局部变量声明
    -&gt; END
    -&gt; //
Query OK, 0 rows affected (0.00 sec)

root@localhost muke&gt;DELIMITER ;
root@localhost muke&gt;CALL removeUserAndReturnUserNums(4,@nums);
Query OK, 1 row affected (0.06 sec)

root@localhost muke&gt;SELECT * FROM users;
+----+----------+------+
| id | username | pid  |
+----+----------+------+
|  3 | LINJIE   | NULL |
|  5 | lin      | NULL |
|  6 | uunh     | NULL |
|  7 | MAX      | NULL |
+----+----------+------+
4 rows in set (0.00 sec)

root@localhost muke&gt;SELECT @nums ;        #  
+-------+
| @nums |
+-------+
|     4 |
+-------+
1 row in set (0.00 sec)
</code></pre>
<pre><code>root@localhost muke&gt;SELECT ROW_COUNT();        # 得到插入、删除、更新、被影响的行数
+-------------+
| ROW_COUNT() |
+-------------+
|          -1 |
+-------------+
1 row in set (0.00 sec)
</code></pre>
<p><strong>存储过程会很复杂用来对表进行操作，函数的针对性更强些而很少用函数对表操作。</strong></p>
<hr />
<h4><a class="header" href="#mysql锁策略" id="mysql锁策略">MySQL锁策略：</a></h4>
<pre><code>```
mysql&gt; CREATE TABLE tb5(
    -&gt; s1 VARCHAR(10)
    -&gt; ) ENGINE = MyISAM;	# setting enging
Query OK, 0 rows affected (0.10 sec)

mysql&gt; SHOW CREATE TABLE tb5;
| tb5   | CREATE TABLE `tb5` (
  `s1` varchar(10) DEFAULT NULL
) ENGINE=MyISAM DEFAULT CHARSET=utf8 |

mysql&gt; ALTER TABLE tb5 ENGINE =InnoDB;
Query OK, 0 rows affected (0.52 sec)
Records: 0  Duplicates: 0  Warnings: 0

mysql&gt; SHOW CREATE TABLE tb5;
| tb5   | CREATE TABLE `tb5` (
  `s1` varchar(10) DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8 |

str_to_date(&quot;2015-05-06&quot;, &quot;%y-%m-%d&quot;)  日期处理
```

```
UPDATE supply_chain_stats_daily SET return_num=0
WHERE   created BETWEEN '2015-09-17' AND '2015-09-19';

Error Code: 1175. You are using safe update mode and you tried to
 update a table without a WHERE that uses a KEY column To disable safe mode, 
 toggle the option in Preferences -&gt; SQL Editor and reconnect.
将 SET SQL_SAFE_UPDATES = 1;  # 当前会话有效
设置为： SET SQL_SAFE_UPDATES = 0;
再使用更新语句。
```
</code></pre>
<hr />
<h2>layout: post
title: MYSQL数据性能优化 
date: 2015-06-27
category: database
tag: mysql</h2>
<p><strong>摘要:</strong>
mysql数据库性能优化小记,介绍了一些MySQL性能优化方法和优化途径用到的工具.例如常见
慢查询等问题.</p>
<p>安装演示数据库：
http://dev.mysql.com/doc/index-other.html</p>
<pre><code>D:\sakila-db&gt;cd sakila-db

D:\sakila-db\sakila-db&gt;DIR
 驱动器 D 中的卷没有标签。
 卷的序列号是 DEED-CA78

D:\sakila-db\sakila-db 的目录

2015/04/07  11:14    &lt;DIR&gt;          .
2015/04/07  11:14    &lt;DIR&gt;          ..
2014/11/18  17:05         3,231,472 sakila-data.sql
2014/11/18  17:05            23,145 sakila-schema.sql
2014/11/18  17:05            50,019 sakila.mwb
               3 个文件      3,304,636 字节
               2 个目录 38,402,310,144 可用字节

D:\sakila-db\sakila-db&gt;mysql -uroot -p &lt;sakila-schema.sql
Enter password: *********

D:\sakila-db\sakila-db&gt;mysql -uroot -p &lt;sakila-data.sql
Enter password: *********
ERROR at line 153: Unknown command '\&quot;'.        # 这里出现错误但是可以使用

D:\sakila-db\sakila-db&gt;
</code></pre>
<pre><code>mysql&gt; use sakila;
Database changed
mysql&gt; show tables;
+----------------------------+
| Tables_in_sakila           |
+----------------------------+
| actor                      |
| actor_info                 |
| address                    |
| category                   |
| city                       |
</code></pre>
<pre><code>mysql&gt; SHOW VARIABLES LIKE 'slow_query_log';        # 查看慢查询日志是否打开
+----------------+-------+
| Variable_name  | Value |
+----------------+-------+
| slow_query_log | ON    |
+----------------+-------+
1 row in set (0.00 sec)
</code></pre>
<pre><code>mysql&gt; SHOW VARIABLES LIKE '%log';            # % 是通配符
+--------------------------------+-------+
| Variable_name                  | Value |
+--------------------------------+-------+
| back_log                       | 80    |
| general_log                    | OFF   |
| innodb_api_enable_binlog       | OFF   |
| innodb_locks_unsafe_for_binlog | OFF   |
| relay_log                      |       |
| slow_query_log                 | ON    |
| sync_binlog                    | 0     |
| sync_relay_log                 | 10000 |
+--------------------------------+-------+
8 rows in set (0.00 sec)
</code></pre>
<pre><code>mysql&gt; SET global log_queries_not_using_indexes = ON;
Query OK, 0 rows affected (0.00 sec)
mysql&gt; SET GLOBAL slow_query_log = ON;        # 打开慢查询日志功能
Query OK, 0 rows affected (0.00 sec)

mysql&gt; SHOW variables LIKE 'slow%';        # 可以看到慢查询日志的位置
+---------------------+--------------------+
| Variable_name       | Value              |
+---------------------+--------------------+
| slow_launch_time    | 2                  |
| slow_query_log      | ON                 |
| slow_query_log_file | LINJIE-PC-slow.log |        #  win7 中在 C:\ProgramData\MySQL\MySQL Server 5.6\data 文件夹中
+---------------------+--------------------+
3 rows in set (0.00 sec)

</code></pre>
<p>分解查看慢查询日志，使用日志分析工具，生成分析报表：</p>
<p>1、mysqldumpslow  MySQL自带的分析工具</p>
<pre><code>linjie:~$ mysqldumpslow
Can't find '/var/lib/mysql/*-slow.log'
linjie:~$ 
linjie:~$ 
linjie:~$ mysql -u root -p
Enter password: 
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 39
Server version: 5.5.40-0ubuntu0.14.04.1 (Ubuntu)

Copyright (c) 2000, 2014, Oracle and/or its affiliates. All rights reserved.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

</code></pre>
<pre><code>mysql&gt; SET GLOBAL log_queries_not_using_indexes=on;
Query OK, 0 rows affected (0.00 sec)

mysql&gt; set global long_query_time=0.01;    # 设置慢查询时间为0.01秒
Query OK, 0 rows affected (0.00 sec)

mysql&gt; SHOW VARIABLES LIKE 'SLOW_QUERY_LOG';
+----------------+-------+
| Variable_name  | Value |
+----------------+-------+
| slow_query_log | OFF   |
+----------------+-------+
1 row in set (0.00 sec)

mysql&gt; SHOW VARIABLES LIKE 'log%';
+---------------------------------+--------------------------+
| Variable_name                   | Value                    |
+---------------------------------+--------------------------+
| log                             | OFF                      |
| log_bin                         | OFF                      |
| log_bin_trust_function_creators | OFF                      |
| log_error                       | /var/log/mysql/error.log |
| log_output                      | FILE                     |
| log_queries_not_using_indexes   | ON                       |
| log_slave_updates               | OFF                      |
| log_slow_queries                | OFF                      |
| log_warnings                    | 1                        |
+---------------------------------+--------------------------+
9 rows in set (0.00 sec)
</code></pre>
<pre><code>mysql&gt; SET GLOBAL slow_query_log=ON;
Query OK, 0 rows affected (0.00 sec)

mysql&gt; USE SAKILA;
ERROR 1049 (42000): Unknown database 'SAKILA'        # 从官网下载sakila 数据库并安装
mysql&gt; 
linjie:sakila-db$ ls
sakila-data.sql  sakila.mwb  sakila-schema.sql
linjie:sakila-db$ 
linjie:sakila-db$ mysql -uroot -p &lt;sakila-schema.sql        # 安装导入数据库
Enter password: 
linjie:sakila-db$ mysql -uroot -p &lt;sakila-data.sql
Enter password: 
linjie:sakila-db$ 
mysql&gt; SHOW VARIABLES LIKE 'slow%';
+---------------------+------------------------------+
| Variable_name       | Value                        |
+---------------------+------------------------------+
| slow_launch_time    | 2                            |
| slow_query_log      | ON                           |
| slow_query_log_file | /var/lib/mysql/Host-slow.log |
+---------------------+------------------------------+
3 rows in set (0.00 sec)

</code></pre>
<p>root用户下查看慢查日志:</p>
<pre><code>root:sakila-db# tail /var/lib/mysql/Host-slow.log
COMMIT;
# User@Host: root[root] @ localhost []
# Query_time: 0.044031  Lock_time: 0.000000 Rows_sent: 0  Rows_examined: 0
SET timestamp=1428388803;
COMMIT;
# Time: 150407 14:43:21
# User@Host: root[root] @ localhost []
# Query_time: 0.001194  Lock_time: 0.000096 Rows_sent: 200  Rows_examined: 200
SET timestamp=1428389001;
select * from actor;
</code></pre>
<p>使用mysqldumpslow工具来分析慢查日志(内容比较多可以用help来查看使用情况):</p>
<pre><code>root:sakila-db# mysqldumpslow -t 3  /var/lib/mysql/Host-slow.log
Count: 1  Time=0.37s (0s)  Lock=0.00s (0s)  Rows=0.0 (0), root[root]@localhost
  CREATE TABLE film_category (
  film_id SMALLINT UNSIGNED NOT NULL,
  category_id TINYINT UNSIGNED NOT NULL,
  last_update TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (film_id, category_id),
  CONSTRAINT fk_film_category_film FOREIGN KEY (film_id) REFERENCES film (film_id) ON DELETE RESTRICT ON UPDATE CASCADE,
  CONSTRAINT fk_film_category_category FOREIGN KEY (category_id) REFERENCES category (category_id) ON DELETE RESTRICT ON UPDATE CASCADE
  )ENGINE=InnoDB DEFAULT CHARSET=utf8

</code></pre>
<p>在本机中安装apt-get install percona-toolkit才可以使用日志分析工具 pt-query-digest</p>
<pre><code>root:linjie# pt-query-digest --help

pt-query-digest analyzes MySQL queries from slow, general, and binary log files.
It can also analyze queries from C&lt;SHOW PROCESSLIST&gt; and MySQL protocol data
from tcpdump.  By default, queries are grouped by fingerprint and reported in
descending order of query time (i.e. the slowest queries first).  If no C&lt;FILES&gt;
are given, the tool reads C&lt;STDIN&gt;.  The optional C&lt;DSN&gt; is used for certain
options like L&lt;&quot;--since&quot;&gt; and L&lt;&quot;--until&quot;&gt;.  For more details, please use the
--help option, or try 'perldoc /usr/bin/pt-query-digest' for complete
documentation.

Usage: pt-query-digest [OPTIONS] [FILES] [DSN]



root:linjie# pt-query-digest  /var/lib/mysql/Host-slow.log |more

# 400ms user time, 30ms system time, 42.91M rss, 120.62M vsz
# Current date: Tue Apr  7 15:21:41 2015
# Hostname: Host
# Files: /var/lib/mysql/Host-slow.log
# Overall: 54 total, 38 unique, 0.25 QPS, 0.03x concurrency ______________
# Time range: 2015-04-07 14:39:44 to 14:43:21
# Attribute          total     min     max     avg     95%  stddev  median
# ============     ======= ======= ======= ======= ======= ======= =======
# Exec time             6s     1ms   602ms   116ms   356ms   108ms    87ms
# Lock time          193ms       0    62ms     4ms    16ms    11ms   176us
# Rows sent            200       0     200    3.70       0   25.99       0
# Rows examine         200       0     200    3.70       0   25.99       0
# Query size         2.94M       6 1010.88k  55.72k 201.74k 191.11k  381.65

# Profile
# Rank Query ID           Response time Calls R/Call V/M   Item
# ==== ================== ============= ===== ====== ===== ===============
#    1 0x813031B8BBC3B329  1.2162 19.4%    15 0.0811  0.02 COMMIT
#    2 0xAAFA9D65F37A50E9  0.6257 10.0%     2 0.3128  0.53 INSERT payment
#    3 0xCE1717EC0EDB34A8  0.6051  9.6%     2 0.3026  0.30 INSERT rental
#    4 0xC6A10D5F70E55E2C  0.3678  5.9%     1 0.3678  0.00 CREATE TABLE film_category
#    5 0xFB9930A2CD51E3C4  0.3576  5.7%     1 0.3576  0.00 CREATE TABLE payment
#    6 0x8E4B59B60224A873  0.2123  3.4%     1 0.2123  0.00 CREATE TABLE rental
#    7 0x050C06EA5B5F0A58  0.1909  3.0%     1 0.1909  0.00 INSERT film
#    8 0x0F9C0958963F7FEA  0.1620  2.6%     1 0.1620  0.00 CREATE
#    9 0x704EAFDC6327E6B1  0.1565  2.5%     1 0.1565  0.00 CREATE TABLE staff
#   10 0x7D20F7BC91FA7E09  0.1460  2.3%     1 0.1460  0.00 CREATE
#   11 0x81111B833A29E7E3  0.1454  2.3%     1 0.1454  0.00 CREATE TABLE store
#   12 0x76C2D86A2D27DBE3  0.1344  2.1%     1 0.1344  0.00 CREATE TABLE inventory
#   13 0xDAA404BCF84B6C07  0.1343  2.1%     1 0.1343  0.00 CREATE TABLE film_actor
#   14 0xAA5D67D984519B70  0.1343  2.1%     1 0.1343  0.00 CREATE TABLE film
#   15 0xB81F6955580E244D  0.1343  2.1%     1 0.1343  0.00 CREATE TABLE customer
#   16 0xBF45E32AC4D50022  0.1299  2.1%     1 0.1299  0.00 CREATE TABLE actor
#   17 0x72602773861010BD  0.1025  1.6%     1 0.1025  0.00 CREATE
#   18 0x4C260A99CACE5593  0.1023  1.6%     1 0.1023  0.00 CREATE TABLE address
#   19 0x870A04CA5A67718A  0.1013  1.6%     1 0.1013  0.00 CREATE
#   20 0xC6ED2671EA8DCAE5  0.1007  1.6%     1 0.1007  0.00 CREATE TABLE category
# MISC 0xMISC              1.0186 16.2%    18 0.0566   0.0 &lt;18 ITEMS&gt;

# Query 1: 5 QPS, 0.41x concurrency, ID 0x813031B8BBC3B329 at byte 3088922
# This item is included in the report because it matches --limit.
# Scores: V/M = 0.02
# Time range: 2015-04-07 14:40:00 to 14:40:03
# Attribute    pct   total     min     max     avg     95%  stddev  median
# ============ === ======= ======= ======= ======= ======= ======= =======
# Count         27      15
# Exec time     19      1s    44ms   175ms    81ms   148ms    40ms    63ms
# Lock time      0       0       0       0       0       0       0       0
# Rows sent      0       0       0       0       0       0       0       0
# Rows examine   0       0       0       0       0       0       0       0
# Query size     0      90       6       6       6       6       0       6
# String:
# Databases    sakila
# Hosts        localhost
# Users        root
# Query_time distribution
#   1us
#  10us
# 100us
#   1ms
#  10ms  ################################################################
# 100ms  #######################
#    1s
#  10s+
COMMIT\G

# Query 2: 0 QPS, 0x concurrency, ID 0xAAFA9D65F37A50E9 at byte 630229 ___
# This item is included in the report because it matches --limit.
# Scores: V/M = 0.53
# Time range: all events occurred at 2015-04-07 14:40:01
# Attribute    pct   total     min     max     avg     95%  stddev  median
# ============ === ======= ======= ======= ======= ======= ======= =======
# Count          3       2
--More--

</code></pre>
<p>count() 和max()的优化方法:	</p>
<pre><code>mysql&gt; EXPLAIN SELECT MAX(payment_date) FROM payment\G;	#利用EXPLAIN 关键字列出其后语句执行计划
*************************** 1. row ***************************
           id: 1
  select_type: SIMPLE	# 表示是一个简单的select语句
        table: payment	# payment表
         type: ALL	# 全表扫描
possible_keys: NULL
          key: NULL
      key_len: NULL
          ref: NULL
         rows: 16371	# 扫描16371行,比较多
        Extra: 
1 row in set (0.00 sec)

ERROR: 
No query specified

</code></pre>
<p>通常的优化方案是建立索引:</p>
<pre><code>mysql&gt; CREATE INDEX idx_paydate ON payment(payment_date);
Query OK, 0 rows affected (0.28 sec)
Records: 0  Duplicates: 0  Warnings: 0

</code></pre>
<p>再次查看执行计划:</p>
<pre><code>mysql&gt; EXPLAIN SELECT MAX(payment_date) FROM payment\G;
*************************** 1. row ***************************
           id: 1
  select_type: SIMPLE
        table: NULL
         type: NULL
possible_keys: NULL
          key: NULL
      key_len: NULL
          ref: NULL
         rows: NULL
        Extra: Select tables optimized away
1 row in set (0.00 sec)

ERROR: 
No query specified

mysql&gt; 

mysql&gt; CREATE TABLE t (
    -&gt; pid INT
    -&gt; );
Query OK, 0 rows affected (0.15 sec)

mysql&gt; 
mysql&gt; INSERT t VALUES(1);
Query OK, 1 row affected (0.14 sec)

mysql&gt; 
mysql&gt; CREATE TABLE t1 ( pid INT );
Query OK, 0 rows affected (0.10 sec)

mysql&gt; INSERT t1 VALUES(1);
Query OK, 1 row affected (0.08 sec)

</code></pre>
<pre><code>mysql&gt; SELECT * FROM t WHERE t.pid IN (SELECT t1.pid FROM t1);	# 子查询
+------+
| pid  |
+------+
|    1 |
+------+
1 row in set (0.01 sec)

mysql&gt; SELECT t.pid FROM t JOIN t1 ON t.pid = t1.pid;	# 利用链接来优化子查询
+------+
| pid  |
+------+
|    1 |
+------+
1 row in set (0.00 sec)

mysql&gt; INSERT t1 VALUES(1);
Query OK, 1 row affected (0.07 sec)

mysql&gt; SELECT * FROM t WHERE t.pid IN (SELECT t1.pid FROM t1);	# 子查询
+------+
| pid  |
+------+
|    1 |
+------+
1 row in set (0.00 sec)

mysql&gt; SELECT t.pid FROM t JOIN t1 ON t.pid = t1.pid;	# 链接方式优化子查询查询  注意这里如果有一对多的情况 会有多个值
+------+
| pid  |
+------+
|    1 |
|    1 |
+------+
2 rows in set (0.00 sec)

mysql&gt; SELECT DISTINCT t.pid FROM t JOIN t1 ON t.pid = t1.pid;	# 可以利用DISTINCT去掉重复
+------+
| pid  |
+------+
|    1 |
+------+
1 row in set (0.00 sec)

mysql&gt; 

mysql&gt; EXPLAIN SELECT actor.first_name,actor.last_name,COUNT(*) FROM sakila.film_actor INNER JOIN sakila.actor USING(actor_id) GROUP BY film_actor.actor_id \G;
*************************** 1. row ***************************
           id: 1
  select_type: SIMPLE
        table: actor
         type: ALL	# 使用了表扫描操作
possible_keys: PRIMARY
          key: NULL
      key_len: NULL
          ref: NULL
         rows: 200
        Extra: Using temporary; Using filesort	# 使用了临时表操作
*************************** 2. row ***************************
           id: 1
  select_type: SIMPLE
        table: film_actor
         type: ref
possible_keys: PRIMARY
          key: PRIMARY
      key_len: 2
          ref: sakila.actor.actor_id
         rows: 1
        Extra: Using index
2 rows in set (0.00 sec)

ERROR: 
No query specified

</code></pre>
<p>为了优化表扫描和使用临时表的操作:</p>
<pre><code>mysql&gt; EXPLAIN SELECT actor.first_name,actor.last_name,c.cnt FROM sakila.actor INNER JOIN (SELECT actor_id,COUNT(*) AS cnt FROM sakila.film_actor GROUP BY actor_id) AS c USING(actor_id)\G;
*************************** 1. row ***************************
           id: 1
  select_type: PRIMARY
        table: &lt;derived2&gt;
         type: ALL
possible_keys: NULL
          key: NULL
      key_len: NULL
          ref: NULL
         rows: 200
        Extra: 	# 不使用临时表的操作
*************************** 2. row ***************************
           id: 1
  select_type: PRIMARY
        table: actor
         type: eq_ref
possible_keys: PRIMARY
          key: PRIMARY
      key_len: 2
          ref: c.actor_id
         rows: 1
        Extra: 
*************************** 3. row ***************************
           id: 2
  select_type: DERIVED
        table: film_actor
         type: index
possible_keys: NULL
          key: PRIMARY
      key_len: 4
          ref: NULL
         rows: 5585
        Extra: Using index	# 使用索引操作
3 rows in set (0.01 sec)





mysql&gt; EXPLAIN SELECT film_id,description FROM sakila.film ORDER BY title LIMIT 50,5 \G
*************************** 1. row ***************************
           id: 1
  select_type: SIMPLE
        table: film
         type: ALL	# 全表扫描方式
possible_keys: NULL
          key: NULL
      key_len: NULL
          ref: NULL
         rows: 1074
        Extra: Using filesort	# 使用了文件方式
1 row in set (0.00 sec)

mysql&gt; 

mysql&gt; EXPLAIN SELECT film_id,description FROM sakila.film ORDER BY film_id LIMIT 50,5 \G # 这里使用了主键
*************************** 1. row ***************************
           id: 1
  select_type: SIMPLE
        table: film
         type: index	# 索引方式 减少IO
possible_keys: NULL
          key: PRIMARY
      key_len: 2
          ref: NULL
         rows: 55
        Extra: 
1 row in set (0.00 sec)

mysql&gt; 

mysql&gt; EXPLAIN SELECT film_id,description FROM sakila.film WHERE film_id &gt;55 AND film_id &lt;=60  ORDER BY film_id LIMIT 50,5 \G
*************************** 1. row ***************************
           id: 1
  select_type: SIMPLE
        table: film
         type: range	# 范围方式  这里要注意主键要顺序排序的    如果有缺键  有可能会出现不足5行的情况
possible_keys: PRIMARY
          key: PRIMARY
      key_len: 2
          ref: NULL
         rows: 5
        Extra: Using where
1 row in set (0.00 sec)

</code></pre>
<p>避免过多的扫描.</p>
<p>索引优化注意事项:
选择合适的列建立索引
如何判断离散程度,唯一值越多离散性越好可选择性越多更适合放在联合索引的前面.</p>
<pre><code>mysql&gt; SELECT COUNT(DISTINCT customer_id),COUNT(DISTINCT staff_id) FROM payment;
+-----------------------------+--------------------------+
| COUNT(DISTINCT customer_id) | COUNT(DISTINCT staff_id) |
+-----------------------------+--------------------------+
|                         599 |                        2 |
+-----------------------------+--------------------------+
1 row in set (0.01 sec)

mysql&gt; 
这里的customer_id的大.

</code></pre>
<p>寻找同类型重复的索引并删除掉,来优化索引.</p>
<pre><code>mysql&gt; USE information_schema ;	#注意: 下面的查看重复的索引要用到这个数据库的一些表
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
mysql&gt; 
mysql&gt; SELECT a.TABLE_SCHEMA AS '数据名',
    -&gt; a.table_name AS '表名',
    -&gt; a.index_name AS '索引1',
    -&gt; b.INDEX_NAME AS '索引2',
    -&gt; a.COLUMN_NAME AS '重复列名'
    -&gt; FROM STATISTICS a JOIN  STATISTICS b ON
    -&gt; a.TABLE_SCHEMA = b.TABLE_SCHEMA AND a.TABLE_NAME=b.TABLE_NAME
    -&gt; AND a.SEQ_IN_INDEX=b.SEQ_IN_INDEX AND a.COLUMN_NAME=
    -&gt; b.COLUMN_NAME WHERE a.SEQ_IN_INDEX=1 AND a.INDEX_NAME&lt;&gt;
    -&gt; b.INDEX_NAME
    -&gt; \G
*************************** 1. row ***************************
   数据名: serverEye
      表名: auth_group_permissions
     索引1: auth_group_permissions_0e939a4f
     索引2: group_id
重复列名: group_id
*************************** 2. row ***************************
   数据名: serverEye
      表名: auth_group_permissions
     索引1: group_id
     索引2: auth_group_permissions_0e939a4f
重复列名: group_id
*************************** 3. row ***************************
   数据名: serverEye
      表名: auth_permission
     索引1: auth_permission_417f1b1c
     索引2: content_type_id
重复列名: content_type_id
*************************** 4. row ***************************
   数据名: serverEye
      表名: auth_permission
     索引1: content_type_id
     索引2: auth_permission_417f1b1c
重复列名: content_type_id
*************************** 5. row ***************************
   数据名: serverEye
      表名: auth_user_groups
     索引1: auth_user_groups_e8701ad4
     索引2: user_id
重复列名: user_id
*************************** 6. row ***************************
   数据名: serverEye
      表名: auth_user_groups
     索引1: user_id
     索引2: auth_user_groups_e8701ad4
重复列名: user_id
*************************** 7. row ***************************
   数据名: serverEye
      表名: auth_user_user_permissions
     索引1: auth_user_user_permissions_e8701ad4
     索引2: user_id
重复列名: user_id
*************************** 8. row ***************************
   数据名: serverEye
      表名: auth_user_user_permissions
     索引1: user_id
     索引2: auth_user_user_permissions_e8701ad4
重复列名: user_id
8 rows in set (0.01 sec)

</code></pre>
<p>使用工具来处理索引冗余问题:</p>
<pre><code>root:linjie# pt-duplicate-key-checker -uroot -p'*********' -h 127.0.0.1

# A software update is available:
#   * The current version for Percona::Toolkit is 2.2.13.

# ########################################################################
# serverEye.auth_group_permissions                                        
# ########################################################################

# auth_group_permissions_0e939a4f is a left-prefix of group_id
# Key definitions:
#   KEY `auth_group_permissions_0e939a4f` (`group_id`),
#   UNIQUE KEY `group_id` (`group_id`,`permission_id`),
# Column types:
#	  `group_id` int(11) not null
#	  `permission_id` int(11) not null
# To remove this duplicate index, execute:
ALTER TABLE `serverEye`.`auth_group_permissions` DROP INDEX `auth_group_permissions_0e939a4f`;

# ########################################################################
# serverEye.auth_permission                                               
# ########################################################################

# auth_permission_417f1b1c is a left-prefix of content_type_id
# Key definitions:
#   KEY `auth_permission_417f1b1c` (`content_type_id`),
#   UNIQUE KEY `content_type_id` (`content_type_id`,`codename`),
# Column types:
#	  `content_type_id` int(11) not null
#	  `codename` varchar(100) not null
# To remove this duplicate index, execute:
ALTER TABLE `serverEye`.`auth_permission` DROP INDEX `auth_permission_417f1b1c`;

# ########################################################################
# serverEye.auth_user_groups                                              
# ########################################################################

# auth_user_groups_e8701ad4 is a left-prefix of user_id
# Key definitions:
#   KEY `auth_user_groups_e8701ad4` (`user_id`),
#   UNIQUE KEY `user_id` (`user_id`,`group_id`),
# Column types:
#	  `user_id` int(11) not null
#	  `group_id` int(11) not null
# To remove this duplicate index, execute:
ALTER TABLE `serverEye`.`auth_user_groups` DROP INDEX `auth_user_groups_e8701ad4`;

# ########################################################################
# serverEye.auth_user_user_permissions                                    
# ########################################################################

# auth_user_user_permissions_e8701ad4 is a left-prefix of user_id
# Key definitions:
#   KEY `auth_user_user_permissions_e8701ad4` (`user_id`),
#   UNIQUE KEY `user_id` (`user_id`,`permission_id`),
# Column types:
#	  `user_id` int(11) not null
#	  `permission_id` int(11) not null
# To remove this duplicate index, execute:
ALTER TABLE `serverEye`.`auth_user_user_permissions` DROP INDEX `auth_user_user_permissions_e8701ad4`;

# ########################################################################
# Summary of indexes                                                      
# ########################################################################

# Size Duplicate Indexes   96
# Total Duplicate Indexes  4
# Total Indexes            130
root:linjie# 
</code></pre>
<p>使用pt工具处理使用频率低或者不用的索引及键(慎重使用,有的主从服务器猪服务器不用了但是从服务器还是在用的或者相反的情况):</p>
<pre><code>pt-index-usage -uroot -p '*****' /var/lib/mysql/Host-slow.log
执行结果:
.......
l Yarn of a Composer And a Man who must Face a Boy in The Canadian Rockies' and 2006 and 1 and NULL and 6 and '0.99' and 105 and '10.99' and 'NC-17' and 'Deleted Scenes' and '2006-02-15 05:03:42') and (999 and 'ZOOLANDER FICTION' and 'A Fateful Reflection of a Waitress And a Boat who must Discover a Sumo Wrestler in Ancient China' and 2006 and 1 and NULL and 5 and '2.99' and 101 and '28.99' and 'R' and 'Trailers and Deleted Scenes' and '2006-02-15 05:03:42') and (1000 and 'ZORRO ARK' and 'A Intrepid Panorama of a Mad Scientist And a Boy who must Redeem a Boy in A Monastery' and 2006 and 1 and NULL and 3 and '4.99' and 50 and '18.99' and 'NC-17' and 'Trailers and Commentaries and Behind the Scenes' and '2006-02-15 05:03:42') &quot;] at /usr/bin/pt-index-usage line 4504, &lt;&gt; line 36.

ALTER TABLE `sakila`.`actor` DROP KEY `idx_actor_last_name`; -- type:non-unique

ALTER TABLE `sakila`.`film` DROP KEY `idx_fk_language_id`, DROP KEY `idx_fk_original_language_id`, DROP KEY `idx_title`; -- type:non-unique

ALTER TABLE `sakila`.`payment` DROP KEY `fk_payment_rental`, DROP KEY `idx_fk_customer_id`, DROP KEY `idx_fk_staff_id`, DROP KEY `idx_paydate`; -- type:non-unique

</code></pre>
<p>选择合适的数据类型优化数据结构</p>
<p>范式优化,一般情况下遵循第三范式</p>
<p>表的拆分
垂直
水平</p>
<p>系统层级的优化
32位的要更注意
64位的要好一些</p>
<pre><code>linjie:~$ ulimit -a        # 查看系统参数
core file size          (blocks, -c) 0
data seg size           (kbytes, -d) unlimited
scheduling priority             (-e) 0
file size               (blocks, -f) unlimited
pending signals                 (-i) 30305
max locked memory       (kbytes, -l) 64
max memory size         (kbytes, -m) unlimited
open files                      (-n) 1024
pipe size            (512 bytes, -p) 8
POSIX message queues     (bytes, -q) 819200
real-time priority              (-r) 0
stack size              (kbytes, -s) 8192
cpu time               (seconds, -t) unlimited
max user processes              (-u) 30305
virtual memory          (kbytes, -v) unlimited
file locks                      (-x) unlimited
linjie:~$ 
</code></pre>
<p>防火墙软件必须关掉,多使用硬件防火墙,非相关软件都去关掉 </p>
<p>mysql本身配置文件的配置优化</p>
<p>配置文件的顺序可以通过如下查找:</p>
<pre><code>linjie:~$ /usr/sbin/mysqld --verbose --help |grep -A 1 'Default options'
150408  8:35:24 [Warning] Using unique option prefix key_buffer instead of key_buffer_size is deprecated and will be removed in a future release. Please use the full name instead. 
150408  8:35:24 [Warning] Can't create test file /var/lib/mysql/Host.lower-test
150408  8:35:24 [Warning] Can't create test file /var/lib/mysql/Host.lower-test
/usr/sbin/mysqld: Can't change dir to '/var/lib/mysql/' (Errcode: 13)
150408  8:35:24 [Warning] One can only use the --user switch if running as root

150408  8:35:24 [Warning] Using unique option prefix myisam-recover instead of myisam-recover-options is deprecated and will be removed in a future release. Please use the full name instead.
150408  8:35:24 [Note] Plugin 'FEDERATED' is disabled.
/usr/sbin/mysqld: Table 'mysql.plugin' doesn't exist
150408  8:35:24 [ERROR] Can't open the mysql.plugin table. Please run mysql_upgrade to create it.
Default options are read from the following files in the given order:
/etc/my.cnf /etc/mysql/my.cnf /usr/etc/my.cnf ~/.my.cnf 
</code></pre>
<p>配置文件参数:</p>
<ol>
<li>
<p>innodb_buffer_pool_instances
5.5 之后的版本新增的参数,可以控制缓冲池的个数用于并发处理提高性能,默认只有一个缓冲池</p>
</li>
<li>
<p>innodb_log_buffer_size
innodb log缓冲大小   日志最长1秒中刷新一次,一般不用太大</p>
</li>
<li>
<p>innodb_flush_log_at_trx_commit 
关键参数,对innodb的IO效率影响很大,默认为1,可以取0,1,2三个值,一般建议设为值2,但如果数据安全性比较高则使用1</p>
</li>
<li>
<p>innodb_read_io_threads
innodb_write_io_threads
IO读写的线程数目 一般设置为CPU核数  或者根据读写的差别设置</p>
</li>
<li>
<p>innodb_file_per_table
关键参数 控制每一个表使用独立的表空间,默认为OFF也就是说有表都会建立在共享表空间中 设置为ON较好</p>
</li>
<li>
<p>innodb_stats_on_metadata
决定了mysql在什么情况下会刷新innodb表的统计信息,一般设置为OFF来提高性能,使用认为的刷新操作.</p>
</li>
</ol>
<p>第三方工具的使用:
http://tools.percona.com/wizard</p>
<hr />
<h2>layout: post
title: Redis 学习整理
category: database
tag: redis
date: 2016-10-31</h2>
<p><strong>摘要:</strong>
redis做缓存还是很棒的,整理下redis学习的内容.</p>
<p><a href="http://www.redis.io/">官网</a>
<a href="http://www.yiibai.com/redis/redis_quick_guide.html">参考地址</a></p>
<p><a href="https://www.processon.com/mindmap/589aeb73e4b0a17827e956de">思维导图地址</a> </p>
<h5><a class="header" href="#思维导图" id="思维导图">思维导图</a></h5>
<p><img src="db/../img/redis.png" alt="" /></p>
<h1><a class="header" href="#js" id="js">Js</a></h1>
<hr />
<h2>layout: post
title: JavaScript的一些代码片段
date: 2016-03-03
category: js
tag: js</h2>
<p><strong>摘要:</strong></p>
<p>以前以为后端工程师不用写js,但是在一些创业公司人手不足的情况还是需要写一写的;
多学习些东西总归是好的,不要去排斥.js是一门很牛逼的语言,可以干很多事情哦!
在平时开发过程中使用到的一些js代码小片段,摘抄在这里,有可能会用到的.自己对js代码
很熟悉,在开发后台代码的过程中用到一些,有些没有记下来,这里当做备忘了.</p>
<h4><a class="header" href="#js-case-replace-exclude-zh-abc---string-" id="js-case-replace-exclude-zh-abc---string-">JS case: replace exclude zh abc &amp; . string !</a></h4>
<pre><code>var newstr = str.replace(/[^\u4E00-\u9FA5\w\.]/g, '');
</code></pre>
<hr />
<h4><a class="header" href="#select-table-element-cloumn" id="select-table-element-cloumn">Select Table Element Cloumn</a></h4>
<ul>
<li>sum the cloumn value</li>
</ul>
<pre><code>var x = 0;
for (var j = 0; j &lt; $(&quot;tbody tr&quot;).length; j++) {
	x += parseInt($(&quot;tbody tr:eq(&quot; + j + &quot;)&quot;).children(&quot;td:eq(5)&quot;).html());
}
</code></pre>
<hr />
<h4><a class="header" href="#get-the-params-from-url" id="get-the-params-from-url">Get The Params From Url:</a></h4>
<pre><code>    function getUrlParam(name) {
        var reg = new RegExp(&quot;(^|&amp;)&quot; + name + &quot;=([^&amp;]*)(&amp;|$)&quot;);
        var r = window.location.search.substr(1).match(reg);
        if (r != null) return unescape(r[2]);
            return null;
    }
</code></pre>
<hr />
<h4><a class="header" href="#float-regex" id="float-regex">Float Regex</a></h4>
<pre><code>var checkNum = /^(([0-9]+\.[0-9]*[1-9][0-9]*)|([0-9]*[1-9][0-9]*\.[0-9]+)|([0-9]*[1-9][0-9]*))$/;
</code></pre>
<hr />
<h4><a class="header" href="#zh-charset-replace" id="zh-charset-replace">ZH charset Replace</a></h4>
<pre><code> var reg = /[\u4e00-\u9fa5]+/g;
 file.name = file.name.replace(reg, escape(Math.random().toString(36).replace(/[^a-z]+/g, '').substr(0, 5)));
</code></pre>
<hr />
<h4><a class="header" href="#set-a-select-element-option-value-to-a-input-elemtnt" id="set-a-select-element-option-value-to-a-input-elemtnt">Set A Select Element Option Value To A Input Elemtnt</a></h4>
<pre><code>function select_to_input($(select_dom), $(input_dom), target_attr) {
    $(select_dom).change(function () {
        var content = $(select_dom).find('option:selected').attr(target_attr);
        $(input_dom).val(content);
    });
}
</code></pre>
<hr />
<h4><a class="header" href="#jquery-packaging-a-form-dataarray" id="jquery-packaging-a-form-dataarray">Jquery Packaging A Form Data(Array)</a></h4>
<pre><code>&lt;div id=&quot;data&quot;&gt;
    &lt;form&gt;
        &lt;input type=&quot;file&quot; name=&quot;userfile&quot; id=&quot;userfile&quot; size=&quot;20&quot; /&gt;
        &lt;input type=&quot;button&quot; id=&quot;upload&quot; value=&quot;upload&quot; /&gt;
    &lt;/form&gt;
&lt;/div&gt;
&lt;script&gt;
        $(document).ready(function(){
                $('#upload').click(function(){
                    var fd = new FormData();    
                    fd.append( 'userfile', $('#userfile')[0].files[0]);
                    $.ajax({
                      url: 'upload/do_upload',
                      data: fd,
                      processData: false,
                      contentType: false,
                      type: 'POST',
                      success: function(data){
                        $('#data').empty();
                        $('#data').append(data);
                      }
                    });
                });
        });
&lt;/script&gt;
</code></pre>
<hr />
<h4><a class="header" href="#get-a-dom-from-iframe-element" id="get-a-dom-from-iframe-element">Get A Dom From iframe Element</a></h4>
<pre><code>    $(window.frames[&quot;ifram-id&quot;].document).find(&quot;target-dom&quot;);
</code></pre>
<hr />
<h4><a class="header" href="#form-list-submit" id="form-list-submit">Form List Submit</a></h4>
<p><code>&lt;input type='submit' onclick='function abc()'&gt;</code>
If in function abc has ajax to submit the form as the same time the element type='submit' , then will be submit twice!!!</p>
<hr />
<h4><a class="header" href="#date-reverse-str" id="date-reverse-str">Date Reverse Str</a></h4>
<pre><code>    function dateToStr(dateArray) {
        var dsArray = new Array();
        for (var i = 0; i &lt; dateArray.length; i++) {
            console.log(dateArray[i]);
            var date_str = String(dateArray[i].getFullYear()) + '-' + String(dateArray[i].getMonth() + 1) + '-' + String(dateArray[i].getDate());
            dsArray.push(date_str);
        }
        return dsArray
    }
   
</code></pre>
<hr />
<h4><a class="header" href="#array-in-turn" id="array-in-turn">Array In Turn</a></h4>
<pre><code> function reversArray(arr) {
        var x = [];
        $.each(arr, function (i, re) {
            x[i] = arr.pop();
        });
        return x
    }
</code></pre>
<hr />
<h4><a class="header" href="#string-format" id="string-format">String Format</a></h4>
<pre><code>String.format = function () {
        if (arguments.length == 0)
            return null;
        var str = arguments[0];
        for (var i = 1; i &lt; arguments.length; i++) {
            var re = new RegExp('\\{' + (i - 1) + '\\}', 'gm');
            str = str.replace(re, arguments[i]);
        }
        return str;
    };
</code></pre>
<h4><a class="header" href="#form-serialize-data" id="form-serialize-data">Form Serialize Data</a></h4>
<pre><code>    $(&quot;form&quot;).on(&quot;submit&quot;, function (event) {
        var formdata = $(this).serializeArray();
        var data = {};
        $(formdata).each(function (index, obj) {
            data[obj.name] = obj.value;
        });
        var url = '/m/ninepic';
        serverData(data, callbackCreateNinePic, url, 'post');
        return false
    });
</code></pre>
<h4><a class="header" href="#gen-date" id="gen-date">Gen Date</a></h4>
<ul>
<li>Calculate current date and format date string.</li>
</ul>
<pre><code>Date.prototype.reduceFormatDate = function (days) {// yyyy-m-d
    Date.prototype.reduceDays = function (days) {
        this.setDate(this.getDate() - parseInt(days));
        return this;
    };
    var currentDate = new Date();
    var targetDate = currentDate.reduceDays(days);
    var dd = targetDate.getDate();
    var mm = targetDate.getMonth() + 1;
    var y = targetDate.getFullYear();
    var someFormattedDate = y + '-' + mm + '-' + dd;
    return someFormattedDate
};
</code></pre>
<pre><code>Date.prototype.reduceFormatDate = function (days) {// yyyy-mm-dd
    Date.prototype.reduceDays = function (days) {
        this.setDate(this.getDate() - parseInt(days));
        return this;
    };
    var currentDate = new Date();
    var targetDate = currentDate.reduceDays(days);
    var dd = ('0' + (currentDate.getDate())).slice(-2);
    var mm = ('0' + (currentDate.getMonth() + 1)).slice(-2);
    var y = targetDate.getFullYear();
    var someFormattedDate = y + '-' + mm + '-' + dd;
    return someFormattedDate
};
</code></pre>
<h1><a class="header" href="#rust" id="rust">Rust</a></h1>
<h1><a class="header" href="#ops" id="ops">Ops</a></h1>
<hr />
<h2>layout: post
title: ab测试
date: 2015-8-21
category: 测试
tag: testing</h2>
<p><strong>摘要:</strong>
web 的ab测试可以提现一个站点的性能情况,在必要的时候提升网站的性能不仅仅可以
提升用户体验,更是可以提高站点运营的收益.google上面可以找到很多的ab testing的
工具.这里介绍下一个常用的工具</p>
<h4><a class="header" href="#安装" id="安装">安装</a></h4>
<p>sudo apt install apache2-utils</p>
<h4><a class="header" href="#执行命令" id="执行命令">执行命令</a></h4>
<p>ab -n 100 -c 10 http://www.baidu.com/  # 100请求数 并发10</p>
<pre><code>This is ApacheBench, Version 2.3 &lt;$Revision: 1706008 $&gt;
Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/
Licensed to The Apache Software Foundation, http://www.apache.org/

Benchmarking www.baidu.com (be patient).....done


Server Software:        BWS/1.1
Server Hostname:        www.baidu.com
Server Port:            80

Document Path:          /
Document Length:        102165 bytes

Concurrency Level:      20
Time taken for tests:   1.067 seconds
Complete requests:      100
Failed requests:        99
   (Connect: 0, Receive: 0, Length: 99, Exceptions: 0)
    Total transferred:      10115466 bytes
    HTML transferred:       10021980 bytes
    Requests per second:    93.70 [#/sec] (mean)
    Time per request:       213.446 [ms] (mean)
    Time per request:       10.672 [ms] (mean, across all concurrent requests)
    Transfer rate:          9256.11 [Kbytes/sec] received

    Connection Times (ms)
                  min  mean[+/-sd] median   max
                  Connect:        6   25  12.5     25      50
                  Processing:     6  147  87.0    124     502
                  Waiting:        5   33  12.7     32      72
                  Total:         14  172  83.5    151     509

                  Percentage of the requests served within a certain time (ms)
      50%    151
      66%    167
      75%    192
      80%    199
      90%    208
      95%    426
      98%    454
      99%    509
      100%    509 (longest request)
</code></pre>
<hr />
<h2>layout: post
title: 阿里云服务操作
date: 2016-11-20
tag: 阿里云
category: 运维</h2>
<p><strong>摘要:</strong> 
记录阿里云停用线上服务器的方法,其中包含了阿里云的后台操作和主机操作,相关的docker
部署操作,内容比较繁杂,需要小心处理,谨慎处理线上问题保证在没有流量的情况下做操作,
以免线上用户体验问题.有些地方应该有更好的解决方案,避免手动处理这些问题,可以采用
运维自动化的方案.</p>
<h3><a class="header" href="#1-按量服务器-停用方法" id="1-按量服务器-停用方法">1. 按量服务器　停用方法</a></h3>
<h4><a class="header" href="#11-关闭主机上面的相应服务-确保没有流量了-从nginx关闭流量" id="11-关闭主机上面的相应服务-确保没有流量了-从nginx关闭流量">1.1 关闭主机上面的相应服务 <strong>确保没有流量了, 从Nginx关闭流量</strong></a></h4>
<ol>
<li>ssh root@ip.address</li>
<li>docker ps</li>
<li>docker stop celery1 celery2 celery3 celery4  # 关闭celery （关闭worker）</li>
<li>docker ps</li>
<li>在阿里云后台停止　对应的主机-&gt;管理－&gt;（获取验证码）停止　</li>
<li>重新初始化磁盘将进入本实例磁盘中，请根据需要单选或者多选执行重新初始化磁盘操作（需要手机验证码）
<em><strong>如果是更换主机（重新购买新主机则不需要清理磁盘）</strong></em></li>
</ol>
<h3><a class="header" href="#2-新机软件及更新" id="2-新机软件及更新">2. 新机软件及更新</a></h3>
<ol>
<li>启动主机</li>
<li>阿里云后台　重置　该实例的密码（ssh登陆密码）重启主机</li>
<li>ssh root@ip.address</li>
</ol>
<h4><a class="header" href="#21-更新ubuntu的更新源为阿里源" id="21-更新ubuntu的更新源为阿里源">2.1 更新ubuntu的更新源为阿里源</a></h4>
<ol>
<li>wget http://7xogkj.com1.z0.glb.clouddn.com/file/sources.list.trusty   # 获取源(上传七牛的源文件链接)</li>
<li>cp /etc/apt/sources.list /etc/apt/sources.list.bk; cp ./sources.list.trusty /etc/apt/sources.list  # 备份原有源 + 更换源</li>
</ol>
<h4><a class="header" href="#22-更新系统软件" id="22-更新系统软件">2.2 更新系统软件</a></h4>
<ol>
<li>sudo apt-get update</li>
<li>sudo apt-get install curl -y</li>
</ol>
<h4><a class="header" href="#23-安装阿里云docker" id="23-安装阿里云docker">2.3 安装阿里云docker</a></h4>
<ol>
<li>curl -sSL http://acs-public-mirror.oss-cn-hangzhou.aliyuncs.com/docker-engine/internet | sh -
echo &quot;DOCKER_OPTS=&quot;--registry-mirror=https://n5fb0zgg.mirror.aliyuncs.com&quot;&quot; | sudo tee -a /etc/default/docker</li>
<li>service docker restart</li>
</ol>
<h4><a class="header" href="#24-docker注册登陆" id="24-docker注册登陆">2.4 docker注册登陆</a></h4>
<ol>
<li>docker login --username=&lt;镜像登陆账号&gt; registry.aliyuncs.com -p &lt;镜像登陆密码&gt;</li>
<li>docker run --name static -v /data busybox /bin/sh </li>
</ol>
<h3><a class="header" href="#3-项目部署" id="3-项目部署">3. 项目部署</a></h3>
<h4><a class="header" href="#31-拷贝项目需要的目录及文件" id="31-拷贝项目需要的目录及文件">3.1 拷贝项目需要的目录及文件</a></h4>
<ul>
<li>老版本已经弃用</li>
</ul>
<pre><code>1. docker inspect static　# 查看静态目录路径 &quot;Name&quot;: &quot;/static&quot; 中&quot;Mounts&quot; &quot;Source&quot;: &quot;/var/lib/docker/volumes/123456/_data&quot;
2. cd /var/lib/docker/volumes/123456/_data  # 进入该静态目录
3. mkdir fonts   # 创建字体目录
4. mkdir -p log/django  # 创建log目录
</code></pre>
<ul>
<li>新方法</li>
</ul>
<ol>
<li>登陆到root@sale9.example.com 清理 /var/data/log/django 中的log文件信息为空<strong>前提是这里的log信息已经在其他地方保存了(例如kibana)</strong></li>
<li>scp -r root@sale9.example.com:/var/data/ /var/  # 拷贝其他生产服务器的目录到新主机(<strong>如果其他主机的log文件过大又不能清空则要手动touch文件</strong>)</li>
</ol>
<h4><a class="header" href="#32-添加redis-ip白名单" id="32-添加redis-ip白名单">3.2 添加redis　ip白名单</a></h4>
<h4><a class="header" href="#33-外网测试下-00009000" id="33-外网测试下-00009000">3.3 外网测试下　0.0.0.0:9000</a></h4>
<ol>
<li>修改本地主机地址映射 在　/tec/hosts  文件中添加行
&lt;新主机的ip地址&gt;  admin.example.com　　# 其中＂.example.com＂　项目配置 ALLOWED_HOSTS 中选择</li>
<li>在阿里云服务器启动docker <strong>测试环境</strong>
docker run --name=gunicorn --restart=always -e INSTANCE=mall -e TARGET=production -e MYSQL_AUTH=&lt;mysql-auth密码&gt; <br />
-e REDIS_AUTH=&lt;rds-auth密码&gt;  -v /var/data:/data -d -p 0.0.0.0:9000:9000 <br />
-e BLUEWARE_CONFIG_FILE=blueware.ini registry.aliyuncs.com/xiaolu-img/xiaolusys:latest blueware-admin run-program <br />
gunicorn -k gevent -c gunicorn_config.py -w 4 shopmanager.wsgi
<strong>gunicorn_config.py 以及静态路径的挂在 按照项目中drone.yml中填写</strong></li>
<li>本地浏览器访问admin.example.com:9000/rest/v1/(可以访问则表示成功)</li>
<li>docker stop <container-id> ; docker rm <container-id>  # 停用测试容器并删除</li>
<li>启动项目(实际使用) <strong>生产环境</strong>
docker run --name=gunicorn --restart=always -e INSTANCE=mall -e TARGET=production -e MYSQL_AUTH=&lt;mysql-auth密码&gt; <br />
-e REDIS_AUTH=&lt;rds-auth密码&gt;  -v /var/data:/data -d -p <code>ifconfig eth0 | awk '/inet addr/{print substr($2,6)}'</code>:9000:9000 <br />
-e BLUEWARE_CONFIG_FILE=blueware.ini registry.aliyuncs.com/xiaolu-img/xiaolusys:latest blueware-admin run-program <br />
gunicorn -k gevent -c gunicorn_config.py -w 4 shopmanager.wsgi</li>
</ol>
<h4><a class="header" href="#34-持续集成key拷贝" id="34-持续集成key拷贝">3.4 持续集成key拷贝</a></h4>
<p><em><strong>将自己本地主机的sshkey拷贝到远程(下次登陆不需要密码输入了)</strong></em></p>
<ol>
<li>ssh-copy-id root@sale7.example.com  # 目的是新主机上面生成 .ssh/authorized_keys 文件</li>
<li>然后登陆线上其他主机将authorized_keys中的持续集成的key都拷贝到新主机的authorized_keys里面  # 保证持续集成</li>
</ol>
<h4><a class="header" href="#35-添加地址解析" id="35-添加地址解析">3.5 添加地址解析</a></h4>
<p>在阿里云后台 云解析DNS　中找到对应的解析域名　添加解析记录　保存　<strong>注意同名同ip的情况</strong></p>
<h4><a class="header" href="#36-修改项目droneyml" id="36-修改项目droneyml">3.6 修改项目drone.yml</a></h4>
<ol>
<li>持续集成配置文件 添加部署的域名</li>
</ol>
<h3><a class="header" href="#37-ngnix-config" id="37-ngnix-config">3.7 NGNIX CONFIG</a></h3>
<p><strong>一定要确保上述配置被核实成功　没有错误才可以在nginx上分配用户流量到该新主机</strong></p>
<ol>
<li>修改配置</li>
<li>push 到staging ｓｕｃｃｅｓｓ之后　访问admin.example.com/admin  测试配置是否影响访问</li>
<li>第二步访问正常则push 到master
<strong>gunicorn　负载超过50%的时候则不能再分配流量</strong></li>
</ol>
<hr />
<h2>layout: post
title: bashrc中的脚本添加内容
date: 2014-10-31
category: shell
tag: bashrc</h2>
<p><strong>摘要:</strong>
在bash中修改一些配置可以让开发变得更高效和方便,比如说添加下快捷命令,当前的
git branch 呀,剪短当前的目录路径显示呀等等.这里做一些记录.自己电脑可以任意
修改自定义的别名,不然的话会给比人添麻烦的.适度自由!!!有些命令有些风险建议
不适用别名的好.</p>
<h4><a class="header" href="#linux-terminal-show-git-branch-shell-script" id="linux-terminal-show-git-branch-shell-script">Linux Terminal Show Git Branch Shell Script</a></h4>
<ul>
<li>show git beranch</li>
<li>show current dir only</li>
<li>rename the promote</li>
<li>alias cmd </li>
</ul>
<pre><code>alias install=&quot;sudo apt-get install&quot;

find_git_branch () {
    local dir=. head
    until [ &quot;$dir&quot; -ef / ]; do
        if [ -f &quot;$dir/.git/HEAD&quot; ]; then
            head=$(&lt; &quot;$dir/.git/HEAD&quot;)
            if [[ $head = ref:\ refs/heads/* ]]; then
                git_branch=&quot;(${head#*/*/})&quot;
            elif [[ $head != '' ]]; then
                git_branch=&quot;((detached))&quot;
            else
                git_branch=&quot;((unknow))&quot;
            fi  
            return
        fi  
        dir=&quot;../$dir&quot;
    done
    git_branch=''
}
PROMPT_COMMAND=&quot;find_git_branch; $PROMPT_COMMAND&quot;
PS1=&quot;\u@\h:\W\$git_branch\$ &quot;
</code></pre>
<hr />
<h2>layout: post
title: Django&amp;Gunicorn&amp;Nginx
date: 2016-09-07
category: 运维
tag: deploy</h2>
<p><strong>摘要:</strong>
部署项目有很多的选择,有些比较合适有些比较不合适,这个要看个人经验,这个组合是我以前
的一个项目上面使用的.应该可以用.下面的内容纯属自己测试使用的没有正式上线.</p>
<h4><a class="header" href="#install-software" id="install-software">Install software</a></h4>
<ol>
<li>sudo apt-get update</li>
<li>sudo apt-get install python-pip python-dev libpq-dev postgresql postgresql-contrib nginx</li>
<li>sudo pip install virtualenv</li>
</ol>
<h4><a class="header" href="#create-database" id="create-database">Create DATABASE</a></h4>
<ol>
<li>sudo su - postgres</li>
<li>psql</li>
<li>CREATE DATABASE myproject;</li>
<li>CREATE USER myprojectuser WITH PASSWORD 'password';</li>
<li>GRANT ALL PRIVILEGES ON DATABASE myproject TO myprojectuser;</li>
<li>\q</li>
<li>exit</li>
</ol>
<h4><a class="header" href="#create-django-project" id="create-django-project">Create Django Project</a></h4>
<ol>
<li>mkdir ~/myproject</li>
<li>cd ~/myproject</li>
<li>virtualenv myprojectenv</li>
<li>source myprojectenv/bin/activate</li>
</ol>
<h4><a class="header" href="#install-requriement" id="install-requriement">Install requriement</a></h4>
<ol>
<li>pip install django gunicorn psycopg2</li>
<li>django-admin.py startproject myproject .</li>
</ol>
<h4><a class="header" href="#config-django-settings" id="config-django-settings">Config Django Settings</a></h4>
<ol>
<li>nano myproject/settings.py</li>
<li>edit under codes</li>
</ol>
<pre><code>DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql_psycopg2',
        'NAME': 'myproject',
        'USER': 'myprojectuser',
        'PASSWORD': 'password',
        'HOST': 'localhost',
        'PORT': '',
    }
}
STATIC_ROOT = os.path.join(BASE_DIR, &quot;static/&quot;)
</code></pre>
<h4><a class="header" href="#migrate-data" id="migrate-data">Migrate Data</a></h4>
<ol>
<li>cd ~/myproject</li>
<li>./manage.py makemigrations</li>
<li>./manage.py migrate</li>
</ol>
<h4><a class="header" href="#create-django-user--run-django-project" id="create-django-user--run-django-project">Create Django User &amp; Run Django Project</a></h4>
<ol>
<li>./manage.py createsuperuser</li>
<li>./manage.py collectstatic</li>
<li>./manage.py runserver 0.0.0.0:8000</li>
</ol>
<h4><a class="header" href="#bind-gunicorn-interface-directly" id="bind-gunicorn-interface-directly">Bind Gunicorn Interface Directly</a></h4>
<ol>
<li>cd ~/myproject</li>
<li>gunicorn --bind 0.0.0.0:8000 myproject.wsgi:application</li>
</ol>
<h4><a class="header" href="#config-gunicorn" id="config-gunicorn">Config Gunicorn</a></h4>
<ol>
<li>sudo nano /etc/init/gunicorn.conf</li>
<li>edit under code</li>
</ol>
<pre><code>description &quot;Gunicorn application server handling myproject&quot;

start on runlevel [2345]
stop on runlevel [!2345]

respawn
setuid jishu_linjie
setgid www-data
chdir /home/jishu_linjie/studyspace/django-stu/myproject/myproject
exec /home/jishu_linjie/studyspace/django-stu/myproject/myprojectenv/bin/gunicorn --workers 3 --bind 192.168.1.31:8000 myproject.wsgi:application(myprojectenv)jish
</code></pre>
<ol start="3">
<li>sudo service gunicorn start</li>
</ol>
<h4><a class="header" href="#config-nginx" id="config-nginx">Config Nginx</a></h4>
<ol>
<li>sudo nano /etc/nginx/sites-available/myproject</li>
<li>edit code under</li>
</ol>
<pre><code>server {
       listen 8001;
       server_name 192.168.1.31;
       
       location = /favicon.ico { access_log off; log_not_found off; }
       location /static/ {
       		root /home/jishu_linjie/studyspace/django-stu/myproject;
	}

       location / {
       		include proxy_params;
		proxy_pass http://192.168.1.31:8000;
       }

</code></pre>
<ol start="3">
<li>sudo ln -s /etc/nginx/sites-available/myproject /etc/nginx/sites-enabled</li>
<li>sudo nginx -t</li>
<li>sudo service nginx restart</li>
</ol>
<hr />
<h2>layout: post
title: Docker 基础
date: 2016-03-06
category: 运维
tag: docker</h2>
<p><strong>摘要:</strong>
我只想说,docker如火如荼,大家都得学习学习,建议看官方文档的好,官方文档很详细.</p>
<h4><a class="header" href="#docker-install--base-commands" id="docker-install--base-commands">Docker Install &amp; Base Commands</a></h4>
<p>$&gt; curl -fsSL https://get.docker.com/ | sh</p>
<p>After installing Docker:</p>
<p>A user needs to be added to the docker group.</p>
<p>$&gt; sudo usermod -aG docker</p>
<p>The docker daemon needs to be started</p>
<p>$&gt; sudo service docker start</p>
<p>You can set the daemon to start at boot</p>
<p>$&gt; sudo chkconfig docker on</p>
<p>You can verify the docker service is running</p>
<p>$&gt; service docker status</p>
<p>And one last final check</p>
<p>$&gt; docker run hello-world</p>
<ol>
<li>
<p>django collect static files by docker 
<code>docker run -ti -v &quot;$PWD&quot;:/usr/src/app -w /usr/src/app/shopmanager test-ubuntu-python python manage.py collectstatic</code>
<code>docker run -ti -v &quot;当前目录&quot;为app -w 项目空间 docker镜像　要执行命令</code></p>
</li>
<li>
<p><code>docker ps -a </code>:  show docker process all</p>
</li>
<li>
<p><code>docker logs &lt;container-id&gt;</code> : show the assign container logs</p>
</li>
</ol>
<p><a href="https://docs.docker.com/">官方文档</a>
<a href="http://www.docker.org.cn/book/docker.html">中文文档</a></p>
<ol start="4">
<li>dockerremove the dangling images<br />
4.1 docker images --quiet --filter=dangling=true  # 列出dangling镜像<br />
4.2 docker images --quiet --filter=dangling=true|xargs --no-run-if-empty docker rmi -f  ＃　删除dangling镜像, 释放磁盘空间</li>
<li>删除容器(过滤)<br />
5.1 docker ps --filter &quot;status=exited&quot; | grep 'weeks ago' | awk '{print $1}' | xargs --no-run-if-empty docker rm</li>
<li>commit container as images<br />
6.1 docker commit <container-id> <repo-name>:<tag></li>
<li>docker run -it -v ~/Downloads:/home/Downloads ubuntu/python3:python3.5 bash</li>
</ol>
<hr />
<h4><a class="header" href="#django-docker" id="django-docker">DJANGO DOCKER</a></h4>
<ol>
<li>
<p>docker pull django</p>
</li>
<li>
<p>set volume and poort by run docker with django docker image
2.1 docker run -p 9002:9001 -ti -v /home/jishu_linjie/studyspace/django-stu/myproject:/home:ro django /bin/bash
cd home/myproject</p>
</li>
<li>
<p>runserver in docker
python manage.py runserver 0.0.0.0:9001</p>
</li>
<li>
<p>verify 
open in host broswer : http://192.168.1.31:9002</p>
</li>
<li>
<p>orther docker cmd : 2.2 docker run -d -p 9002:9001 -ti -v /home/jishu_linjie/studyspace/django-stu/myproject:/home:ro django /home/myproject/manage.py runserver 0.0.0.0:9001</p>
</li>
</ol>
<hr />
<h4><a class="header" href="#docker-file" id="docker-file">Docker File</a></h4>
<pre><code>FROM ubuntu:16.04
RUN apt-get update
RUN apt-get install -y gcc  # ./configure 才可以执行
RUN apt-get install -y build-essential # make 才可以执行
RUN apt-get install -y libssl-dev zlib1g-dev libbz2-dev libsqlite3-dev # 才可以编译安装python3.5
</code></pre>
<hr />
<h2>layout: post
title: Flower
date: 2016-07-16
category: 运维
tag: celery</h2>
<p><strong>摘要:</strong></p>
<p>在使用celery task 异步任务的时候可以使用这个monitor来观察task的运行情况.
同样可以是用flower来调试运行的task,查看程序报错栈信息,很方便.</p>
<h4><a class="header" href="#celery-monitor-flower" id="celery-monitor-flower">Celery Monitor: Flower</a></h4>
<p><code>$ pip install flower</code></p>
<p><code>$ celery -A shopmanager flower</code></p>
<ul>
<li><a href="http://flower.readthedocs.io/en/latest/">文档</a></li>
<li><a href="http://flower.readthedocs.io/en/latest/">Download</a></li>
<li><a href="http://my.oschina.net/u/2306127/blog/420929">参考链接</a></li>
</ul>
<hr />
<h2>layout: post
title: linux 常用命令
date: 2014-08-10
category: linux
tag: linux</h2>
<p><strong>摘要:</strong>
在使用ubuntu的过程中有一些需要记住的命令,这里记录下方便以后查阅.</p>
<h4><a class="header" href="#ubuntu-usually-commands" id="ubuntu-usually-commands">Ubuntu Usually Commands</a></h4>
<ul>
<li>
<p>clean the dpkg commands:</p>
<ul>
<li><code>apt-get autoclean</code></li>
<li><code>apt-get -f install</code></li>
<li><code>dpkg --configure -a</code></li>
<li><code>apt-get -f install</code></li>
<li><code>apt-get -u dist-upgrade</code></li>
<li><code>or try &quot;aptitude&quot; instead of &quot;apt-get&quot;</code></li>
</ul>
</li>
<li>
<p>ubuntu suspend command</p>
<ul>
<li><code>sudo bash -c &quot;sleep 1s; pm-suspend&quot;</code></li>
</ul>
</li>
<li>
<p>clean the memory command</p>
<ul>
<li><code>echo 1 &gt; /proc/sys/vm/drop_caches</code></li>
</ul>
</li>
<li>
<p>ssh command</p>
<ul>
<li><code>ssh fang@192.168.1.8</code></li>
<li><code>scp filename username@192.168.1.31:/home/user/dir</code></li>
<li><code>ssh-keygen -t rsa -C &quot; xxx@xx.com&quot;</code> # ssh file </li>
<li><code>sshfs user@hostip:/dir/path ~/local/dir/path</code>  # 映射本地目录到远程主机</li>
</ul>
</li>
<li>
<p>tar commands</p>
<ul>
<li><code>tar cvf target.tar dirname/</code> // tar file</li>
</ul>
</li>
<li>
<p>rm commands</p>
<ul>
<li><code>find . -name &quot;*.pyc&quot; | xargs rm -f</code> // romove some category file</li>
</ul>
</li>
<li>
<p>show linux core info</p>
<ul>
<li><code>cat /proc/version</code></li>
<li><code>username -r</code> </li>
<li><code>username -a</code></li>
</ul>
</li>
<li>
<p>disk </p>
<ul>
<li>df -h </li>
<li>cd /var/lib</li>
<li>du -hs  # 查看当前目录各文件大</li>
</ul>
</li>
<li>
<p>awk
<code>lsb_release -a|awk '{print $1$2}'|awk 'NR&gt;=2'</code> // 取列输出 nr 取行输出</p>
</li>
</ul>
<h4><a class="header" href="#enospc-解决方法" id="enospc-解决方法">ENOSPC 解决方法</a></h4>
<pre><code>[2016-10-25 09:48:57,785 pyinotify ERROR] add_watch: cannot watch /usr/local/lib/python2.7/dist-packages/django/contrib/messages/storage/cookie.py WD=-1, Errno=No space left on device (ENOSPC)
</code></pre>
<ol>
<li>$cat /proc/sys/fs/inotify/max_user_watches</li>
<li>$sudo sysctl fs.inotify.max_user_watches=16384 (修改数量变大)
<a href="http://www.cnblogs.com/yasmi/p/5192694.html">参考链接</a></li>
</ol>
<hr />
<p>awk</p>
<p>xargs</p>
<hr />
<h4><a class="header" href="#添加任务栏快捷方式可执行文件" id="添加任务栏快捷方式可执行文件">添加任务栏快捷方式(可执行文件)</a></h4>
<ol>
<li>创建快捷键文件<br />
1.1 /usr/local/share/applications/aplication-name.desktop  (/usr/share/applications/)</li>
<li>修改文件</li>
</ol>
<pre><code>[Desktop Entry]
Type=Application
Terminal=true
Name=aplication-name
Icon=/path/to/icon/icon.svg
Exec=/path/to/file/mount-unmount.sh
</code></pre>
<ol start="3">
<li>拖动文件到任务栏</li>
</ol>
<hr />
<h4><a class="header" href="#一个烂脚本" id="一个烂脚本">一个烂脚本</a></h4>
<pre><code>#!/bin/sh
CURRENT_USER=`who |awk '{print $1}'i`
echo &quot;Hello curent user name is $CURRENT_USER, now we will get some info from this computer with the user !&quot;

echo &quot;Excute cmd:w $CURRENT_USER \n&quot;
w $CURRENT_USER

echo &quot;\n&quot;

echo &quot;Current Kernel Is: \n&quot;
echo `uname -r`

echo &quot;\n&quot;

echo &quot;Current System Is: \n&quot;
echo &quot;`lsb_release -a` \c&quot;

echo &quot;\n&quot;

echo &quot;Active Service: \n&quot;

echo &quot;`service --status-all | grep +` \c&quot;

echo &quot;\n&quot;

echo &quot;Open Ports: \n&quot;
echo &quot;`lsof -i` \c&quot;

echo &quot;\n&quot;
echo &quot;NetWork Status: \n&quot;  # [Referance](https://www.cyberciti.biz/faq/check-network-connection-linux/)
echo &quot;`netstat -s` \c&quot;

echo &quot;\n&quot;
echo &quot;Disk Status : \n&quot;
# [Referance](http://www.binarytides.com/linux-command-check-disk-partitions/)
echo &quot;`df -h` \c&quot;


echo &quot;\n&quot;
echo &quot;Memery Info: \n&quot;
# [Referance](https://www.linux.com/blog/5-commands-check-memory-usage-linux)
echo &quot;`free -m` \c&quot;

echo &quot;\n&quot;
echo &quot;Cpu Info: &quot;
echo &quot;`lscpu` \c&quot;


echo &quot;\n&quot;
echo &quot;Cpu Status: \n&quot;
# [Referance](https://www.cyberciti.biz/tips/how-do-i-find-out-linux-cpu-utilization.html)
echo &quot;`top|head -8` \c&quot;

</code></pre>
<hr />
<h2>layout: post
title: MarkDown语法
date: 2015-02-18</h2>
<p><strong>摘要:</strong>
markdown是深受开发人员喜爱的一个文本存储格式,可以方便的生成网页,不需要太多的
布局和样式处理.现在写一些东西基本都用markdown来写.已经习惯了.</p>
<pre><code># Mark Down　手册
## 简单功能
###### Ｈ6 标题　（最小标题）

大标题
===
小标题
---

**粗体**
_斜体_
~~中划线~~

`单行代码：print(&quot;hello world&quot;)`
![Image](http://www.trinea.cn/rss.png)
[百度](www.baidu.com)

1. 目的１
    1. 子项目１
    2. 子项目１
2. 目的２
3. 目的３
- 目的x
    - 目的y
    - 目的z
- 目的x
    - 目的y
    - 目的z

表头1|表头2
---|---
单元格1|单元格2
单元格3|单元格4

Markdown中的转义字符为\，转义的有：
\\ 反斜杠
\` 反引号
\* 星号
\_ 下划线
\{\} 大括号
\[\] 中括号
\(\) 小括号
\# 井号
\+ 加号
\- 减号
\. 英文句号
\! 感叹号

&gt;引用
&gt;&gt;ddd
&gt;&gt;&gt;bbb
</code></pre>
<hr />
<h2>layout: post
title: 零散内容
date: 2016-10-1
category: other
tag: other</h2>
<p><strong>摘要:</strong>
保存一些外链和一些其他的零散的东西.有些东西稍后需要研究的有些仅仅是放在这里.</p>
<h4><a class="header" href="#http-commands" id="http-commands">Http Commands</a></h4>
<pre><code>user@hostname:~$ http http://192.168.1.31:9000/rest/v1/cashout.json --auth jie.lin 登陆网址的用户名称
http: password for jie.lin@192.168.1.31:9000: 输入密码回车
</code></pre>
<hr />
<h4><a class="header" href="#contab" id="contab">Contab</a></h4>
<p>contab combine celery task to do somting!</p>
<hr />
<h4><a class="header" href="#swagger-for-rest-api-doc" id="swagger-for-rest-api-doc">Swagger For Rest API Doc</a></h4>
<p><a href="https://github.com/marcgibbons/django-rest-swagger">Reference Link1</a></p>
<p><a href="http://swagger.io/open-source-integrations/">Reference Link2</a></p>
<hr />
<h4><a class="header" href="#oneapm-monitor" id="oneapm-monitor">OneApm Monitor</a></h4>
<p><code>pip install -i http://pypi.oneapm.com/simple --upgrade oneapm-ci-sdk --trusted-host pypi.oneapm.com</code></p>
<hr />
<h4><a class="header" href="#amqp" id="amqp">AMQP</a></h4>
<p>Advanced Message Queuing Protocol,一个提供统一消息服务的应用层标准高级消息队列协议,是应用层协议的一个开放标准,为面向消息的中间件设计。基于此协议的客户端与消息中间件可传递消息，并不受客户端/中间件不同产品，不同开发语言等条件的限制。Erlang中的实现有 RabbitMQ等。</p>
<p><a href="http://www.zeuux.com/blog/content/3938/">Reference Link</a></p>
<hr />
<h4><a class="header" href="#refrence-links" id="refrence-links">Refrence Links</a></h4>
<ol>
<li>
<p><a href="http://unslider.com/">图片轮播插件　unslider</a></p>
</li>
<li>
<p><a href="http://blog.csdn.net/kevin6216/article/details/6930524">Django 一些 ORM　写法</a></p>
</li>
<li>
<p><a href="http://scrapy-chs.readthedocs.org/zh_CN/latest/intro/tutorial.html">Scrapy 教程</a></p>
</li>
<li>
<p><a href="http://edu.51cto.com/course/course_id-831.html?edu_recommend_adid=91">Python 多线程　FTP软件</a></p>
</li>
<li>
<p><a href="http://edu.51cto.com/course/course_id-617.html?edu_recommend_adid=91">Python 运维</a></p>
</li>
<li>
<p><a href="http://fabric-docs-cn.readthedocs.org/zh_CN/latest/tutorial.html">自动化部署代码－－fabric</a></p>
</li>
<li>
<p><a href="https://github.com/makinacorpus/spynner/blob/master/src/spynner/tests/spynner.rst">模拟浏览器行为－－spynner</a></p>
</li>
<li>
<p><a href="http://www.cnblogs.com/holbrook/archive/2012/03/05/2380398.html">fabric博客文章</a></p>
</li>
<li>
<p><a href="http://segmentfault.com/a/1190000000344159">essay自动化部署</a></p>
</li>
<li>
<p><a href="http://my.oschina.net/hunter007/blog/267333">搭建pypi服务器</a></p>
</li>
<li>
<p><a href="http://www.emacswiki.org/emacs/SendingMail">emacs邮件配置</a></p>
</li>
<li>
<p><a href="https://moonbingbing.gitbooks.io/openresty-best-practices/content/lua/brief.html">OpenResty</a></p>
</li>
<li>
<p><a href="http://www.tutorialspoint.com/lua/lua_overview.htm">Lua教程</a></p>
</li>
<li>
<p><a href="http://emacsninja.com/posts/on-transcending-borders.html#rd">emacs 图形化</a></p>
</li>
</ol>
<hr />
<h4><a class="header" href="#locust-testing-tool" id="locust-testing-tool">Locust Testing Tool</a></h4>
<p><a href="http://maslino.website/post/locust-load-testing-tool.html">ReferenceLink</a></p>
<hr />
<h4><a class="header" href="#terminal--ohmyzsh" id="terminal--ohmyzsh">Terminal : OhMyZsh</a></h4>
<p><a href="https://github.com/robbyrussell/oh-my-zsh/">ReferenceLink</a></p>
<hr />
<h4><a class="header" href="#nospace" id="nospace">NOSPACE</a></h4>
<pre><code>echo fs.inotify.max_user_watches=524288 | sudo tee -a /etc/sysctl.conf &amp;&amp; sudo sysctl -p
</code></pre>
<hr />
<h2>layout: post
title: 守护进程
date: 2015-12-28
category: 运维
tag: supervisor</h2>
<p><strong>摘要:</strong>
生产服务器上面运行这很多重要的程序,有些程序不是很稳定或者是系统原因会停止运行
可以使用守护进程来做守护处理,保证重要的程序一直处于执行状态.</p>
<h4><a class="header" href="#supervisor-base-option" id="supervisor-base-option">Supervisor Base Option</a></h4>
<h5><a class="header" href="#安装-1" id="安装-1">安装</a></h5>
<p><code>sudo easy_install supervisor</code> or <code>sudo pip install supervisor</code></p>
<h5><a class="header" href="#配置" id="配置">配置</a></h5>
<ol>
<li>
<p>gen config file (put the config file in <code>etc</code> director):</p>
<p><code>echo_supervisord_conf &gt; /etc/supervisord.conf</code></p>
<p><strong>如果配置错误修改该配置文件后使用更新命令:</strong> <code>supervisorctl update</code></p>
</li>
<li>
<p>add the guard process(edit the config file,for example)</p>
<pre><code>[program:testpy] ;; testpy是需要守护的进程
command=python /home/jishu_linjie/testpy.py  ;; 要执行的命令
autorestart=true　;; 开启自动重启
</code></pre>
</li>
</ol>
<h5><a class="header" href="#测试下" id="测试下">测试下</a></h5>
<pre><code>root@acer-lin:/home/jishu_linjie# emacs /etc/supervisord.conf 
root@acer-lin:/home/jishu_linjie# supervisorctl update
testpy: stopped
testpy: updated process group
root@acer-lin:/home/jishu_linjie# supervisorctl 
testpy                           STARTING  
supervisor&gt; restart testpy
testpy: stopped
testpy: started
supervisor&gt; stop testpy
testpy: stopped
supervisor&gt; 
</code></pre>
<pre><code>supervisorctl reload
supervisorctl stop all
</code></pre>
<h5><a class="header" href="#验证" id="验证">验证</a></h5>
<ol>
<li>guarded process(testpy.py):</li>
</ol>
<pre><code>#!/usr/bin/python
import datetime
import time
import os

while 1:
    time.sleep(2)
    f = open('supervisor.log','a')
    t = time.time()
    f.write(str(t))
    f.write(&quot;\n&quot;)
    f.close()
</code></pre>
<pre><code>python testpy.py
CTRL + C　to kill the process, 　log still increce, except stop the testpy in `supervisordctl`
</code></pre>
<h5><a class="header" href="#注意" id="注意">注意</a></h5>
<p>The command <code>supervisorctl stop all</code> will kill the guarded process all and the <code>reload</code> and <code>update</code> command can not awaken the killed process.</p>
<h1><a class="header" href="#python" id="python">Python</a></h1>
<hr />
<h2>layout: post
title: actions 示例
date: 2016-11-03
category: python
tag: test</h2>
<p><strong>摘要:</strong>
编写项目测试代码的时候会遇到很多问题,比如测试环境的搭建,测试数据库的准备,以及冗余
测试数据准备不仅导致开发时间的延长,部署难度的增加,甚至导致了代码的混乱难以维护.</p>
<p>以下是刁老师给的一个解决方案.</p>
<h5><a class="header" href="#目录结构" id="目录结构">目录结构</a></h5>
<p>├── actions.py
├── core.py
├── subactions.py
└── test.py</p>
<h5><a class="header" href="#core内容详解" id="core内容详解">core内容详解</a></h5>
<ol>
<li>定义一个action迭代器</li>
<li>定义send方法</li>
<li>定义run方法</li>
<li>描述一个装饰器方法</li>
</ol>
<pre><code>class Action(object):
    def __init__(self, func, args=[], kwargs={}):
        self.name = func.func_name
        self.func = func
        self.args = args
        self.kwargs = kwargs
        self.is_running = False
        self.is_done = False
        self.iterator = None
        self.result = None

    def __iter__(self):
        return self

    def next(self, data=None):
        if self.is_done:
            raise StopIteration
        if not self.is_running:
            result = self.func(*self.args, **self.kwargs)
            if hasattr(result, '__iter__'):
                self.is_running = True
                self.iterator = result
            else:
                self.is_done = True
                self.result = result
                return result
        if self.is_running:
            try:
                if data:
                    result = self.iterator.send(data)
                else:
                    result = next(self.iterator)
            except StopIteration, e:
                self.is_done = True
                self.is_running = False
                raise e
            return result

    def send(self, data):
        return self.next(data)

    def run(self):
        try:
            result = self.next()
            while True:
                if isinstance(result, Action):
                    action_result = result.run()
                    result = self.send(action_result)
                else:
                    self.send(result)
        except StopIteration:
            pass
        return self.result


def action(func):
    def wrapper(*args, **kwargs):
        return Action(func, args, kwargs)
    return wrapper
</code></pre>
<h5><a class="header" href="#actions-详解" id="actions-详解">actions 详解</a></h5>
<ol>
<li>编写调用原子化的业务逻辑代码</li>
<li>使用yield关键字创建生成器函数</li>
</ol>
<pre><code>from core import action
from subactions import get_stock, modify_stock, create_order, record_error

@action
def place_order(user, products):
    for product in products:
        stock = yield get_stock(product)
        if stock &gt; 0:
            yield modify_stock(product, -1)
            yield create_order(user, product)
        else:
            yield record_error(user, product)
</code></pre>
<h5><a class="header" href="#subactions-详解" id="subactions-详解">subactions 详解</a></h5>
<ol>
<li>编写正常的原子化业务逻辑函数</li>
<li>添加action装饰器</li>
</ol>
<pre><code>from core import action

stock_store = {
    &quot;0001&quot;: 10,
    &quot;0002&quot;: 10,
}

order_store = []

@action
def get_stock(product):
    print &quot;get stock: %s&quot; % product
    return stock_store[product]

@action
def modify_stock(product, amount):
    print &quot;modify stock: %s, %s&quot; % (product, amount)
    stock_store[product] = stock_store[product] + amount

@action
def create_order(user, product):
    print &quot;create order: %s, %s&quot; % (user, product)
    order_store.append((user, product))

@action
def record_error(user, product):
    print &quot;record_error: %s, %s&quot; % (user, product)
</code></pre>
<h5><a class="header" href="#test-详解" id="test-详解">test 详解</a></h5>
<ol>
<li>编写测试代码</li>
<li>使用定义的的迭代器方法进行调试</li>
</ol>
<pre><code>from actions import place_order
from subactions import modify_stock


def test_place_order():
    action = place_order(&quot;user1&quot;, [&quot;0001&quot;])
    n = action.next()  # 获取迭代器对象
    print n.name == 'get_stock'
    n = action.send(10)
    print n.name == 'modify_stock'
    action = place_order(&quot;user1&quot;, [&quot;0001&quot;])
    n = action.next()
    n = action.send(0)
    print n.name == 'record_error'


if __name__ == '__main__':
    place_order(&quot;user1&quot;, [&quot;0001&quot;]).run()  # 业务调用
    test_place_order()  # 测试调用

</code></pre>
<hr />
<h2>layout: post
title: 一些算法
date: 2016-04-20
category: 算法
tag: 算法</h2>
<p><strong>摘要:</strong>
谈到算法有两种感觉,第一个感觉是高大上,第二个感觉有难度.高大上是因为那些研究算法的
人都是一些大牛,并且在数学上面有很深的造诣.很钦佩和尊敬那些在算法事业上的牛人.说算
法有难度,是针对个人来说的,我对算法很感兴趣,但是总是浅尝辄止,有的复杂算法就了解下
一带而过了,希望能在这里记录写学习算法的点滴不管是容易的算法还是难的算法还是亲身经历
下得好!</p>
<hr />
<h4><a class="header" href="#vector-correlation-algrithm" id="vector-correlation-algrithm">Vector Correlation Algrithm</a></h4>
<p>图片相似度中使用到的算法.</p>
<ul>
<li>Correlation Section[-1, 1]
** 0:lower 1: higher . And the negative is negative correlations**</li>
</ul>
<pre><code>#coding=utf-8  
import sys
# input 2 vector array  
# output pearson correlation score  

def PearsonCorrelationSimilarity(vec1, vec2):  
    value = range(len(vec1))  
  
    sum_vec1 = sum([ vec1[i] for i in value])  
    sum_vec2 = sum([ vec2[i] for i in value])  
  
    square_sum_vec1 = sum([ pow(vec1[i],2) for i in  value])  
    square_sum_vec2 = sum([ pow(vec2[i],2) for i in  value])  
  
    product = sum([ vec1[i]*vec2[i] for i in value])  
  
    numerator = product - (sum_vec1 * sum_vec2 / len(vec1))   
    dominator = ((square_sum_vec1 - pow(sum_vec1, 2) / len(vec1)) * (square_sum_vec2 - pow(sum_vec2, 2) / len(vec2))) ** 0.5  
  
    if dominator == 0:  
        return 0  
    result = numerator / (dominator * 1.0)  
  
    return result  
  
vec1 = [5.0, 3.0, 2.5]
vec2 = [2.0, 2.5, 5.0]  
vec3 = [5.0, 3.0, 0]  
print (PearsonCorrelationSimilarity(vec1, vec2))
print (PearsonCorrelationSimilarity(vec1, vec3))
</code></pre>
<p><a href="http://www.ruanyifeng.com/blog/2013/03/similar_image_search_part_ii.html">Theory</a></p>
<p><a href="http://blog.csdn.net/afeionepiece/article/details/47624465">Refrence Link</a></p>
<hr />
<h4><a class="header" href="#otsu-algorithm大津算法" id="otsu-algorithm大津算法">Otsu Algorithm(大津算法)</a></h4>
<p>图片处理过程中使用到的算法.</p>
<ul>
<li>Introduce
<code>w1 = n1 / n</code> :n1表示小于灰度阀值的像素个数　n 表示像素总个数　w1　表示前者所占比例
<code>w2 = n2 / n</code> :n2表示大于灰度阀值的像素个数
<code>类间差异 = w1w2(μ1-μ2)^2</code>:穷举最低像素灰度值到最高像素灰度值之间的筏值，计算出类间差异最小</li>
</ul>
<p><a href="http://www.labbookpages.co.uk/software/imgProc/otsuThreshold.html">Theory</a></p>
<p><a href="http://www.ruanyifeng.com/blog/2013/03/similar_image_search_part_ii.html">Refrence Link</a></p>
<hr />
<h4><a class="header" href="#python实现stack" id="python实现stack">python实现stack</a></h4>
<pre><code>#coding=utf-8

class Stack(object):
    def __init__(self):
        self.items = []

    def isEmpty(self):
        return len(self.items) == 0

    def push(self, item):
        self.items.append(item)

    def pop(self):
       return self.items.pop()

    def peek(self):
       if not self.isEmpty():
           return self.items[-1]

    def size(self):
        return len(self.items)

</code></pre>
<h4><a class="header" href="#逆波兰表达式后缀表达式" id="逆波兰表达式后缀表达式">逆波兰表达式(后缀表达式)</a></h4>
<p><a href="http://www.programcreek.com/2012/12/leetcode-evaluate-reverse-polish-notation/">java实现</a>
以下是Python实现.</p>
<pre><code>[&quot;2&quot;, &quot;1&quot;, &quot;+&quot;, &quot;3&quot;, &quot;*&quot;] -&gt; ((2 + 1) * 3) -&gt; 9
[&quot;4&quot;, &quot;13&quot;, &quot;5&quot;, &quot;/&quot;, &quot;+&quot;] -&gt; (4 + (13 / 5)) -&gt; 6
</code></pre>
<ol>
<li>简单的实现方法</li>
</ol>
<pre><code>from stack import Stack

a = Stack()
s = [&quot;2&quot;, &quot;1&quot;, &quot;+&quot;, &quot;3&quot;, &quot;*&quot;]

for i in s:
   if i.isdigit():
       a.push(i)
   else:
       x = a.pop()
       y = a.pop()
       if i == '+':
           a.push(int(x) + int(y))
       if i == '-':
           a.push(int(y) - int(x))
       if i == '*':
           a.push(int(x) * int(y))
       if i == '/':
           a.push(int(y) / int(x))
result = a.pop()
</code></pre>
<ol start="2">
<li>公认的实现方法</li>
</ol>
<pre><code>from stack import Stack

stack = Stack()
s = [&quot;2&quot;, &quot;1&quot;, &quot;+&quot;, &quot;3&quot;, &quot;*&quot;]
operators = '+-*/'

for i in s:
   if i not in operators:
       stack.push(i)
   else:
       x = int(stack.pop())
       y = int(stack.pop())
       index = operators.index(i)
       if index == 0:
           stack.push(x + y)
       if index == 1:
           stack.push(y - x)
       if index == 2:
           stack.push(x * y)
       if index == 3:
           stack.push(y / x)
</code></pre>
<hr />
<h4><a class="header" href="#最长回文算法" id="最长回文算法">最长回文算法</a></h4>
<p>注意这里的算法复杂度和空间复杂度.以下是Python实现.
<a href="http://www.programcreek.com/2013/12/leetcode-solution-of-longest-palindromic-substring-java/">java实现</a></p>
<pre><code>#coding=utf-8
import sys


def longest_palindrome(s):
    &quot;&quot;&quot;
    Time O(n^2), Space O(n^2)
    &quot;&quot;&quot;
    if not s:
        return

    slen = len(s)
    max_len = 1

    dp = []

    # init the zero array, Space 
    for x in xrange(slen):
        d = []
        for y in xrange(slen):
            d.append(0)
        dp.append(d)

    longest = ''

    # condition judgement, Time
    for l in range(slen):
        for i in range(slen - l):
            j = i + l
            if s[i] == s[j] and (j - i &lt;= 2 or dp[i + 1][j - 1]):
                dp[i][j] = 1

                if j - i + 1 &gt; max_len:
                    longest = s[i: j + 1]
    return longest

def simple_longest_plaindrome(s):
    &quot;&quot;&quot;
    Time O(n^2), Space O(1)
    &quot;&quot;&quot;
    slen = len(s)

    if not s:
        return
    if slen == 1:
        return s

    longest = s[0:1]

    # 从中间向两端查找直到符合回文
    def helper(s, begin, end):
        while begin &gt;=0 and end &lt;= len(s) -1 and s[begin] == s[end]:
            begin -= 1
            end += 1
        return s[begin + 1: end]

    for i in xrange(slen):
        tmp = helper(s, i, i)
        if len(tmp) &gt; len(longest):
            longest = tmp

        tmp = helper(s, i, i + 1)
        if len(tmp) &gt; len(longest):
            longest = tmp;

    return longest

if __name__ == '__main__':
    s = sys.argv[1]
    l = longest_palindrome(s)
    print l
    l2 = simple_longest_plaindrome(s)
    print l2
</code></pre>
<hr />
<h4><a class="header" href="#单词分割" id="单词分割">单词分割</a></h4>
<p>给一个字符串s 和一个字典d(python用list表示),如果s可以从d中挑选一个或多个拼接则表示这个s可以被d分割.
s = &quot;leetcode&quot;,
dict = [&quot;leet&quot;, &quot;code&quot;].</p>
<p>以下是Python实现.
<a href="http://www.programcreek.com/2012/12/leetcode-solution-word-break/">Java实现</a></p>
<pre><code>#coding=utf-8
import sys


class WordBreak(object):
    def __init__(self, s, d):
        self.string = s
        self.dictionary = d

    def isWordBreak(self, simple=True):
        if simple:
            return self.simpleBreakHelper(self.string, self.dictionary)

        return self.wordBreakHelper(self.string, self.dictionary, 0)

    def wordBreakHelper(self, s, d, start):
        &quot;&quot;&quot;将目标字符串的对应位置(有start和dictionary决定)查找与在字典内相等的
        字符串,如果相等则从下一个位置继续查看是否匹配
        &quot;&quot;&quot;
        if start == len(s):
            return True

        for a in d:
            al = len(a)
            end = start + al
            if end &gt; len(s):
                continue
            if s[start: end] == a:
                if self.wordBreakHelper(s, d, end):  # 递归
                    return True
        return False

    def simpleBreakHelper(self, s, d):
        &quot;&quot;&quot;当字典很大的时候采用这个方法O(n^2) n 表示字符串的长度
        穷举设置标志位
        &quot;&quot;&quot;
        pos = []
        slen = len(s)
        
        for x in xrange(slen + 1):
            pos.append(-1)
        pos[0] = 0

        for i in xrange(slen):
            if pos[i] != -1:
                for j in xrange(i + 1, slen + 1):
                    sub = s[i: j]
                    if sub in d:
                        pos[j] = i
        return pos[slen] != -1


if __name__ == '__main__':
    s = sys.argv[1]
    d = sys.argv[2].split(',')

    wb = WordBreak(s, d)
    print wb.isWordBreak()
</code></pre>
<hr />
<h2>layout: post 
title: python基础
date: 2015-01-04
category: python
tag: python</h2>
<p><strong>摘要:</strong>
Python是一门语法非常优雅的语言,很多人都是这样说,我也就这么肯定了,开发过程中一直
使用的就是python.大部分计算机或者是人类语言入门都很简单,只要花点时间学习下就可以,
但是想要精通一门语言到大师的水准还是很难的,哪怕是python这样一门业内公认的比较
容易的语言.路漫漫其修远兮,吾将上下而求索!</p>
<h4><a class="header" href="#拷贝一个对象赋值浅拷贝深拷贝的区别" id="拷贝一个对象赋值浅拷贝深拷贝的区别">拷贝一个对象（赋值，浅拷贝，深拷贝的区别）</a></h4>
<ol>
<li>赋值（=）: 就是创建了对象的一个新的引用，修改其中任意一个变量都会影响到另一个。</li>
<li>浅拷贝：创建一个新的对象，但它包含的是对原始对象中包含项的引用（如果用引用的方式修改其中一个对象，另外一个也会修改）
2.1 完全切片方法；
2.2 工厂函数，如list()；
2.3 copy模块的copy()函数}</li>
<li>深拷贝：创建一个新的对象，并且递归的复制它所包含的对象（修改其中一个，另外一个不会改变）
3.1 copy模块的deep.deepcopy()函数</li>
</ol>
<h4><a class="header" href="#python随机数" id="python随机数">Python随机数</a></h4>
<ol>
<li>随机整数：random.randint(a,b)：返回随机整数x,a&lt;=x&lt;=b
random.randrange(start,stop,[,step])：返回一个范围在(start,stop,step)之间的随机整数，不包括结束值。</li>
<li>随机实数：random.random():返回0到1之间的浮点数
random.uniform(a,b):返回指定范围内的浮点数。</li>
</ol>
<h4><a class="header" href="#单引号双引号三引号的区别" id="单引号双引号三引号的区别">单引号，双引号，三引号的区别</a></h4>
<p>单引号和双引号是等效的，如果要换行，需要符号(),三引号则可以直接换行，并且可以包含注释
单引号：s4 = ‘Let\’s go’
双引号：s5 = “Let’s go”
s6 = ‘I realy like“python”!’</p>
<h4><a class="header" href="#range函数用法" id="range函数用法">range()函数用法</a></h4>
<p>如果需要迭代一个数字序列的话，可以使用range()函数，range()函数可以生成等差级数。
如例：</p>
<pre><code>    range(10)               # 输出结果：[0,1,2,3,4,5,6,7,8,9]
    range(5, 10)            # 从5开始，输出结果：[5,6,7,8,9]
    range(0, 10, 3)         # 增量为3，输出结果：[0,3,6,9]
    range(-10, -100, -30)   # 负增长，输出结果：[-10, -40, -70]
    # 可以一起使用range()和len()来迭代一个索引序列
    a = ['Nina', 'Jim', 'Rainman', 'Hello']
    for i in range(len(a)):
        print(i, a[i])
</code></pre>
<h4><a class="header" href="#lambda函数" id="lambda函数">lambda函数</a></h4>
<p>Python允许定义单行的小函数。
lambda函数默认返回表达式的值。你也可以将其赋值给一个变量。lambda函数可以接受任意个参数，包括可选参数，但是表达式只有一个。
如果函数非常简单，只有一个表达式，不包含命令，可以考虑lambda函数。否则，定义函数。</p>
<pre><code>g = lambda x, y: x*y
g(3,4)
g = lambda x, y=0, z=0: x+y+z
(lambda x,y=0,z=0:x+y+z)(3,5,6)  # 也能够直接使用lambda函数，不把它赋值给变量
</code></pre>
<h4><a class="header" href="#类型转换" id="类型转换">类型转换</a></h4>
<p>Python提供了将变量或值从一种类型转换成另一种类型的内置函数。int函数能够将符合数学格式数字型字符串转换成整数。否则，返回错误信息。</p>
<ul>
<li>整型转换
int(”34″)
int(”1234ab”)  # 不能转换成整数
int(34.1234)
int(-2.46)</li>
<li>函数float将整数和字符串转换成浮点数
float(”12″)
float(”1.111111″)</li>
<li>函数str将数字转换成字符
str(98)
‘98’
str(”76.765″)
‘76.765′
<strong>整数1和浮点数1.0在python中是不同的。虽然它们的值相等的，但却属于不同的类型。这两个数在计算机的存储形式也是不一样。</strong></li>
</ul>
<h4><a class="header" href="#pass语句的作用是" id="pass语句的作用是">pass语句的作用是</a></h4>
<ul>
<li>pass语句什么也不做，一般作为占位符或作者创建占位程序，pass语句不会执行任何操作，比如：</li>
</ul>
<pre><code>while False:
    pass
</code></pre>
<ul>
<li>pass通常用来创建一个最简单的类：</li>
</ul>
<pre><code>class MyEmptyClass:
    pass
</code></pre>
<ul>
<li>pass在软件设计阶段也经常用来作为TODO，提醒实现相应的实现.</li>
</ul>
<pre><code>def initlog(*args):
    pass  # todo: please implement this
</code></pre>
<h4><a class="header" href="#定义函数" id="定义函数">定义函数</a></h4>
<ol>
<li>函数的定义</li>
</ol>
<pre><code>def &lt;name&gt;(arg1, arg2,… argN):
    &lt;statements&gt;
</code></pre>
<p>函数的名字也必须以字母开头，可以包括下划线,但不能把Python的关键字定义成函数的名字。函数内的语句数量是任意的，每个语句至少有一个空格的缩进，以表示此语句属于这个函数的。缩进结束的地方，函数自然结束。函数的目的是把一些复杂的操作隐藏，来简化程序的结构，使其容易阅读。函数在调用前，必须先定义。也可以在一个函数内部定义函数，内部函数只有在外部函数调用时才能够被执行。程序调用函数时，转到函数内部执行函数内部的语句，函数执行完毕后，返回到它离开程序的地方，执行程序的下一条语句。</p>
<ol start="2">
<li>function里面设置全局的变量</li>
</ol>
<p>解决方法是在function的开始插入一个global声明：</p>
<pre><code>def f()
    global x
</code></pre>
<h4><a class="header" href="#进行内存管理" id="进行内存管理">进行内存管理</a></h4>
<p>Python的内存管理是由Python解释器负责的，开发人员可以从内存管理事务中解放出来，致力于应用程序的开发，这样就使得开发的程序错误更少，程序更健壮，开发周期更短。从三个方面来说,一.对象的引用计数机制,二.垃圾回收机制,三.内存池机制。</p>
<ol>
<li>
<p>对象的引用计数机制
python内部使用引用计数，来保持追踪内存中的对象，所有对象都有引用计数。
1.1 引用计数增加的情况：
一个对象分配一个新名称
将其放入一个容器中（如列表、元组或字典）
1.2 引用计数减少的情况：
使用del语句对对象别名显示的销毁
1.3 引用超出作用域或被重新赋值:
sys.getrefcount()函数可以获得对象的当前引用计数
多数情况下，引用计数比你猜测得要大得多。对于不可变数据（如数字和字符串），解释器会在程序的不同部分共享内存，以便节约内存。</p>
</li>
<li>
<p>垃圾回收
当一个对象的引用计数归零时，它将被垃圾收集机制处理掉。
当两个对象a和b相互引用时，del语句可以减少a和b的引用计数，并销毁用于引用底层对象的名称。然而由于每个对象都包含一个对其他对象的应用，因此引用计数不会归零，对象也不会销毁。（从而导致内存泄露）。为解决这一问题，解释器会定期执行一个循环检测器，搜索不可访问对象的循环并删除它们。</p>
</li>
<li>
<p>内存池机制
Python提供了对内存的垃圾收集机制，但是它将不用的内存放到内存池而不是返回给操作系统。
Pymalloc机制。为了加速Python的执行效率，Python引入了一个内存池机制，用于管理对小块内存的申请和释放。
Python中所有小于256个字节的对象都使用pymalloc实现的分配器，而大的对象则使用系统的malloc。
<em><strong>对于Python对象，如整数，浮点数和List，都有其独立的私有内存池，对象间不共享他们的内存池。也就是说如果你分配又释放了大量的整数，用于缓存这些整数的内存就不能再分配给浮点数。</strong></em></p>
</li>
</ol>
<h4><a class="header" href="#反序迭代序列" id="反序迭代序列">反序迭代序列</a></h4>
<ul>
<li>如果是一个list, 最快的解决方案是</li>
</ul>
<pre><code>list.reverse()
</code></pre>
<ul>
<li>如果不是list, 最通用但是稍慢的解决方案是</li>
</ul>
<pre><code>for i in range(len(sequence)-1, -1, -1):
    x = sequence[i]
    print x
    &lt;do something with x&gt;
</code></pre>
<h4><a class="header" href="#tuple和list的转换" id="tuple和list的转换">tuple和list的转换</a></h4>
<p>函数tuple(seq)可以把所有可迭代的(iterable)序列转换成一个tuple, 元素不变，排序也不变。例如，tuple([1,2,3])返回(1,2,3), tuple(’abc’)返回(’a’，’b',’c').如果参数已经是一个tuple的话，函数不做任何拷贝而直接返回原来的对象，所以在不确定对象是不是tuple的时候来调用tuple()函数也不是很耗费的。函数list(seq)可以把所有的序列和可迭代的对象转换成一个list,元素不变，排序也不变。例如 list([1,2,3])返回(1,2,3), list(’abc’)返回['a', 'b', 'c']。如果参数是一个list, 她会像set[:]一样做一个拷贝</p>
<h2><a class="header" href="#构建描述符对象" id="构建描述符对象">构建描述符对象</a></h2>
<p>描述符可以改变其他对象，也可以是访问类中任一的getting,setting,deleting。描述符不意味着孤立；相反，它们意味着会被它们的所有者类控制。当建立面向对象数据库或那些拥有相互依赖的属性的类时，描述符是有用的。当描述符在几个不同单元或描述计算属性时显得更为有用。作为一个描述符，一个类必须至少实现__get__,<strong>set</strong>,和__delete__中的一个。</p>
<ul>
<li>
<p><strong>get</strong>(self, instance, owner)
当描述符的值被取回时定义其行为。instance是owner对象的一个实例，owner是所有类。</p>
</li>
<li>
<p><strong>set</strong>(self, instance, value)
当描述符的值被改变时定义其行为。instance是owner对象的一个实例，value是设置的描述符的值</p>
</li>
<li>
<p><strong>delete</strong>(self, instance)
当描述符的值被删除时定义其行为。instance是owner对象的一个实例。</p>
</li>
<li>
<p>单位转换中描述符使用</p>
</li>
</ul>
<pre><code>class Meter(object):
    '''描述符'''
    def __init__(self, value=0.0):
        self.value = float(value)
    def __get__(self, instance, owner):
        return self.value
    def __set__(self, instance, value):
        self.value = float(value)

class Foot(object):
    '''英尺描述符'''
    def __get__(self, instance, owner):
        return instance.meter * 3.2808
    def __set__(self, instance, value):
        instance.meter = float(value) / 3.2808

class Distance(object):
    '''表示距离的类，控制2个描述符：feet和meters'''
    meter = Meter()
    foot = Foot()
</code></pre>
<h4><a class="header" href="#pickling对象" id="pickling对象">Pickling对象</a></h4>
<p>Pickling是一种对Python数据结构的序列化过程。如果你需要存储一个对象，之后再取回它（通常是为了缓存）那么它就显得格外地有用了。有一个词典你想要保存它并在稍后取回。你可以把它的内容写到一个文件中去，需要非常小心地确保你写了正确的语法，然后用exec()或处理文件的输入取回写入的内容。但这是不稳定的:如果你你在纯文本中保存重要的数据，它有可能被几种方法改变，导致你的程序crash或在你的计算机上运行了恶意代码而出错。pickling并非完美。Pickle文件很容易因意外或出于故意行为而被损毁。Pickling可能比起使用纯文本文件安全些，但它仍旧有可能会被用来跑恶意代码。还有因为Python版本的不兼容问题，所以不要期望发布Pickled对象，也不要期望人们能够打开它们。但是，它依然是一个强大的缓存工具和其他常见序列化任务。</p>
<ol>
<li>pickle</li>
</ol>
<pre><code>import pickle
data = {'foo': [1,2,3],
        'bar': ('Hello','world!'),
        'baz': True}
jar = open('data.pk1', 'wb')
pickle.dump(data, jar)  # 把pickled数据写入jar文件
jar.close()
</code></pre>
<ol start="2">
<li>unpickle</li>
</ol>
<pre><code>import pickle
pk1_file = open('data.pk1','rb') #连接pickled数据
data = pickle.load(pk1_file) #把数据load到一个变量中去
print data
pk1_file.close()
</code></pre>
<ol start="3">
<li>
<p>Pickling你自定义的对象
Pickling不仅可用在内建类型上，还可以用于遵守pickle协议的任何类。pickle协议有4个可选方法用于定制Python对象如何运行.
3.1 <strong>getinitargs</strong>(self)
如果你想当你的类unpickled时调用__init__，那你可以定义__getinitargs__，该方法应该返回一个元组的参数，然后你可以把他传递给__init__。注意，该方法仅适用于旧式类。
3.2 <strong>getnewargs</strong>(self)
对于新式类，你可以影响有哪些参数会被传递到__new__进行unpickling。该方法同样应该返回一个元组参数，然后能传递给__new__
3.3 <strong>getstate</strong>(self)
代替对象的__dict__属性被保存。当对象pickled，你可返回一个自定义的状态被保存。当对象unpickled时，这个状态将会被__setstate__使用。
3.4 <strong>setstate</strong>(self, state)
对象unpickled时，如果__setstate__定义对象状态会传递来代替直接用对象的__dict__属性。这正好跟__getstate__手牵手：当二者都被定义了，你可以描述对象的pickled状态，任何你想要的。</p>
</li>
<li>
<p>例子：
Slate类，它会记忆它曾经的值和已经写入的值。然而，当这特殊的slate每一次pickle都会被清空,当前值不会被保存。</p>
</li>
</ol>
<pre><code>import time
class Slate:
    '''存储一个字符串和一个变更log，当Pickle时会忘记它的值'''

    def __init__(self, value):
        self.value = value
        self.last_change = time.asctime()
        self.history = {}

    def change(self, new_value):
        # 改变值，提交最后的值到历史记录
        self.history[self.last_change] = self.value
        self.value = new_value
        self.last_change = time.asctime()

    def print_changes(self):
        print 'Changelog for Slate object:'
        for k, v in self.history.items():
            print '%st %s' % (k, v)

    def __getstate__(self):
        # 故意不返回self.value 或 self.last_change.
        # 当unpickle，我们希望有一块空白的&quot;slate&quot;
        return self.history

    def __setstate__(self, state):
        # 让 self.history = state 和 last_change 和 value被定义
        self.history = state
        self.value, self.last_change = None, None
</code></pre>
<h4><a class="header" href="#团队开发中调用接口" id="团队开发中调用接口">团队开发中调用接口</a></h4>
<p>Python可以实现多继承,没有接口,Java中存在接口.如果真要说接口调用可以用通过类封装好方法,然后让其他子类继承后实例化后调用.</p>
<h4><a class="header" href="#上下文管理" id="上下文管理">上下文管理</a></h4>
<p>在 Python2.5里引入了一个新关键字（with）使得一个新方法得到了代码复用。上下文管理这个概念在Python中早已不是新鲜事了（之前它作为库 的一部分被实现过），但直到<a href="http://www.python.org/dev/peps/pep-0343/">PEP343</a>才作为第一个类语言结构,取得了重要地位而被接受。上下文管理允许对对象进行设置和清理动作，用with声明进行已经封装的操作。上下文操作的行为取决于2个方法：</p>
<ol>
<li><strong>enter</strong>(self)
定义块用with声明创建出来时上下文管理应该在块开始做什么。注意，__enter__的返回值必须绑定with声明的目标，或是as后面的名称。</li>
<li><strong>exit</strong>(self,  exception_type, exception_value, traceback)
定义在块执行（或终止）之后上下文管理应该做什么。它可以用来处理异常，进行清理，或行动处于块之后某些总是被立即处理的事。如果块执行成功的话，exception_type，exception_value，和traceback将会置None。否则，你可以选择去处理异常，或者让用户自己去处理。确保在全部都完成之后__exit__会返回True。如果不想让上下文管理处理异常，那就让它发生好了。
__enter__和__exit__对那些已有良好定义和对设置，清理行为有共同行为的特殊类是有用。你也可以使用这些方法去创建封装其他对象通用的上下文管理。</li>
</ol>
<pre><code>class Closer:
    &quot;&quot;&quot;用with声明一个上下文管理, 用一个close方法自动关闭一个对象
    &quot;&quot;&quot;
    def __init__(self, obj):
        self.obj = obj

    def __enter__(self):
        return self.obj  # 绑定目标

    def __exit__(self, exception_type, exception_val, trace):
        try:
            self.obj.close()
        except AttributeError:  # obj不具备close
            print 'Not closable.'
            return True  # 成功处理异常
</code></pre>
<h4><a class="header" href="#接口和抽象类abcabstract-base-class" id="接口和抽象类abcabstract-base-class">接口和抽象类（ABC:abstract base class）</a></h4>
<ol>
<li>
<p>抽象基类
有些面向对象的语言,如JAVA，支持接口，可以声明一个支持给定的一些方法，或者支持给定存取协议的类。抽象基类（或者ABCs）是Python里一个相同的特性。抽象基类由abc模块构成，包含了一个叫做ABCMeta的metaclass。这个metaclass由内置的isinstance()和issubclass()特别处理，并包含一批会被 Python开发人员广泛用到的基础抽象基类。Python 2.6的 collections模块包括了许多不同的抽象基类来表示出这些不同。Iterable表明一个类定义了__iter__()，Container意味着该类定义了__contains__()方法，因此支持x in y表达式。基本的dictionary接口包括存取数据和 keys()，values()，以及items()，由MutableMapping抽象基类定义。你可以让你的类继承某个特定的抽象基类，来表示它们支持抽象基类接口：</p>
<pre><code>import collections
class Storage(collections.MutableMapping):
    pass
</code></pre>
<p>另外，你可以不继承基类，以调用抽象基类的register()方法的方式注册该类,使得该类支持抽象基类接口。</p>
<pre><code>import collections
class Storage:
    pass
collections.MutableMapping.register(Storage)
</code></pre>
<p>1.1 相对于你写的类来说，从抽象基类继承可能更清晰。当你已经写了一个新的抽象基类，能描述一个存在的类型或类，或者你想声明某些第三方类来实现一个抽象基类，register()方法是有用的。例如，如果你定义了一个PrintableType抽象基类，以下是合法的:</p>
<pre><code>    PrintableType.register(int)

    PrintableType.register(float)

    PrintableType.register(str)
</code></pre>
<p>1.2 类应当遵循由抽象基类指明的语义，但是Python不能检查这一点；类作者应该理解抽象基类的需求，并据此实现代码。要检查一个对象是否支持某个特定接口，你可以这样写：</p>
<pre><code>def func(d):
  if not isinstance(d, collections.MutableMapping):
    raise ValueError(&quot;Mapping object expected, not %r&quot; % d)
</code></pre>
<p>不要认为你必须像上面的例子那样，写许多检查性的代码。Python有很强的duck-typing传统，从来不会进行显式的类型检查。代码只是简单的调用对象的方法，认为这些方法会存在，如果不存在就会抛出异常。抽象基类检查时一定要谨慎，最好在非常必要的时候才那样做。</p>
<p>1.3 你可以在类的定义中用abc.ABCMeta作为metaclass写自己的抽象基类：</p>
<pre><code>from abc import ABCMeta, abstractmethod
class Drawable():

    __metaclass__ = ABCMeta
    @abstractmethod
    def draw(self, x, y, scale=1.0):
        pass

    def draw_doubled(self, x, y):
        self.draw(x, y, scale=2.0)

class Square(Drawable):
    def draw(self, x, y, scale):
        pass
</code></pre>
<p>在以上的Drawable抽象基类中，draw_doubled()方法会按对象两倍的大小画出来，并且可以调用Drawable自己的方法来实现。因此实现这个抽象基类的类不需要提供它们自己的draw_doubled()实现，尽管他们可以那样做。然而draw()的实现是必须的；抽象基类不能提供一个有用的一般实现。你可以在必须实现的方法，如draw()中应用@abstractmethod修饰符；Python会对那些没有定义该方法的类抛出异常。注意，只有当你试图创建一个子类实例，但是却缺少该方法的时候才会抛出异常。</p>
<pre><code>class Circle(Drawable):
    pass

c=Circle()
Traceback (most recent call last):
File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;
TypeError: Can't instantiate abstract class Circle with abstract methods draw
</code></pre>
<p>1.4 抽象数据属性可以用@abstractproperty decorator声明：</p>
<pre><code>from abc import abstractproperty

@abstractproperty
def readonly(self):
    return self._x
</code></pre>
<p>子类必须定义一个readonly()属性。</p>
</li>
</ol>
<p>注意：句柄是指使用的一个唯一的整数值，即一个4字节(64位程序中为8字节)长的数值，来标识应用程序中的不同对象和同类对象中的不同的实例，诸如，一个窗口，按钮，图标，滚动条，输出设备，控件或者文件等。应用程序能够通过句柄访问相应的对象的信息，但是句柄不是一个指针，程序不能利用句柄来直接阅读文件中的信息。如果句柄不在I/O文件中，它是毫无用处的。</p>
<h4><a class="header" href="#import机制" id="import机制">import机制</a></h4>
<ol>
<li>
<p>当import一个module时，假设我们执行,import hello 过程如下：
1.1 搜索sys.modules['hello']是否存在，
<code>if getattr(sys.modules, 'hello') is none： sys.modules['hello'] = hello 执行hello中的语句 else： pass</code>
1.2 globals()[‘hello'] = hello
每当我们使用一个module时，会从globals()中寻找，如果没有发现就报NameError。也就是说一个对象（python万物皆对象）能用，它必须满足两个条件： globals()包含该module。</p>
</li>
<li>
<p>当我们执行from mylib import hello过程如下：</p>
<pre><code>if  getattr(sys.modules, 'mylib.hello') is none:
     sys.modules['mylib'] = mylib
     sys.modules['mylib.hello'] = hello
     # 已经该mylib下的所有对象全都加载到sys.modules中。
     # 执行mylib.__init__.py中语句
     # 执行mylib.hello.py中语句（注意该mylib下的其它module不会在执行）
globals()['hello'] = hello
</code></pre>
</li>
</ol>
<p>当一个对象被import时，如果sys.modules中没有该对象值，那么会执行它的所包含的语句以完成初始化。反之就不会执行它的语句。为什么对象已存在于sys.modules中，却不能用。因为使用一个对象时，是搜索globals()，如何有就可用。sys.modules只能说明该对象是否加载，不能说明已经在当前环境的全局变量中。sys.modules可以将对象存放在内存中，加快访问速度。</p>
<h4><a class="header" href="#闭包" id="闭包">闭包</a></h4>
<p>闭包的特点是返回的函数还引用了外层函数的局部变量，所以，要正确使用闭包，就要确保引用的局部变量在函数返回后不能变。</p>
<pre><code>def count():
    fs = []
    for i in range(1, 4):
        def f(j):
            def g():
                return j*j
            return g  # 正确地返回一个闭包g，g所引用的变量j不是循环变量，因此将正常执行  形参的作用体现 i -&gt; j
        r=f(i)
        fs.append(r)
    return fs

f1, f2, f3 = count()
print f1(), f2(), f3()
</code></pre>
<h4><a class="header" href="#装饰器" id="装饰器">装饰器</a></h4>
<ol>
<li>编写无参数decorator
Python的 decorator 本质上就是一个高阶函数，它接收一个函数作为参数，然后，返回一个新函数。</li>
</ol>
<pre><code>import time

def performance(f):
    def fn(*args,**kw):  # *args 和 **kw，保证任意个数的参数总是能正常调用
        t1 = time.time()
        r = f(*args,**kw)
        t2 = time.time()
        print 'call %s() in %fs'%(f.__name__,(t2-t1))
        return r
    return fn

@performance
def factorial(n):
    return reduce(lambda x,y: x*y, range(1, n+1))

print factorial(10)

</code></pre>
<ol start="2">
<li>编写带参数decorator－@performance 增加一个参数，允许传入's'或'ms'</li>
</ol>
<pre><code>import time
def performance(unit):
    def perf_decorator(f):
        def wrapper(*args, **kw):
            t1 = time.time()
            r = f(*args, **kw)
            t2 = time.time()
            t = (t2 - t1) * 1000 if unit=='ms' else (t2 - t1)
            print 'call %s() in %f %s' % (f.__name__, t, unit)
            return r
        return wrapper
    return perf_decorator
@performance('ms')
def factorial(n):
    return reduce(lambda x,y: x*y, range(1, n+1))
print factorial(10)
</code></pre>
<hr />
<h2><a class="header" href="#基础操作" id="基础操作">基础操作</a></h2>
<h4><a class="header" href="#文件操作" id="文件操作">文件操作</a></h4>
<ul>
<li>删除文件
使用os.remove(filename)或者os.unlink(filename)。</li>
</ul>
<pre><code>import os
os.remove(‘kk.html’)
os.unlink(‘kk.html’)
</code></pre>
<ul>
<li>copy文件</li>
</ul>
<p>shutil模块有一个copyfile函数可以实现文件拷贝。</p>
<pre><code>import shutil
shutil.copyfile('kk.html', 'kkk.html')
</code></pre>
<h4><a class="header" href="#发送邮件" id="发送邮件">发送邮件</a></h4>
<p>可以使用smtplib标准库。以下代码可以在<strong>支持SMTP监听器</strong>的服务器上执行。</p>
<pre><code>import sys, smtplib
fromaddr = raw_input(“FROM：”)
toaddrs = raw_input(”To: “).split(’,')
print “Enter message, end with ^D:”
msg = ”
while 1:
    line = sys.stdin.readline()
    if not line:
        break
        msg = msg + line
# 发送邮件部分
server = smtplib.SMTP(’localhost’)
server.sendmail(fromaddr, toaddrs, msg)
server.quit()
</code></pre>
<hr />
<h2><a class="header" href="#工具选择" id="工具选择">工具选择</a></h2>
<h4><a class="header" href="#python-bug和代码分析工具" id="python-bug和代码分析工具">python bug和代码分析工具</a></h4>
<ul>
<li>有，PyChecker是一个python代码的静态分析工具，它可以帮助查找python代码的bug, 会对代码的复杂度和格式提出警告.</li>
<li>Pylint是另外一个工具可以进行coding standard检查。</li>
</ul>
<hr />
<h2><a class="header" href="#字符串处理" id="字符串处理">字符串处理</a></h2>
<h4><a class="header" href="#正则表达式" id="正则表达式">正则表达式</a></h4>
<ul>
<li>
<p>正则贪婪匹配和非贪婪匹配
当重复匹配一个正则表达式时候， 例如&lt;.*&gt;, 当程序执行匹配的时候，会返回最大的匹配值</p>
<pre><code>import re
s = ‘&lt;html&gt;&lt;head&gt;&lt;title&gt;Title&lt;/title&gt;’
print(re.match(’&lt;.*&gt;’, s).group())
</code></pre>
<p>会返回一个匹配<html><head><title>Title</title>而不是<html>;而</p>
<pre><code>import re
s = ‘&lt;html&gt;&lt;head&gt;&lt;title&gt;Title&lt;/title&gt;’
print(re.match(’&lt;.*?&gt;’, s).group())
</code></pre>
<p>则会返回<html>
&lt;.<em>&gt;这种匹配称作贪心匹配 &lt;.</em>?&gt;称作非贪心匹配</p>
</li>
<li>
<p>search()和match()的区别</p>
<ul>
<li>match（）函数检测RE是不是在string的开始位置匹配， search()会扫描整个string查找匹配, match（）只有在0位置匹配成功的话才有返回，如果不是开始位置匹配成功的话，match()就返回none。
<pre><code>print(re.match(’super’, ’superstition’).span())会返回(0, 5)
print(re.match(’super’, ‘insuperable’))则返回None
</code></pre>
</li>
<li>search()会扫描整个字符串并返回第一个成功的匹配
<pre><code>print(re.search(’super’, ’superstition’).span())返回(0, 5)
print(re.search(’super’, ‘insuperable’).span())返回(2, 7)
</code></pre>
</li>
</ul>
</li>
</ul>
<h4><a class="header" href="#查询和替换一个文本字符串" id="查询和替换一个文本字符串">查询和替换一个文本字符串</a></h4>
<ol>
<li>可以使用sub()方法来进行查询和替换，sub方法的格式为：
sub(replacement, string[, count=0])
replacement是被替换成的文本
string是需要被替换的文本
count是一个可选参数，指最大被替换的数量
<pre><code>    import re
    p = re.compile(’(blue|white|red)’)
    print(p.sub(’colour’,'blue socks and red shoes’))
    print(p.sub(’colour’,'blue socks and red shoes’, count=1))
</code></pre>
</li>
<li>subn()方法执行的效果跟sub()一样，不过它会返回一个二维数组，包括替换后的新的字符串和总共替换的数量
<pre><code>    import re
    p = re.compile(’(blue|white|red)’)
    print(p.subn(’colour’,'blue socks and red shoes’))
    print(p.subn(’colour’,'blue socks and red shoes’, count=1))
</code></pre>
</li>
</ol>
<h2><a class="header" href="#异常处理" id="异常处理">异常处理</a></h2>
<h4><a class="header" href="#except的用法和作用" id="except的用法和作用">except的用法和作用</a></h4>
<p>Python的except用来捕获所有异常， Python错误都会抛出一个异常，每个程序的错误都被当作一个运行时错误,语法形式：<code>try…except…except…[else…][finally…]</code>。执行try下的语句，如果引发异常，则执行过程会跳到except语句。对每个except分支顺序尝试执行，如果引发的异常与except中的异常组匹配，执行相应的语句。如果所有的except都不匹配，则异常会传递到下一个调用本代码的最高层try代码中。try下的语句正常执行，则执行else块代码。如果发生异常，就不会执行。如果存在finally语句，最后总是会执行。</p>
<h4><a class="header" href="#python程序中文输出问题" id="python程序中文输出问题">python程序中文输出问题</a></h4>
<ol>
<li>encode和decode</li>
</ol>
<pre><code>    import os.path
    import xlrd,sys
    Filename=’/home/tom/Desktop/1234.xls’
    if not os.path.isfile(Filename):
        raise NameError,”%s is not a valid filename”%Filename
    bk=xlrd.open_workbook(Filename)
    shxrange=range(bk.nsheets)
    print shxrange
    for x in shxrange:
        p=bk.sheets()[x].name.encode(‘utf-8′)
        print p.decode(‘utf-8′)
</code></pre>
<ol start="2">
<li>在文件开头加上</li>
</ol>
<pre><code>reload(sys)
sys.setdefaultencoding(‘utf8′)
</code></pre>
<pre><code>2.1 如何获得系统的默认编码
```
    #!/usr/bin/env python
    #coding=utf-8
    import sys
    print sys.getdefaultencoding()
```
</code></pre>
<h4><a class="header" href="#python操作数据库" id="python操作数据库">python操作数据库</a></h4>
<ol>
<li>修改表字段名</li>
</ol>
<pre><code>import MySQLdb
try:
    conn=MySQLdb.connect(host='localhost',user='root',passwd='root',db='test',port=3306)
    cur=conn.cursor()
    cur.execute('select * from user')
    cur.close()
    conn.close()
except MySQLdb.Error,e:
    print &quot;Mysql Error %d: %s&quot; % (e.args[0], e.args[1])
</code></pre>
<ol start="2">
<li>
<p>插入数据，批量插入数据，更新数据</p>
<pre><code>import MySQLdb

try:
    conn=MySQLdb.connect(host='localhost',user='root',passwd='root',port=3306)
    cur=conn.cursor()

    cur.execute('create database if not exists python')
    conn.select_db('python')
    cur.execute('create table test(id int,info varchar(20))')

    value=[1,'hi rollen']
    cur.execute('insert into test values(%s,%s)',value)

    values=[]
    for i in range(20):
        values.append((i,'hi rollen'+str(i)))
        cur.executemany('insert into test values(%s,%s)',values)
        cur.execute('update test set info=&quot;I am rollen&quot; where id=3')

    conn.commit()
    cur.close()
    conn.close()

except MySQLdb.Error,e:
    print &quot;Mysql Error %d: %s&quot; % (e.args[0], e.args[1])
</code></pre>
<p><strong>注意一定要有conn.commit()这句来提交事务，要不然不能真正的插入数据。</strong></p>
<pre><code>import MySQLdb

try:
    conn=MySQLdb.connect(host='localhost',user='root',passwd='root',port=3306)
    cur=conn.cursor()
    conn.select_db('python')
    count=cur.execute('select * from test')
    print 'there has %s rows record' % count

    result=cur.fetchone()
    print result
    print 'ID: %s info %s' % result

    results=cur.fetchmany(5)
    for r in results:
        print r
    print '=='*10
    cur.scroll(0,mode='absolute')
    results=cur.fetchall()
    for r in results:
        print r[1]
    conn.commit()
    cur.close()
    conn.close()

except MySQLdb.Error,e:
    print &quot;Mysql Error %d: %s&quot; % (e.args[0], e.args[1])
</code></pre>
</li>
<li>
<p>修改表列名称</p>
<pre><code>try:
    conn = MySQLdb.connect(host='localhost', user='root', passwd='linjie520', port=3306)
    cur = conn.cursor()
    cur.execute('CREATE DATABASE IF NOT EXISTS mytest3 CHARACTER SET UTF8')
    conn.select_db('mytest3')
    cur.execute('CREATE TABLE test(id int,info varchar(20))')
    cur.execute('ALTER TABLE test ADD age INT UNSIGNED NOT NULL DEFAULT 10')
    cur.execute('ALTER TABLE test CHANGE age money INT UNSIGNED NOT NULL DEFAULT 1000')

    value = [1, 'hello world1', 1200]
    cur.execute('INSERT INTO TEST VALUES(%s,%s,%s)', value)
    conn.commit()
    count = cur.execute('SELECT * FROM test')
    print count
    results = cur.fetchmany()
    for r in results:
        print(r)
    cur.close()
    conn.close()
    cur.scroll(0, mode='absolute')
    results = cur.fetchall()
    for r in results:
        print(r[1], r[2])
except MySQLdb.Error, e:
    print &quot;MySQLdb Error %d :%s&quot;, (e.args[0], e.args[1])
</code></pre>
</li>
</ol>
<p>查询后中文会正确显示，但在数据库中却是乱码的。处理方法：
charset是要跟你数据库的编码一样，如果是数据库是gb2312 ,则写charset='gb2312'。
<code>conn = MySQLdb.Connect(host='localhost', user='root', passwd='root', db='python') 中加一个属性：</code>
改为：
<code>conn = MySQLdb.Connect(host='localhost', user='root', passwd='root', db='python', charset='utf8')</code></p>
<ol start="4">
<li>常用的函数：
连接对象也提供了对事务操作的支持,标准的方法<br />
4.1 commit() 提交<br />
4.1 rollback() 回滚<br />
4.3 cursor用来执行命令的方法<br />
4.4 callproc(self, procname,args):用来执行存储过程,接收的参数为存储过程名和参数列表,返回值为受影响的行数<br />
4.5 execute(self, query,args):执行单条sql语句,接收的参数为sql语句本身和使用的参数列表,返回值为受影响的行数<br />
4.6 executemany(self, query, args):执行多条sql语句,但是重复执行参数列表里的参数,返回值为受影响的行数<br />
4.7 nextset(self):移动到下一个结果集<br />
4.8 cursor用来接收返回值的方法<br />
4.9 fetchall(self):接收全部的返回结果行.<br />
4.10 fetchmany(self, size=None):接收size条返回结果行.如果size的值大于返回的结果行的数量,则会返回cursor.arraysize条数据.<br />
4.11 fetchone(self):返回一条结果行.<br />
4.12 scroll(self, value, mode='relative'):移动指针到某一行.如果mode='relative',则表示从当前所在行移动value条,如果 mode='absolute',则表示从结果集的第一行移动value条.</li>
</ol>
<h2><a class="header" href="#python-socket编程" id="python-socket编程">python socket编程</a></h2>
<h4><a class="header" href="#编写server的步骤" id="编写server的步骤">编写server的步骤:</a></h4>
<ol>
<li>创建socket对象。调用socket构造函数。
socket = socket.socket(family, type )
family参数代表地址家族，可为AF_INET或AF_UNIX。AF_INET家族包括Internet地址，AF_UNIX家族用于同一台机器上的进程间通信。
type参数代表套接字类型，可为SOCK_STREAM(流套接字)和SOCK_DGRAM(数据报套接字)。</li>
<li>将socket绑定到指定地址。这是通过socket对象的bind方法来实现的：
socket.bind( address )由AF_INET所创建的套接字，address地址必须是一个双元素元组，格式是(host,port)。host代表主机，port代表端口号。如果端口号正在使用、主机名不正确或端口已被保留，bind方法将引发socket.error异常。</li>
<li>使用socket套接字的listen方法接收连接请求。
socket.listen( backlog )
backlog指定最多允许多少个客户连接到服务器。它的值至少为1。收到连接请求后，这些请求需要排队，如果队列满，就拒绝请求。</li>
<li>服务器套接字通过socket的accept方法等待客户请求一个连接。
connection, address =socket.accept()
调用accept方法时，socket会时入“waiting”状态。客户请求连接时，方法建立连接并返回服务器。accept方法返回一个含有两个元素 的元组(connection,address)。第一个元素connection是新的socket对象，服务器必须通过它与客户通信；第二个元素 address是客户的Internet地址。</li>
<li>处理阶段，服务器和客户端通过send和recv方法通信(传输数据)。服务器调用send，并采用字符串形式向客户发送信息。send方 法返回已发送的字符个数。服务器使用recv方法从客户接收信息。调用recv 时，服务器必须指定一个整数，它对应于可通过本次方法调用来接收的最大数 据量。recv方法在接收数据时会进入“blocked”状态，最后返回一个字符串，用它表示收到的数据。如果发送的数据量超过了recv所允许的，数据 会被截短。多余的数据将缓冲于接收端。以后调用recv时，多余的数据会从缓冲区删除(以及自上次调用recv以来，客户可能发送的其它任何数据)。</li>
<li>传输结束，服务器调用socket的close方法关闭连接。</li>
</ol>
<pre><code># server.py

if __name__ =='__main__':
    import socket
    sock = socket.socket(socket.AF_INET,socket.SOCK_STREAM)
    sock.bind(('localhost',8001))
    sock.listen(5)
while True:
    connection,address =sock.accept()
try:
    connection.settimeout(5)
    buf =connection.recv(1024)
    if buf == '1':
        connection.send('welcometo server!')
    else:
        connection.send('please go out!'
        except socket.timeout:
        print 'time out'
    connection.close()
</code></pre>
<h4><a class="header" href="#python编写client的步骤" id="python编写client的步骤">python编写client的步骤:</a></h4>
<ol>
<li>创建一个socket以连接服务器：socket= socket.socket( family, type )</li>
<li>使用socket的connect方法连接服务器。对于AF_INET家族,连接格式如下：
socket.connect((host,port) )
host代表服务器主机名或IP，port代表服务器进程所绑定的端口号。如连接成功，客户就可通过套接字与服务器通信，如果连接失败，会引发socket.error异常。</li>
<li>处理阶段，客户和服务器将通过send方法和recv方法通信。</li>
<li>传输结束，客户通过调用socket的close方法关闭连接。</li>
</ol>
<pre><code># client.py

if __name__ =='__main__':
    import socket
    sock =socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.connect(('localhost',8001))
    import time
    time.sleep(2)
    sock.send('1')
    print sock.recv(1024)
    sock.close()
</code></pre>
<ol start="5">
<li>在终端运行server.py，然后运行clien.py，会在终端打印“welcome to server!&quot;。如果更改client.py的sock.</li>
</ol>
<h4><a class="header" href="#python自动连接ssh的代码" id="python自动连接ssh的代码">python自动连接ssh的代码</a></h4>
<pre><code>#!/usr/bin/python

import sys, time, os

try:
    import pexpect
except ImportError:
    print &quot;&quot;&quot;You must install pexpect module&quot;&quot;&quot;
    sys.exit(1)

addr_map = {
    'v3' :('root@192.168.1.162', 'sina@2009'),
    'dev':('test016@192.168.1.136', 'test016'),
}

try:
    key = sys.argv[1]
    host = addr_map[key]
except:
    print &quot;&quot;&quot;argv error, use it link ssh v3, v3 must defined in addr_map&quot;&quot;&quot;
    sys.exit(1)
    server = pexpect.spawn('/usr/bin/ssh %s' % host[0])
    server.expect('.*ssword:')
    server.sendline(host[1])
    server.interact()
</code></pre>
<h4><a class="header" href="#把原函数的所有必要属性都一个一个复制到新函数上所以python内置的functools可以用来自动化完成这个复制的任务" id="把原函数的所有必要属性都一个一个复制到新函数上所以python内置的functools可以用来自动化完成这个复制的任务">把原函数的所有必要属性都一个一个复制到新函数上，所以Python内置的functools可以用来自动化完成这个“复制”的任务</a></h4>
<pre><code>import time, functools
def performance(unit):
    def perf_decorator(f):
        @functools.wraps(f)
        def wrapper(*args, **kw):
            t1 = time.time()
            r = f(*args, **kw)
            t2 = time.time()
            t = (t2 - t1) * 1000 if unit=='ms' else (t2 - t1)
            print 'call %s() in %f %s' % (f.__name__, t, unit)
            return r
        return wrapper
    return perf_decorator
@performance('ms')
def factorial(n):
    return reduce(lambda x,y: x*y, range(1, n+1))
print factorial.__name__
</code></pre>
<h4><a class="header" href="#python-反射机制" id="python-反射机制">python 反射机制</a></h4>
<ol>
<li>通过类名获得该类的实例对象</li>
<li>通过方法名得到方法对象</li>
</ol>
<h5><a class="header" href="#personpy" id="personpy">person.py</a></h5>
<pre><code>#coding=utf-8

class Peson(object):
    
    def __init__(self, name):
        self.name = name

    def get_name(self):
        return self.name


def say_hello():
    print 'hello'
</code></pre>
<h5><a class="header" href="#调用实现" id="调用实现">调用实现</a></h5>
<ol>
<li>使用globals实现反射</li>
</ol>
<pre><code>from person import Person
p = globals()['Person']('linjie')
p.get_name()
</code></pre>
<ol start="2">
<li>使用__import__, getattr实现反射
同理可以使用getattr、hasattr、delattr和setattr来实现完整的反射内容</li>
</ol>
<pre><code>module = __import__('person')
p = getattr(module, 'Person')('linjie')
p.get_name()
</code></pre>
<ol start="3">
<li>反射调用函数</li>
</ol>
<pre><code>import person
func = getattr(person, 'say_hello')  # getattr返回的是一个对象
func()
</code></pre>
<h4><a class="header" href="#目录扫描" id="目录扫描">目录扫描</a></h4>
<pre><code>import os
import sys

  
def scan_files(directory,prefix=None,postfix=None):
  files_list=[]

  for root, sub_dirs, files in os.walk(directory):
    for special_file in files:
      if postfix:
        if special_file.endswith(postfix):
          files_list.append(os.path.join(root,special_file))
      elif prefix:
        if special_file.startswith(prefix):
          files_list.append(os.path.join(root,special_file))
      else:
        files_list.append(os.path.join(root,special_file))  
  return files_list

if __name__ == '__main__':
    directory = sys.argv[1]
    l = scan_files(directory)
    print l
</code></pre>
<hr />
<h2>layout: post
title: 长浮点数相加问题
category: python
date: 2017-02-06
tag: 算法</h2>
<p><strong>摘要:</strong>
今天面试,面试官王轶凡老师出的一道题目,就是给两个很长的浮点字符串;输出相加后的结果.
保证没有精度丢失.这里记录下备忘,以后再研究.</p>
<h5><a class="header" href="#自己写的代码如下" id="自己写的代码如下">自己写的代码如下</a></h5>
<p>没有去做优化, 感觉空间蛮大.哈哈......</p>
<pre><code># coding=utf-8
import sys


def main(a, b):
    ia = a.index('.')
    ib = b.index('.')

    l_a = len(a)
    l_b = len(b)
    t_a = l_a - ia
    t_b = l_b - ib
    dot_index = max(ia, ib)

    a = list(a)
    b = list(b)

    a.remove('.')
    b.remove('.')
    # 向前补0
    if ia &gt; ib:
        for i in xrange(ia - ib):
            b.insert(0, 0)
    else:
        for i in xrange(ib - ia):
            a.insert(0, 0)

    # 向后补0
    if t_a &gt; t_b:
        for i in xrange(t_a - t_b):
            b.append(0)
    else:
        for i in xrange(t_b - t_a):
            a.append(0)

    a.reverse()
    b.reverse()

    res = list('0' * max(l_a, l_b))
    tens = 0  # 保存十位数

    for i, j in enumerate(a):
        v1 = int(j) + tens
        v2 = int(b[i])

        tens = (v1 + v2) / 10
        units = (v1 + v2) % 10
        res[i] = units

    res[i + 1] = tens
    res.reverse()

    # 去除无意义的0值
    if res[0] in (0, '0'):
        res = res[1::]

    if tens &gt; 0:
        dot_index += 1

    # 移动小数点
    res.insert(dot_index, '.')
    res = [str(r) for r in res]
    return ''.join(res)


if __name__ == '__main__':
    arg1 = sys.argv[1]
    arg2 = sys.argv[2]
    res = main(arg1, arg2)
    # res = main('999.99', '9.9')  # 1009.89
    # res = main('9.9', '999.99')  # 1009.89
    # res = main('999.991', '9.9')  # 1009.891
    # res = main('9.9', '999.991')  # 1009.891
    print res
</code></pre>
<hr />
<h2>layout: post
title: python内建函数
date: 2015-04-01
category: python
tag: python</h2>
<p><strong>摘要:</strong>
python中和其他语言一样有很多的内建函数,也就是一些已经定要的预定义函数,方便开发
人员在开发中方便的使用这些函数提高开发效率.比如一些数学函数,字符串函数等等.</p>
<p>abs(x)<br />
返回绝对值，x可以使普通类型，长整型，浮点型；如果是复数类型则返回复数的模。
注意：在python中复数表示方法为：a+bj  等同于数学中的：a+b*i</p>
<p>all(iterable)</p>
<p>如果iterable(可迭代的参数)是中的所有element是真则返回真，否则返回假。</p>
<p>运行：
all([1,2,3])
all((1,2,3,0))</p>
<p>any(iterable)
如果iterable(可迭代的参数)是中的存在element是真则返回真，否则返回假。</p>
<p>运行：
any([1,2,3])
any((1,2,3,0))</p>
<p>basestring()
是str和unicode的超类（父类），也是抽象类，因此不能被调用和实例化，但可以被用来判断一个对象是否为str或者unicode的实例，isinstance(obj, basestring)等价于isinstance(obj, (str, unicode))；</p>
<p>运行：
isinstance(&quot;Hello world&quot;, str)
isinstance(&quot;Hello world&quot;, basestring)
isinstance(u&quot;你好&quot;, unicode)
isinstance(u&quot;你好&quot;, basestring)
bin(x)
将integer转换为对应的二进制的字符串，如果参数不是integer，就必须重写一个__index__()方法，并且这个方法返回一个integer类型值。
运行：
bin(1)
bin('a')  # 报错</p>
<p>bool([x])
将数值x转换为Boolean类型，如果是FALSE或者缺省则返回FALSE，否则返回真bool也是一个类，是int的子类。</p>
<p>运行：
bool()
bool(1) 
bool('a') 
bool((1,2,3,0)) 
bool((1,2,3,0))</p>
<p>bytearray([source[, encoding[, errors]]])
返回一个新的字节数组，bytearray是一个可变序列的类型，序列元素取值区间为[0,255]。
如果参数是一个字符串，方法按照encoding将字符串转换为字节序列；
如果参数是一个integer，方法创建integer长度的空字节序列；
如果参数是一个符合buffer接口类型的对象，方法将只读缓冲区对象将用于初始化的字节数组；
如果参数是可迭代的，则必须是[0,255]之间的integer，用于初始化数组的内容。</p>
<p>运行：
a = bytearray(3)
a
bytearray(b'\x00\x00\x00')
a[0]
a[1] 
a[2] 
b = bytearray(&quot;abc&quot;) 
b
b[0]
b[1] 
b[2] 
c = bytearray([1,2,3]) 
c
c[0]
c[1] 
c[2] 
d = bytearray(buffer(&quot;abc&quot;)) 
d
d[0]
d[1] 
d[2] 
e = bytearray()
e</p>
<p>callable(object)
如果参数对象呈现的可以调用则返回True，否则返回False;注意返回为True并不意味着可以调用，返回为False则一定不可以调用；类可以调用，而类实例在没有__call__()方法时候是不可以调用的。</p>
<p>运行：
callable(0)
callable('abc') 
def add(a,b): 
return a+b
callable(add) 
class A: 
pass
callable(A) 
a = A() 
callable(a)
class B:
def <strong>call</strong>(self):
pass
callable(B) 
b=B() 
callable(b)</p>
<p>chr(i)
将对应i数值的ASCII码返回，参数i的区间为[0,255],超出区间则会ValueError；有相反作用的函数式ord(c)。</p>
<p>运行：
chr(1)
chr(98) 
chr(98) 
ord('b') 
chr(266)
Traceback (most recent call last):
File &quot;&lt;pyshell#25&gt;&quot;, line 1, in <module>
chr(266)
ValueError: chr() arg not in range(256)</p>
<p>classmethod(function)
一个类方法接收类隐式的第一个参数,就像一个实例方法接收实例。
classmethod是用来指定一个类的方法为类方法，没有此参数指定的类的方法为实例方法，使用方法如下：</p>
<p>class C:
@classmethod        # 装饰器形式调用
def f(cls, arg1, arg2, ...): ...
注意：实例方法是建立实例才有的方法，类方法是直接可以使用类引用，类方法既可以直接类调用(C.f())，也可以进行实例调用(C().f())。一般在项目中类方法都是设置为工具类使用的。
运行：</p>
<pre><code>&gt;&gt;&gt; class C:
	@classmethod
	def f(self):
		print 'this is a class method'
&gt;&gt;&gt; C.f()
    # 直接调用
this is a class method
&gt;&gt;&gt; c = C()
    # 实例化
&gt;&gt;&gt; c.f()
        # 实例调用
this is a class method

&gt;&gt;&gt; class D:
	def f(self):
		print 'this is not a class method'
&gt;&gt;&gt; D.f()        # 调用失败
Traceback (most recent call last):
  File &quot;&lt;pyshell#55&gt;&quot;, line 1, in &lt;module&gt;
    D.f()
TypeError: unbound method f() must be called with D instance as first argument (got nothing instead)
&gt;&gt;&gt; d=D()
        # 实例化
&gt;&gt;&gt; d.f()
        # 实例调用
this is not a class method
</code></pre>
<p>cmp(x, y)
比较x与y的值，如果x&gt;y则返回1，x&lt;y返回-1,x=y返回0.</p>
<p>运行：
cmp(1,2)
cmp(2,1)
cmp(3,3)</p>
<p>compile(source, filename, mode[, flags[, dont_inherit]])
将source编译为代码或者是AST（abstract syntax tree）对象。代码可以通过exec命令执行，或者可以通过调用eval()函数来处理。</p>
<hr />
<h2>layout: post
title: 开发过程的一些讨论
date: 2016-11-03
category: python
tag: 思考</h2>
<p><strong>摘要:</strong>
最近和同事在代码编写规范上面和一些习惯上有一些讨论,这里做些点滴的记事,以备后
来思考.这里不涉及工匠精神,个人觉得距离一个匠人还是很远的.还有就是修饰代码的过
程本身也是在雕刻着自己./[坏笑]</p>
<p>用python开发代码已经有两个年头了,一开始的时候写代码能实现功能就就是一个简单
的目标,随后看团队中有经验的老司机写的代码,就觉得自己写的代码着实有些捉襟见肘,
所以就套用别人写的代码,总结一些自己的经验.编写代码的目的有一些改变,先是要
把功能实现,随后优化代码很明显的效率问题,然后讲究代码编写的位置,命名是不是符合
团队开发的要求,是不是一眼就能看出来这个function或者class是做什么用的,如果看不出来
也就别指望其他同事能用自己写的代码,当然很讨厌的事情就是,明明有一个同样的功能,而且
方法名称是大部分同事都认同的,但是还是有人自己写自己的不去看别人的代码(当然排除那
本就不看比人写的代码的情况),因为python 很灵活, 有些同事就不去写function了直接
import拿过来,select,update,save 各种操作, 这一通修改过后也不去管什么信号触发问题
最后导致代码维护起来很麻烦,明明有写好的代码可以调用,调用就好了, 还可以提高开发
效率,提高代码复用;在各个文件中都有同一个model的修改操作,排错的时候只能用一个词
形容,真叫是按下葫芦浮起瓢呀!</p>
<p>万幸的是团队的所有同事有了同感,于是乎大家凑到一起讨论了一番,甚至是争执了一番.
激烈的斗争之后总有写产物产生,在线上的代码里总有些变化,总归大家都是想好的.只不过
大家的执念不同,导致的烦恼也就不一样了.</p>
<h4><a class="header" href="#大家的共同认识" id="大家的共同认识">大家的共同认识</a></h4>
<ol>
<li>
<p>命名称尽量不要用缩写
之前有看过一篇文章叫<a href="http://scm-blog.com/2016/12/dont-use-abr.html">珍惜生命少用缩写</a>
,还是很有意思的,当你准备使用缩写的时候,请注意
咱们使用的缩写所有人都能明白(不是想象的明白而是真明白),至少是在自己的团队中大家
都明白,不然的话还是写全的好.比如说之前看到第三方的接口kdniao的快递,在很多地方就
使用了kdn来代替他,这种还是建议使用第三方自己的缩写(kdniao)就可以了.团队中没有
熟悉你写的代码的在使用的过程中是很难用到同样功能的代码的,那只能造轮子了.与其自己
开发过程中节省时间,倒不如大家都能看明白自己的代码,大家一起节省时间的好.</p>
</li>
<li>
<p>修改model的代码一定要放到一个大家同认同的都知道的地方
当项目代码越来越多,业务逻辑越来越繁杂,版本迭代频繁的时候代码维护工作也就越来越难
,所以适当的话一些精力去规范代码的写法很有必要的,在规定或者是说公认的文件之外去
操作数据是一个很不好的习惯,比如说在view中去update了一条记录是很难让人发现的一个
行为.重构代码的时候还要去看view中的代码是否是业务逻辑的一部分,让人很反感.</p>
</li>
<li>
<p>当你需要到别人的模块修改代码的时候一定要告诉那个人
这个不是因为别的原因,大家辛辛苦苦写了一个function,自己或者其他同事用的很开心,一直
没有出现过问题,某天突然不能用了,都去问负责这个模块的同事是怎么回事怎么有出bug了,
查来查去,就是因为不熟悉的同事给修改了,而且是在个人使用的时候悄悄改掉了,也没有看
哪里调用过.后来大家形成了共识,如果自己的代码或者业务上面的需求,需要在额外的模块
有改动,应该告诉这个模块的负责人,让负责这个模块的人添加,如果这个负责人没有时间,
那么自己先添加新的function去完成自己的业务需求,也不能修改,等到负责这个模块的人
有时间后,让他帮忙修改或这检查下.当然最好的办法是在上线代码前做好codereview工作
相关模块的同事一定要在一起.</p>
</li>
<li>
<p>不要随便更新线上的代码
这个执行起来还是很难的,因为要控制线上不出严重的bug是一件很难的事情,因为之前的项目
没有做好codreview工作,也没有强制编写测试代码,所以经常在本地跑的很好的代码
(自己认为的),部署到线上就会引发各种问题, 不去修改的话有不能使用,所以只好一遍一遍
的修改,拿线上当做debug环境,还碰到过拿线上代码去打log查看log来debug的情况,如果说
是很难的问题倒也没话说,不到半个小时就部署四五次之多.令人发指.后来leader就说每天
没有特殊情况大家都是四点以后上线一次代码,注意这里是每天哦.大家都在说敏捷开发,但是
能真正做好的公司没有多少家.</p>
</li>
</ol>
<h4><a class="header" href="#apis约定的争论" id="apis约定的争论">apis约定的争论</a></h4>
<p>公司给我们请了一个很牛逼的技术顾问,我们都喊他刁哥.一直以来项目上新的部署策划,技术
难题甚至是业务难题我们都会咨询他的意见和建议.后台开发的leader也是对刁哥的想法和
技术支持有着重的采纳和执行.我也跟着后面学习了很多新的东西和一些很好的思想.</p>
<h5><a class="header" href="#先阐述一些问题" id="先阐述一些问题">先阐述一些问题:</a></h5>
<p>很早以前我很少使用classmethod装饰器去做一些和class本身相关的事情,比如说创建某个特定的
记录,执行一个和class关联紧密的function等等;后来使用的多了就觉的classmethod类似
一个api去封装关于对应class的各种method.包括一些controler的method都放到这个里面来
写.也就是所谓的fat model的方式,加上model本身有一些method和一些property还有写其他
instance method,一个model文件就有上千行代码,阅读起来很费力.目录外面看很简单,但是
访问到文件的时候就懵逼了,这么多代码怎么去阅读!这里不聊opp 怎么pk oop了哈.</p>
<p>业务逻辑改动的很频繁,代码改动就很频繁,去修改对应的function实现业务逻辑,靠代码注释
来约定这些业务逻辑的做法有些窘迫,因为你不知道这里的注释会不会被别人认为是不重要的
代码而删掉,难不成在注释的后面写上 <code># do_abc()  # 禁止删除</code>这样的注释来保证.这个
约束力太弱了.也经常遇到这种注释.代码管理上没有版本控制是一件很糟糕的事情.感觉就是
<code>总是忙不过来</code>,整天改业务逻辑.如果说去写一个可以配置业务逻辑的模块,开发成本有比较
高,况且在大多数创业公司来说,业务本身就是一个测试业务,说不定明天就没有这个业务逻辑
了,开发了也是浪费.</p>
<p>性能调优,正常的代码优化比如说将range替换成为xrange类似的这里就不谈了有兴趣可以看关
于python的代码优化blog就可以了,如果在model上面写的方法比如说get_abc(),上面去做
类似缓存的事情,还是需要考虑的;比如说在这里使用了cache我在线上想手动执行这个
method的时候我取到的便是cache里面的内容了但是我又不想要cache里面的内容,当然解决
办法总是有的,加个参数就可以解决.但是这样写的话还是和整个model关联起来,让人感觉没有
那么pure.或者在写一个不带cache的相同的method就命名为get_abc_no_cache()吧;感觉这样
的做法有写萌蠢的样子.</p>
<p>django确实很好用,但是大家都说他很重,如果那天项目更换了django,那在model上面的
关系紧密的method就很尴尬了,而且所有引用了model method的view基本也就成了垃圾了;
我还是觉得刁老师说的一句话很有魅力;<strong>程序员的工作不是写一堆未来可能会被抛弃的或者被
替换的代码,而是要写一些可以一直稳定输出价值的代码.</strong></p>
<h5><a class="header" href="#解决方法" id="解决方法">解决方法</a></h5>
<p>问题有很多,总归有办法解决;我们在每个django app里面都添加了一个package叫apis,大概
目录结构是这样:</p>
<pre><code>apis/
├── __init__.py
├── v1
│   ├── __init__.py
│   ├── model_a.py
│   ├── model_b.py
│   └── model_c.py
└── v2

</code></pre>
<p>涉及到业务逻辑的代码,建议放到对应model的文件中,改动数据库的,添加缓存的,涉及到业务
更替的都可以添加到这个结构里面.</p>
<p>不管是不是这个apis的存在与否,分层开发也是刁哥阐述的一个重点,也就是说开发过程中,
不是一个模块一个人独立完成,而是分层完成,从设计model,api编写,service封装,到view
的编写是分配给不同的擅长与这些层次的人来开发,这样可以形成一个工作流程,层次更清晰
开发人员更熟悉,开发效率更高,代码的稳定性也更高.</p>
<p>以上所说的还是有具体情况具体分析的时候,代码重构迁移等等都是耗时耗力的事情.</p>
<hr />
<h2>layout: post
title: cProfile使用
category: tools
tag: performance
date: 2014-12-21</h2>
<p><strong>摘要:</strong>
python 性能调优工具介绍，有使用profile的，这里简单的介绍下cProfile
的使用方法．</p>
<h5><a class="header" href="#代码内部使用" id="代码内部使用">代码内部使用</a></h5>
<pre><code>def func():
    do sth

import cProfile
cProfile.run('func')
</code></pre>
<h5><a class="header" href="#命令行使用" id="命令行使用">命令行使用</a></h5>
<ol>
<li><code>python -m cProfile -o pro -s ncalls tt.py argv_1</code>
-o 将标准输出到文件pro中
-s 表示将按照指定的列排序</li>
</ol>
<h5><a class="header" href="#pstats模块统计" id="pstats模块统计">pstats模块统计</a></h5>
<p>对标准输出文件进行处理,统计。</p>
<pre><code>import pstats
p = pstats.Stats('pro')  # 操作生成的标准输出文件
p.strip_dirs().sort_stats(-1).print_stats()  
# strip_dirs()  removed the extraneous path
# sort_stats()  sorted all the entries
# print_stats() print out all the statistics

p.sort_stats('name')
p.print_stats()

p.sort_stats('time').print_stats(10)   # 打印前面10最耗时的记录

</code></pre>
<h5><a class="header" href="#输出字段解释" id="输出字段解释">输出字段解释</a></h5>
<ul>
<li>ncalls : 方法调用次数</li>
<li>tottime : 调用总时间</li>
<li>percall : 平均每次调用时间</li>
<li>cumtime : 子函数调用总时间</li>
<li>percall : 子函数平均调用时间</li>
<li>filename:lineno(function) : 调用的方法名称
　</li>
</ul>
<hr />
<h2>layout: post
title: 设计模式
date: 2016-2-17
category: 设计模式</h2>
<p><strong>摘要:</strong>
关于设计模式研究的很少只是网上看见了这个例子,这里摘抄下当做是以后学习设计模式的
引子吧,有些同事说设计模式在python中没有什么用处,有些书籍里面说设计模式在python
中很容易导致开发中代码混乱,没有起到好的作用反而导致一些问题.这里不表述这些,只是
记录下看看,说不定以后有用处.</p>
<h5><a class="header" href="#单例模式" id="单例模式">单例模式</a></h5>
<p>单例模式是一种常用的软件设计模式。在它的核心结构中只包含一个被称为单例类的特殊类
通过单例模式可以保证系统中该类只有一个实例而且该实例易于外界访问，从而方便对实例
个数的控制并节约系统资源。如果希望在系统中某个类的对象只能存在一个，单例模式是最
好的解决方案。Python有两种方式可以实现单例模式。</p>
<ul>
<li>
<p>方式1</p>
<pre><code>class Singleton(type):
    def __init__(cls, name, bases, dict):
        super(Singleton, cls).__init__(name, bases, dict)
        cls.instance = None
 
    def __call__(cls, *args, **kw):
        if cls.instance is None:
            cls.instance = super(Singleton, cls).__call__(*args, **kw)
        return cls.instance
 
class MyClass(object):
    __metaclass__ = Singleton
 
print MyClass()
print MyClass()
</code></pre>
</li>
<li>
<p>方式2</p>
<p>使用decorator修饰器来实现单例模式。</p>
<pre><code>def singleton(cls):
    instances = {}
    def getinstance():
        if cls not in instances:
            instances[cls] = cls()
            return instances[cls]
        return getinstance
 
@singleton
class MyClass:
…

</code></pre>
</li>
</ul>
<hr />
<h2>layout: post
title: Django Case
date: 2016-04-13
category: python
tag: django</h2>
<p><strong>摘要:</strong></p>
<p>在项目开发中使用的是django, django除了为别人所诟病的&quot;重&quot;之外还是有很多的好东西的
比如说orm,比如说admin,比如说middleware,比如说cache等等,开发效率很快,分分钟就可以
做一个后台管理.其官网的更新速度可以说是快得令人发指,记得我们的项目开始使用的是
1.4.11, 15年出来了1.7,后面相继出来了1.8 1.9 现在项目都已经更新到1.10了.</p>
<h4><a class="header" href="#django-使用过程中的小case" id="django-使用过程中的小case">django 使用过程中的小case</a></h4>
<h5><a class="header" href="#django-template-tuple" id="django-template-tuple">Django template tuple</a></h5>
<ul>
<li>use choices in template</li>
</ul>
<pre><code>class P(models.Model):
    A1 = 1
    A2 = 2
    A3 = 3
    CHOICES = ((A1,u'des1'), (A2,u'des2'), (A3,u'des3'))
</code></pre>
<pre><code>render_to_response({&quot;choices&quot; : P.CHOICES})
</code></pre>
<pre><code>    &lt;div class=&quot;col-xs-2&quot;&gt;
        &lt;select name=&quot;ware_by&quot; id=&quot;ware_by&quot;&gt;
            {   % for  cid , show in choices %   }
               &lt;option value=&quot;{   { cid }   }&quot;&gt;{  { show }  }&lt;/option&gt;
            {    % endfor  %   }
        &lt;/select&gt;
    &lt;/div&gt;
</code></pre>
<hr />
<h5><a class="header" href="#django-debug" id="django-debug">django debug</a></h5>
<ul>
<li>
<p>space not enough
ubuntu 14.04
python 2.7.6
django 1.8.4</p>
<pre><code>[2015-10-02 04:10:46,441 pyinotify ERROR] add_watch: cannot watch /usr/local/lib/python2.7/dist-packages/django/contrib/admin/locale/io/LC_MESSAGES/django.mo WD=-1, Errno=No space left on device (ENOSPC)
</code></pre>
<p><a href="http://stackoverflow.com/questions/27948612/django-test-run-environment-error-no-enough-space-left-on-disk">Refrence Link 1</a>
<a href="http://blog.csdn.net/myarrow/article/details/7096460">Refrence Link 2</a>
<a href="http://www.jincon.com/archives/119/">Refrence Link 3</a>
run cmd in ubuntu terminal： <code>sudo sysctl fs.inotify.max_user_watches=16384</code></p>
</li>
<li>
<p>system encoding error<br />
ubuntu 14.04<br />
python 2.7.6<br />
django 1.8.4</p>
</li>
</ul>
<pre><code>    UnicodeEncodeError: 'ascii' codec can't encode characters in position ...
</code></pre>
<pre><code>[Refrence Link](http://blog.csdn.net/sky_qing/article/details/9251735)
</code></pre>
<pre><code>    reload(sys)   
    sys.setdefaultencoding('utf8')  
</code></pre>
<hr />
<h5><a class="header" href="#add-a-logger-to-print-log-info-in-console" id="add-a-logger-to-print-log-info-in-console">Add A Logger To Print Log Info In Console</a></h5>
<pre><code>LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'handlers': {
        'console':{
            'level':'DEBUG',
            'class':'logging.StreamHandler',
        },
    },
    'loggers': {
        'django.db.backends': {
            'handlers': ['console'],
            'propagate': True,
            'level':'DEBUG',
        },
    }
}
</code></pre>
<hr />
<h5><a class="header" href="#logger" id="logger">Logger</a></h5>
<pre><code>import logging
logger = logging.getLogger(__name__)
logger.warn()
logger.error()
</code></pre>
<h5><a class="header" href="#get-the-same-name-form-data-in-django-seriver" id="get-the-same-name-form-data-in-django-seriver">Get The Same 'name' Form Data In Django Seriver</a></h5>
<ul>
<li>form </li>
</ul>
<pre><code>&lt;form action=&quot;&quot; method=&quot;POST&quot;&gt;  
&lt;input type=&quot;checkbox&quot; name=&quot;abc&quot; value=&quot;123&quot;&gt;  
&lt;input type=&quot;checkbox&quot; name=&quot;abc&quot; value=&quot;456&quot;&gt;  
&lt;input type=&quot;checkbox&quot; name=&quot;abc&quot; value=&quot;789&quot;&gt;  
&lt;input type=&quot;checkbox&quot; name=&quot;abc&quot; value=&quot;110&quot;&gt;  
&lt;/form&gt;
</code></pre>
<ul>
<li>python code</li>
</ul>
<pre><code>a = request.POST.getlist('abc')
In[i]: type(a)
Out[i+1]: list
</code></pre>
<hr />
<h5><a class="header" href="#http-request-save-many-value" id="http-request-save-many-value">Http Request Save Many Value</a></h5>
<pre><code>    for k, v in request.data.iteritems():
        k = str(k)
        if not hasattr(instance, k): continue
        instance.__setattr__(k, v)
        instance.save()            
</code></pre>
<pre><code>    if hasattr(instance,k) and getattr(instance,k) != v:
        setattr(instance, k, v)
</code></pre>
<hr />
<h5><a class="header" href="#add-data-into-manytomanyfield" id="add-data-into-manytomanyfield">Add Data Into ManyToManyField</a></h5>
<pre><code>my_obj.categories.add(fragmentCategory.objects.get(id=1))
my_obj.categories.create(name='val1')
</code></pre>
<hr />
<h5><a class="header" href="#django-orm-only" id="django-orm-only">Django ORM: only</a></h5>
<pre><code>In [29]: ss = shops.only(&quot;shoptime&quot;)
In [30]: print ss.query
SELECT `table_name`.`id`, `flashsale_tongji_shopping`.`shoptime` FROM `table_name`
In [31]: 
</code></pre>
<hr />
<h5><a class="header" href="#django-orm-only-1" id="django-orm-only-1">Django ORM: only</a></h5>
<pre><code>shops = ModelsName.objects.filter(linkid=5).only(&quot;shoptime&quot;).dates(&quot;shoptime&quot;,&quot;day&quot;,order='DESC')
In [19]: shops
Out[19]: [datetime.datetime(2015, 11, 27, 0, 0), datetime.datetime(2015, 11, 24, 0, 0),
datetime.datetime(2015, 11, 4, 0, 0)]
</code></pre>
<p><strong>dates:de-weight the record</strong></p>
<hr />
<h5><a class="header" href="#django-orm-annotate" id="django-orm-annotate">Django ORM: annotate</a></h5>
<ul>
<li>if not use 'values' there will be <code>group_by</code> all fields</li>
</ul>
<pre><code>In [12]: clks = ModelName.objects.all()

In [13]: a = clks.annotate(sum_clk = Sum('valid_num')).filter(id=5)

In [14]: print a.query
SELECT ... all fields ...
SUM(`table_name`.`valid_num`) AS `sum_clk` FROM `table_name`
WHERE `table_name`.`id` = 5  GROUP BY ... all fields ... ORDER BY `table_name`.`date` DESC
</code></pre>
<ul>
<li>first <code>filter</code> then <code>annotate</code></li>
</ul>
<pre><code>In [17]: clks = ClickCount.objects.all()
In [18]: a = clks.filter(linkid=5).annotate(sum_clk = Sum('valid_num'))
In [19]: print a.query
SELECT ... all fields ...
SUM(`table_name`.`valid_num`) AS `sum_clk` FROM `table_name`
WHERE `table_name`.`id` = 5  GROUP BY ... all fields ... ORDER BY `table_name`.`date` DESC
</code></pre>
<p><strong>so there are no diffrence 'filter' order about 'annotate'(django 1.4.11)</strong></p>
<ul>
<li>use values filter <code>group by</code> field</li>
</ul>
<pre><code>In [15]: b = clks.values('id').annotate(sum_clk=Sum(&quot;valid_num&quot;))

In [16]: print b.query
SELECT `table_name`.`id`, SUM(`table_name`.`valid_num`) AS `sum_clk` FROM 
`table_name` GROUP BY `table_name`.`id` ORDER BY `table_name`.`date` DESC

In [17]: 

</code></pre>
<hr />
<h5><a class="header" href="#django-orm-filter-range" id="django-orm-filter-range">Django ORM: filter range</a></h5>
<pre><code>In [22]: tf =  datetime.date(2015, 8, 21)
In [23]: to = datetime.date(2015, 10, 22)
In [24]: xxx = ModelsName.objects.filter(created__range=(tf,to))
In [26]: xxx.values('created')
Out[26]: [{'created': datetime.date(2015, 8, 21)}, {'created': datetime.date(2015, 8, 21)},
{'created': datetime.date(2015, 10, 22)}, {'created': datetime.date(2015, 10, 22)}]
</code></pre>
<p><strong>range filter contains the boundaries</strong></p>
<p><code>created__range=(tf,to)</code> could replace <code>created__range=[tf,to]</code></p>
<hr />
<h5><a class="header" href="#django-orm-extra" id="django-orm-extra">Django ORM: extra</a></h5>
<ul>
<li>select
xx = queryset.extra(select={'alias_name':'model_field REGEXP &quot;^abc&quot;'}) </li>
</ul>
<pre><code>SELECT (model_field REGEXP &quot;abc&quot;) AS `alias_name` FROM `table_name` 
</code></pre>
<ul>
<li>where
ss = queryset.extra(where={'not model_field REGEXP &quot;^abc&quot;'})</li>
</ul>
<pre><code>SELECT * FROM &lt;table_name&gt; WHERE NOT &lt;field_name&gt; REGEXP '^abc';
</code></pre>
<p><strong>add and senctenc in extra</strong></p>
<pre><code>sss = ModelName.objects.extra(select={'created_d':'date(created)'}).values('created_d','customer').annotate(sum_value=Sum('value')) 
</code></pre>
<p><em>convert the datetime to date then group by</em></p>
<pre><code>SELECT (date(created)) AS `created_d`, `table_name`.`customer`, SUM(`table_name`.`value`) AS `sum_value` FROM 
    `table_name` GROUP BY `table_name`.`customer`, (date(created)) ORDER BY NULL
</code></pre>
<ul>
<li>extra and order by</li>
</ul>
<pre><code>queryset = queryset.extra(select={'refund_rate': 'total_refund_num/total_sale_num'}).order_by(
                'refund_rate')
</code></pre>
<hr />
<h5><a class="header" href="#regex" id="regex">Regex</a></h5>
<pre><code>for modelid in modelids:
    x = r'(,|^)\s*' + str(modelid) + r'\s*(,|$)'
    descriptions.extend(
        ModelName.objects.filter(detail_modelids__regex=x).values('id',
                                               'detail_modelids',
                                               'description'))
</code></pre>
<hr />
<h5><a class="header" href="#same-field-filter" id="same-field-filter">Same Field Filter</a></h5>
<pre><code>from django.db.models import F                     
ModelX.objects.filter(a=F('b'))

SELECT * FROM `table` WHERE `table`.`a` = (`table`.`b`)
</code></pre>
<hr />
<h5><a class="header" href="#django-modify-model-field-step" id="django-modify-model-field-step">Django Modify Model Field Step</a></h5>
<ol>
<li>modify the model fields</li>
<li>python manage.py makemigrations <app></li>
<li>auto gen the migrations files in migrations director(do not modify the auto increce num,but can change the name)</li>
<li>python manage.py migrate <app></li>
</ol>
<p>exception handler comands:</p>
<p>python manage.py migrate <app> --list  # show the migrations fils exced list</p>
<p>python manage.py migrate <app> &lt;0003&gt; --fake  # fake the 0003 file was excuted, if you want to skip a migrate file</p>
<hr />
<h5><a class="header" href="#django-dumpdata-command" id="django-dumpdata-command">Django Dumpdata Command</a></h5>
<pre><code>python manage.py dumpdata coupon.UserCoupon --pks=16,17,18,19,20,21,22,23,24,25,26,27,28 --indent=2 --format=json &gt; flashsale/coupon/fixtures/test.flashsale.coupon.usercoupon.json 
</code></pre>
<hr />
<h5><a class="header" href="#django-limits-of-authority" id="django-limits-of-authority">Django Limits Of Authority</a></h5>
<p><a href="http://www.tuicool.com/articles/RB3yAb">Reference Link</a></p>
<hr />
<h5><a class="header" href="#django-setting-celery-work" id="django-setting-celery-work">Django Setting Celery Work</a></h5>
<p><code>BROKER_URL = 'amqp://linjie:123123@127.0.0.1:5672/vhost1'</code>
<code>python manage.py celery worker -l info</code> </p>
<hr />
<h5><a class="header" href="#django-transaction" id="django-transaction">Django Transaction</a></h5>
<pre><code>@transaction.commit_on_success
@csrf_exempt
def mama_Verify_Action(request):
    mama_id = request.GET.get('id')
</code></pre>
<p><a href="http://blog.sina.com.cn/s/blog_3fe961ae010167ah.html">Referance Link</a></p>
<hr />
<h5><a class="header" href="#django-admin-search_fields" id="django-admin-search_fields">Django Admin: search_fields</a></h5>
<p>django admin search_fields()  # search str in database where search input content</p>
<ol>
<li>search_fields=['first_name', 'last_name'] 
1.1 searches for“ john lennon” 
WHERE (first_name ILIKE '%john%' OR last_name ILIKE '%john%')
AND (first_name ILIKE '%lennon%' OR last_name ILIKE '%lennon%')</li>
<li>search_fields=['^first_name', '^last_name']
2.1
WHERE (first_name ILIKE 'john%' OR last_name ILIKE 'john%')
AND (first_name ILIKE 'lennon%' OR last_name ILIKE 'lennon%')</li>
<li>search_fields=['=first_name', '=last_name']
WHERE (first_name ILIKE 'john' OR last_name ILIKE 'john')
AND (first_name ILIKE 'lennon' OR last_name ILIKE 'lennon')</li>
</ol>
<hr />
<h5><a class="header" href="#get-ip-address" id="get-ip-address">Get Ip Address</a></h5>
<pre><code>def get_client_ip(request):
try:
    real_ip = request.META['HTTP_X_FORWARDED_FOR']
    regip = real_ip.split(&quot;,&quot;)[0]
except:
    try:
        regip = request.META['REMOTE_ADDR']
    except:
        regip = &quot;&quot;
return regip
</code></pre>
<hr />
<h5><a class="header" href="#django-restframework-request-update" id="django-restframework-request-update">Django RestFrameWork Request Update</a></h5>
<pre><code>query dict update : 
request.data.update({&quot;turns_num&quot;: turns_num}) 
# update directly in create method
</code></pre>
<pre><code>request.data._mutable=True 
#  use _mutable to open mutable the request.data in update method
request.data.update({&quot;a&quot;: 123})
request.data._mutable=False # close mutable
</code></pre>
<hr />
<h5><a class="header" href="#auto_now-datetime" id="auto_now-datetime">auto_now datetime</a></h5>
<pre><code>modified = models.DateTimeField(auto_now=True, db_index=True, verbose_name=u'修改日期')
instance.save()	# that will be change the modified field
instance.save(update_fields=['field']) # does not change the modified 
</code></pre>
<hr />
<h5><a class="header" href="#django-querydict-to-dict" id="django-querydict-to-dict">Django QueryDict to Dict</a></h5>
<pre><code>QueryDict.dict()
# fro example in django restframework
request.data.dict()
</code></pre>
<hr />
<h5><a class="header" href="#django-cache" id="django-cache">django cache</a></h5>
<pre><code>
from django.views.decorators.cache import cache_page
from django.http import HttpResponse
import json


@cache_page(10, key_prefix=&quot;test&quot;)
def test_cache(request):
    print (&quot;no cache&quot;)
    return HttpResponse(json.dumps({&quot;device&quot;: 'iphone'}))


def ttt():
    from django.core.cache import cache

    cache.set('my_key', 'hello, world!', 30)  # 缓存key value 缓存时间
    cache.get('my_key')
    cache.add('another_key', 'new value', 30)  # 如果是已经添加过的则返回False 否则添加到缓存并返回True
    cache.get_many(['another_key', 'my_key'])  # 获取多个key
    cache.set_many({'a': 1, 'b': 2, 'c': 3})   # 设置多个key
    cache.delete('a')  # 删除缓存
    cache.delete_many(['a', 'b', 'c'])  # 删除多个缓存
    cache.clear()  # 清楚所有缓存  注意使用

    cache.set('my_key', 'hello world!', version=2)  # 设置版本
    cache.get('my_key')
    cache.get('my_key', version=2)  # 获取对应版本的缓存
    cache.incr_version('my_key', version=2)  # 如果设置了 version的需要指定version升级 否则异常

</code></pre>
<p><a href="https://docs.djangoproject.com/en/1.10/topics/cache/">文档地址</a></p>
<hr />
<h2>layout: post
title: django on_commit
date: 2016-9-25
category: python
tag: django</h2>
<p><strong>摘要:</strong>
在orm提交之后执行一些操作,我们可以使用django 的on_commit.
<a href="https://docs.djangoproject.com/en/1.10/topics/db/transactions/#django.db.transaction.on_commit">官网地址</a>
注意下New in Django 1.9.
有时候你需要安排一些操作与当前的数据库事务相关连,并且是在数据库事务成功完成
之后才能去执行相关的操作,比如说是一个异步任务,一个邮件提示,或者说是缓存过期处理等
因为你不想下一步处理的时候得到的是一个没有处理过的数据的情况发生.</p>
<ul>
<li>code</li>
</ul>
<pre><code>from django.db import transaction

def do_something():
    pass  # send a mail, invalidate a cache, fire off a Celery task, etc.
transaction.on_commit(do_something)

transaction.on_commit(lambda: some_celery_task.delay('arg1'))
</code></pre>
<ul>
<li>如果不是一个有效的数据库事务则会立即执行</li>
<li>如果事务提交的时候出异常了也就是被回滚了,这个func也就会被废弃掉.</li>
</ul>
<hr />
<h2>layout: post
title: django queryset cache
date: 2016-02-05
category: python
tag: django-queryset</h2>
<p><strong>摘要:</strong>
我们在使用django的orm的时候很顺手,但是要注意一下这里的queryset的cache情况,这里
做下笔记.</p>
<ol>
<li>数组切片或者指定index取值的时候是不会使用cache的</li>
</ol>
<pre><code>In [2]: queryset = GovHostInfo.objects.all()
In [3]: print queryset[5]
(0.000) SELECT @@SQL_AUTO_IS_NULL; args=None
(0.000) SELECT `gov_host_info`.`id`, `gov_host_info`.`created`, `gov_host_info`.`modified`, `gov_host_info`.`name`, `gov_host_info`.`host_url`, `gov_host_info`.`purchase_path`, `gov_host_info`.`is_open`, `gov_host_info`.`gov_level`, `gov_host_info`.`memo` FROM `gov_host_info` LIMIT 1 OFFSET 5; args=()
10-金安区人民政府网

In [4]: print queryset[3]
(0.000) SELECT `gov_host_info`.`id`, `gov_host_info`.`created`, `gov_host_info`.`modified`, `gov_host_info`.`name`, `gov_host_info`.`host_url`, `gov_host_info`.`purchase_path`, `gov_host_info`.`is_open`, `gov_host_info`.`gov_level`, `gov_host_info`.`memo` FROM `gov_host_info` LIMIT 1 OFFSET 3; args=()
8-霍邱县人民政府网
</code></pre>
<ol start="2">
<li>第一次遍历的时候不会使用cache</li>
</ol>
<pre><code>In [2]: queryset = GovHostInfo.objects.all()
In [5]: print [g for g in queryset]
(0.001) SELECT `gov_host_info`.`id`, `gov_host_info`.`created`, `gov_host_info`.`modified`, `gov_host_info`.`name`, `gov_host_info`.`host_url`, `gov_host_info`.`purchase_path`, `gov_host_info`.`is_open`, `gov_host_info`.`gov_level`, `gov_host_info`.`memo` FROM `gov_host_info`; args=()
[&lt;GovHostInfo: 5-舒城县人民政府网&gt;, &lt;GovHostInfo: 6-霍山县人民政府网&gt;, &lt;GovHostInfo: 7-寿县人民政府网&gt;, &lt;GovHostInfo: 8-霍邱县人民政府网&gt;, &lt;GovHostInfo: 9-金寨县人民政府网&gt;, &lt;GovHostInfo: 10-金安区人民政府网&gt;, &lt;GovHostInfo: 11-裕安区人民政府网&gt;, &lt;GovHostInfo: 12-金安区政府采购网&gt;]

In [6]: print [g for g in queryset]
[&lt;GovHostInfo: 5-舒城县人民政府网&gt;, &lt;GovHostInfo: 6-霍山县人民政府网&gt;, &lt;GovHostInfo: 7-寿县人民政府网&gt;, &lt;GovHostInfo: 8-霍邱县人民政府网&gt;, &lt;GovHostInfo: 9-金寨县人民政府网&gt;, &lt;GovHostInfo: 10-金安区人民政府网&gt;, &lt;GovHostInfo: 11-裕安区人民政府网&gt;, &lt;GovHostInfo: 12-金安区政府采购网&gt;]

In [7]: print queryset[3]  # 注意这里 是从cache中获取的
8-霍邱县人民政府网
</code></pre>
<ol start="3">
<li>if会触发执行sql</li>
</ol>
<pre><code>In [14]: queryset = GovHostInfo.objects.all()

In [15]: if queryset:
    ...:     print 'yes'
    ...:     
(0.001) SELECT `gov_host_info`.`id`, `gov_host_info`.`created`, `gov_host_info`.`modified`, `gov_host_info`.`name`, `gov_host_info`.`host_url`, `gov_host_info`.`purchase_path`, `gov_host_info`.`is_open`, `gov_host_info`.`gov_level`, `gov_host_info`.`memo` FROM `gov_host_info`; args=()
yes

In [16]: if queryset:  # 第一次之后则使用cache
    ...:     print 'yes'
    ...:     
yes

</code></pre>
<ol start="4">
<li>使用exists来判断存在</li>
</ol>
<pre><code>In [17]: queryset = GovHostInfo.objects.all()

In [18]: if queryset.exists():
    ...:     print 'yes'
    ...:     
(0.000) SELECT (1) AS `a` FROM `gov_host_info` LIMIT 1; args=()
yes

</code></pre>
<ol start="5">
<li>使用iterator避免cache</li>
</ol>
<pre><code>In [19]: queryset = GovHostInfo.objects.all()

In [20]: for g in queryset.iterator():
    ...:     print g
    ...:     
(0.000) SELECT `gov_host_info`.`id`, `gov_host_info`.`created`, `gov_host_info`.`modified`, `gov_host_info`.`name`, `gov_host_info`.`host_url`, `gov_host_info`.`purchase_path`, `gov_host_info`.`is_open`, `gov_host_info`.`gov_level`, `gov_host_info`.`memo` FROM `gov_host_info`; args=()
5-舒城县人民政府网
6-霍山县人民政府网
7-寿县人民政府网
8-霍邱县人民政府网
9-金寨县人民政府网
10-金安区人民政府网
11-裕安区人民政府网
12-金安区政府采购网

In [21]: for g in queryset.iterator():
    ...:     print g
    ...:     
(0.001) SELECT `gov_host_info`.`id`, `gov_host_info`.`created`, `gov_host_info`.`modified`, `gov_host_info`.`name`, `gov_host_info`.`host_url`, `gov_host_info`.`purchase_path`, `gov_host_info`.`is_open`, `gov_host_info`.`gov_level`, `gov_host_info`.`memo` FROM `gov_host_info`; args=()
5-舒城县人民政府网
6-霍山县人民政府网
7-寿县人民政府网
8-霍邱县人民政府网
9-金寨县人民政府网
10-金安区人民政府网
11-裕安区人民政府网
12-金安区政府采购网

</code></pre>
<hr />
<h2>layout: post
title: django 信号
date: 2015-06-10
category: python
tag: django</h2>
<p><strong>摘要:</strong>
django中提供了信号机制,可以很好的起到解耦的作用这里笔记一两点使用过程中需要
注意的地方, 比如执行顺序啦.建议在编写信号的代码的时候,写到model下面,这样便于
阅读代码,使得代码容易codereview,并且在团队开发的过程中更容易发现,以免不必要的
麻烦.因为之前有写过在别的地方connect了一个model的信号.导致debug过程中很难找到
原因.还有就是尽量减少使用signal的使用.因为很多情况下发出的信号不知道有哪些
function去connect了.一定要知道自己在干什么.
如果一定要使用的话尽量减少connect.</p>
<ul>
<li>代码演示</li>
</ul>
<pre><code>from django.db.models.signals import post_save
import time

def bbb(sender, instance, created, raw, **kwargs):
    print('call bbb')

def aaa(sender, instance, created, raw, **kwargs):
    print('call aaa')
    time.sleep(3)
    print('sleep done')

post_save.connect(aaa, sender=ModelName, dispatch_uid='post_save_bbb')
post_save.connect(bbb, sender=ModelName, dispatch_uid='post_save_aaa')

</code></pre>
<ul>
<li>执行结果</li>
</ul>
<pre><code>(u'call aaa')
sleep done
(u'call bbb')
</code></pre>
<ul>
<li>使用receivers来查看信号接收的function</li>
</ul>
<pre><code>In [5]: from django.db.models.signals import post_save
In [6]: post_save.receivers
[((u'post_save_bbb', 38420912),
          &lt;weakref at 0x7f62fb927998; to 'function' at 0x7f62fb8c7848 (aaa)&gt;),
     ((u'post_save_aaa', 38420912),
        &lt;weakref at 0x7f62fb9279f0; to 'function' at 0x7f62fb8c77d0 (bbb)&gt;)]
</code></pre>
<p>**注意:**这里我故意将dispatch_uid给调换了</p>
<ul>
<li>总结</li>
</ul>
<p>信号的执行顺序是按照connect的先后执行的.</p>
<hr />
<h2>layout: post
title: Django SQL debug工具
date: 2016-03-07
category: python
tag: django</h2>
<p><strong>摘要:</strong>
在django开发过程当中会涉及到sql语句的查看,第一个方法可以在shell里面print query
第二个方法是在console中log出执行的sql语句,第三个方法可以安装django-debug-toolbar.
查看什么时候执行了那些sql语句,有助于代码的优化和编码思路的提高.</p>
<h5><a class="header" href="#在setting中配置log" id="在setting中配置log">在setting中配置log</a></h5>
<pre><code>LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'handlers': {
    'console':{
        'level':'DEBUG',
        'class':'logging.StreamHandler',
        },
    },
    'loggers': {
    'django.db.backends': {
        'handlers': ['console'],
        'propagate': True,
        'level':'DEBUG',
        },
    }
}
</code></pre>
<h5><a class="header" href="#安装配置django-debug-toolbar" id="安装配置django-debug-toolbar">安装配置django-debug-toolbar</a></h5>
<p><a href="https://github.com/jazzband/django-debug-toolbar">github</a>
<a href="https://django-debug-toolbar.readthedocs.io/en/stable/index.html">django-debug-toolbar</a></p>
<hr />
<h2>layout: post
title: excel处理
date: 2016-07-22
category: python
tag: excel lib</h2>
<p><strong>摘要:</strong>
工作中有需要使用excel的场合,python中有很多excel的处理包,这里使用的是xlrd
记录下一些常用的方法,方便以后查阅.</p>
<h4><a class="header" href="#依赖包" id="依赖包">依赖包</a></h4>
<p>sudo pip install xlrd</p>
<p>sudo pip install xlwt</p>
<p>sudo pip install xlsxwriter</p>
<h4><a class="header" href="#get-csv-picture-and-save-it-to-excel" id="get-csv-picture-and-save-it-to-excel">get csv picture and save it to excel</a></h4>
<pre><code># coding=utf-8
import os
import sys
import xlsxwriter
import xlrd
import xlwt
import urllib2
import csv
import time

reload(sys)
sys.setdefaultencoding('utf8')  # 中文问题处理

&quot;&quot;&quot;
## 处理csv 文件中图片链接显示问题（生成excel文件，保存图片）

- 打开指定的csv 文件
- 读取一行　记录　
- 获取　记录列中地址图片　并保存
- 将记录和　图片组装　添加到excel 中
- 删除本地保存的图片
&quot;&quot;&quot;
def download_img(file_dir, img_url, img_name=None):
    if os.path.exists(file_dir):
        abs_dir = os.path.abspath(file_dir)
    else:
        os.makedirs(r'%s/%s' % (os.getcwd(), file_dir))
        abs_dir = os.path.abspath(file_dir)
    img_name = &quot;%s/%s&quot; % (abs_dir, img_name)
    if img_url.startswith('//'):
        img_url = 'http:' + img_url
    try:
        data = urllib2.urlopen(img_url, timeout=3).read()
        file = open(img_name, &quot;wb&quot;)
        file.write(data)
        file.close()
    except IOError as e:
        print e.message
        return '/home/jishu_linjie/Desktop/tmp/unget.png'
    except ValueError as e:
        print e.message
        return '/home/jishu_linjie/Desktop/tmp/unget.png'
    return os.path.abspath(file.name)  # 返回绝对路径


def write_to_excel(file_name, collect_data):
    workbook = xlsxwriter.Workbook(file_name)
    worksheet = workbook.add_worksheet()
    count = 0
    for item in collect_data:
        count += 1
        index_s = str(count)
        if item[0]:
            worksheet.insert_image('A' + index_s,  # 指定单元格
                                   item[0],  # 图片地址
                                   {'x_offset': 1,  # x_offset 设置偏移量
                                    'y_offset': 1,
                                    'x_scale': 0.2,  # x_scale  设置图片缩放
                                    'y_scale': 0.2})
        else:
            worksheet.write('A' + index_s, 'img')
        worksheet.write('B' + index_s, item[1])
        worksheet.write('C' + index_s, item[2])
        worksheet.write('D' + index_s, item[3])  # 图片链接
        worksheet.write('E' + index_s, item[4])  # 产品名称
        worksheet.write('F' + index_s, item[5])
    worksheet.set_column('A:A', 17)  # 设置列宽
    # 设置行高

    for i in xrange(count):
        if i == 0:
            continue
        worksheet.set_row(i, 125)
    workbook.close()


def main(fname):
    print(u&quot;You file name is :%s&quot; % fname)
    reader = csv.reader(file(fname, 'rb'))
    collect_data = []
    try:
        count = 0
        while True:
            item = reader.next()  # 使用迭代器输出
            # item= ['822292480043',
            #  '15372',
            #  'http://www.hh.com/MG_1466576587583.jpg',
            #  '\xe6\xb0\xb4\xe5\xa2\xa8\xe5\x8d\xb0\xe8\x8a\xb1\xe8\x88\x92\xe9\x80\x82\xe4\xb8\x89\xe4\xbb\xb6\xe5\xa5\x97/\xe7\x99\xbd\xe8\x89\xb2',
        
            img_name = ''
            if count != 0:
                img_url = item[2]
                img_name = '_'.join([str(fname).split('.')[0], str(count)]) + '.jpg'
                file_dir = str(fname).split('.')[0] + '_imgs'
                img_name = download_img(file_dir, img_url, img_name=img_name)
            count += 1
            collect_data.append([img_name,
                                 item[0],
                                 item[1],
                                 item[2],
                                 item[3],
                                 item[4]])
    except StopIteration:
        print(u&quot;文件读取完毕!&quot;)
        write_to_excel(str(fname).split('.')[0] + '.xlsx', collect_data)


if __name__ == '__main__':
    fname = sys.argv[1]
    if not os.path.isfile(fname):
        print (u'文件没有找到！')
        if True:
            time.sleep(1)  # 程序暂停1秒　这里没有意义　写着玩
        sys.exit()
    else:
        main(fname)

</code></pre>
<hr />
<h2>layout: post
title: ipdb 常用命令
date: 2016-01-014
category: python
tag: debug</h2>
<p><strong>摘要</strong>
程序开发的过程中少不了需要debug场景,Python可以使用pdb或者ipd来调试,
ipdb需要自己安装下包,其中tab使用非常方便,这里笔记下一些常用的调试
命令.</p>
<h4><a class="header" href="#ipdb调试常用命令" id="ipdb调试常用命令">ipdb调试常用命令</a></h4>
<ol>
<li>python -m ipdb xxx.py 逐行调试</li>
<li>断点调试</li>
</ol>
<pre><code>import ipdb
ipdb.set_trace()
</code></pre>
<h4><a class="header" href="#命令行" id="命令行">命令行</a></h4>
<ul>
<li>h, 帮助</li>
<li>l &lt;行号&gt;, 查看代码指定行开始的后11行,行号默认为当前行</li>
<li>p &lt;变量&gt;, 打印变量</li>
<li>ENTER, 重复上次命令</li>
<li>q, 退出</li>
<li>n, 执行下一句</li>
<li>c, 继续执行</li>
<li>s, 进入子程序</li>
<li>r, 继续执行，直到函数体return语句</li>
<li>!&lt;python 命令&gt;, 执行python命令</li>
<li>a, 打印当前函数的参数</li>
<li>j, 让程序跳转到当前代码块的指定行</li>
<li>w, 当前执行位置</li>
</ul>
<p><a href="http://blog.csdn.net/lengyisheng/article/details/18254763">推荐链接</a></p>
<hr />
<h2>layout: post
title: python代码静态检查
date: 2016-06-22
category: python
tag: mypy</h2>
<p><strong>摘要:</strong>
众所周知,Python是一门动态语言,具体解释我就不说了,动态语言有个问题是不做类型检查.
在自己开发或者持续集成过程使用mypy可以降低程序的bug数量,代码更健壮,有时候可以提高
代码的阅读效果.</p>
<h4><a class="header" href="#代码静态检查顺序" id="代码静态检查顺序">代码静态检查顺序</a></h4>
<p>默认情况mypy先检查定义的函数和返回，然后检查函数内调用的函数定义和返回，最后检查引用包。</p>
<ol>
<li>mypy --py2  manage.py flashsale/coup  # 指定目录检查（python2）</li>
</ol>
<ul>
<li><a href="http://mypy-lang.org/">网址</a></li>
<li><a href="https://github.com/python/mypy">GitHub</a></li>
<li><a href="http://mypy.readthedocs.io/en/latest/python2.html">参考文档</a></li>
</ul>
<hr />
<h2>layout: post
title: numpy笔记
date: 2016-08-31
category: python
tag: numpy</h2>
<p><strong>摘要:</strong>
一直想抽空学习numpy,想用numpy做一些数据分析,比如说哪个妹子跟好看呀!
numpy使用c和c++开发的python数据处理计算分析库,在数据挖掘和分析领域
很受欢迎,也有一些其他的python库是基于numpy开发的,比如说pandas.有很多
没来得及记录下来,下次学习的时候顺便补上学习内容.</p>
<h4><a class="header" href="#vwap-成交量加权平均价格" id="vwap-成交量加权平均价格">VWAP: 成交量加权平均价格</a></h4>
<p>某个价格成交量越高，该价格所占的权重就越大；成交量为权重计算出来的加权平均值。</p>
<h4><a class="header" href="#twap-时间加权平均价格" id="twap-时间加权平均价格">TWAP: 时间加权平均价格</a></h4>
<p>最近的数值（价格）重要性要大些，具体问题具体分析。</p>
<h4><a class="header" href="#最大值和最小值" id="最大值和最小值">最大值和最小值</a></h4>
<pre><code>import numpy as np

c, v = np.loadtext('data.csv', delimiter=',', usecols=(4, 5), unpack=True)

# 加权平均值
vwap = np.average(c, weights=v)  

# 算数平均值
mean = np.mean(c) 

# 时间加权平均值

t = np.arange(len(c))  # 加权方式
twap = np.average(c, weights=t)

# 最大值和最小值
h, l = np.loadtxt('yahoofinacedata/table.csv', delimiter=',', usecols=(3, 4), unpack=True)


</code></pre>
<ul>
<li><a href="http://www.numpy.org/">网址</a></li>
</ul>
<hr />
<h2>layout: post
title: Python Object的继承差异
date: 2015-01-07
category: python
tag: python</h2>
<p><strong>摘要:</strong>
在Python经常使用的class继承问题并没有弄的清楚,这里做一些记录备忘.
在Python2.2之后引入了继承object的新式类,在Python3里面这些得到了统一即使不去继承object也是一样的新式类的效果.</p>
<h5><a class="header" href="#python27" id="python27">Python2.7</a></h5>
<ol>
<li>不继承object</li>
</ol>
<pre><code>&gt;&gt;&gt; class A:
...     pass
... 
&gt;&gt;&gt; type(A)
&lt;type 'classobj'&gt;
&gt;&gt;&gt; dir(A)
['__doc__', '__module__']
&gt;&gt;&gt; a = A()
&gt;&gt;&gt; type(a)
&lt;type 'instance'&gt;
&gt;&gt;&gt; dir(a)
['__doc__', '__module__']
&gt;&gt;&gt; 

</code></pre>
<ol start="2">
<li>继承object</li>
</ol>
<pre><code>&gt;&gt;&gt; class B(object):
...     pass
... 
&gt;&gt;&gt; type(B)
&lt;type 'type'&gt;
&gt;&gt;&gt; dir(B)
['__class__', '__delattr__', '__dict__', '__doc__', '__format__', '__getattribute__', '__hash__', '__init__', '__module__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__str__', '__subclasshook__', '__weakref__']
&gt;&gt;&gt; b = B()
&gt;&gt;&gt; type(b)
&lt;class '__main__.B'&gt;
&gt;&gt;&gt; dir(b)
['__class__', '__delattr__', '__dict__', '__doc__', '__format__', '__getattribute__', '__hash__', '__init__', '__module__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__str__', '__subclasshook__', '__weakref__']
&gt;&gt;&gt; 

</code></pre>
<h5><a class="header" href="#python35" id="python35">Python3.5</a></h5>
<ol>
<li>不继承object</li>
</ol>
<pre><code>&gt;&gt;&gt; class A:
...     pass
... 
&gt;&gt;&gt; type(A)
&lt;class 'type'&gt;
&gt;&gt;&gt; dir(A)
['__class__', '__delattr__', '__dict__', '__dir__', '__doc__', '__eq__', '__format__', '__ge__', '__getattribute__', '__gt__', '__hash__', '__init__', '__le__', '__lt__', '__module__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__str__', '__subclasshook__', '__weakref__']
&gt;&gt;&gt; 
&gt;&gt;&gt; a = A()
&gt;&gt;&gt; type(a)
&lt;class '__main__.A'&gt;
&gt;&gt;&gt; dir(a)
['__class__', '__delattr__', '__dict__', '__dir__', '__doc__', '__eq__', '__format__', '__ge__', '__getattribute__', '__gt__', '__hash__', '__init__', '__le__', '__lt__', '__module__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__str__', '__subclasshook__', '__weakref__']
&gt;&gt;&gt; 
</code></pre>
<ol start="2">
<li>继承object</li>
</ol>
<pre><code>&gt;&gt;&gt; class B(object):
...     pass
... 
&gt;&gt;&gt; type(B)
&lt;class 'type'&gt;
&gt;&gt;&gt; dir(B)
['__class__', '__delattr__', '__dict__', '__dir__', '__doc__', '__eq__', '__format__', '__ge__', '__getattribute__', '__gt__', '__hash__', '__init__', '__le__', '__lt__', '__module__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__str__', '__subclasshook__', '__weakref__']
&gt;&gt;&gt; 
&gt;&gt;&gt; b = B()
&gt;&gt;&gt; type(b)
&lt;class '__main__.B'&gt;
&gt;&gt;&gt; dir(b)
['__class__', '__delattr__', '__dict__', '__dir__', '__doc__', '__eq__', '__format__', '__ge__', '__getattribute__', '__gt__', '__hash__', '__init__', '__le__', '__lt__', '__module__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__str__', '__subclasshook__', '__weakref__']
&gt;&gt;&gt; 
</code></pre>
<hr />
<h2>layout: post
title: Python性能优化
date: 2016-03-05
category: python
tag: python</h2>
<p><strong>摘要:</strong>
编程的代码总有一些目的,达到目的总有一些方法;所谓条条大路通罗马.
有写效率很高,有些效率可以,有些则效率很差.编程的方法不一样而已,当然
这个取决于一个人的编程水准和经验,日积月累.这里做些点滴记录用备忘.</p>
<p>当然在处理一些特定的问题的时候就不仅仅是代码本身的优化了,而是要选择合适的
工具了,君子善假于物也!比如在进行大规模的数组运算的时候很可能叫借助numpy来
处理,方便开发的同时也提高代码的执行效率.</p>
<p>软件新版本使用;新版本会解决一些已知的旧版本代码bug会提升代码的稳定性,可能会增加
一些新的feture提高开发效率,还有在新版本可能在代码层级有过优化处理来提高代码
的执行效率.</p>
<p>新框架使用也可以提高代码的执行效率,比如说django的执行效率就不是太高,换做是
<a href="https://github.com/channelcat/sanic">sanic</a>就不一样的感觉了.当然使用新的框架
,这要学习新的东西,有一定的启动成本,新的框架不一定适应当前的项目;有很多的
问题等等.</p>
<p>新语言开发,追逐效率的话;在web开发来看目前go语言是个佼佼者.首先他是静态编译
执行的,效率方面比动态语言本身就有优势.目前的库也基本齐全了,推荐的框架也比较多,比如
很受欢迎的<a href="https://beego.me/docs/intro/">beego</a>和<a href="https://github.com/go-martini/martini">martini</a>
等等.当然用go开发效率比python要慢是可以肯定的.如果项目要更换的话学习go是一方面
成本,在整个项目的运维上也会有一定的调整,与之增加的成本也会相对较高.</p>
<p>内容太多,这里仅仅聊一聊具体的python代码层级的优化;不聊其他的内容.</p>
<h4><a class="header" href="#算法时间复杂度优化" id="算法时间复杂度优化">算法时间复杂度优化</a></h4>
<p>复杂度越低执行效率越高:
<code>O(1) &gt; O(lg n) &gt; O(n lg n) &gt; O(n^2) &gt; O(n^3) &gt; O(n^k) &gt; O(k^n) &gt; O(n!)</code></p>
<h4><a class="header" href="#使用合适的关键词" id="使用合适的关键词">使用合适的关键词</a></h4>
<ol>
<li>xrange的效率比range好,当然要多写一个'x';</li>
<li>dict 的hash table比list访问成员数据好(空间换时间);</li>
<li>字符串链接中使用join比'+'好;</li>
<li>使用ifilter比filter好;</li>
</ol>
<h4><a class="header" href="#合理使用一些包" id="合理使用一些包">合理使用一些包</a></h4>
<p>比如说copy和deepcopy的效率就有差异,如果不涉及两者的区别我们尽量使用效率高的copy来
处理数据.</p>
<h4><a class="header" href="#调整代码习惯" id="调整代码习惯">调整代码习惯</a></h4>
<ol>
<li>使用Lazy if-evaluationd;</li>
<li>使用in关键子;</li>
<li>使用格式化输出;</li>
<li>不使用中间变量;</li>
<li>使用if在列表中取舍;</li>
<li>使用生成器表达式</li>
</ol>
<h4><a class="header" href="#使用工具分析性能" id="使用工具分析性能">使用工具分析性能</a></h4>
<ol>
<li>ipython 中的%timeit -n来简单的检查语句的运行时间</li>
<li>使用profile模块分析性能瓶颈</li>
</ol>
<h4><a class="header" href="#性能优化工具" id="性能优化工具">性能优化工具</a></h4>
<ol>
<li><a href="http://psyco.sourceforge.net/">Psyco</a></li>
<li><a href="http://pypy.org/">Pypy</a></li>
</ol>
<p>在实际开发中性能优化的意识还是来源于自己平时经验的积累,有时候是一些习惯的积累;
在遇到具体了类似到性能分析的时候还是很少的情况;除非是一个很重要的功能;大家都把
他推到台面上来说;当然一个优秀的程序员要有自觉的意识去改变那些自己可以改变的代码
让他们变得更高效;代码优化也有一定的时机,在项目紧锣密鼓的开发阶段,能最快的实现功能
并上线使用是很多创业公司追求的目标,因为这个可以抢占市场的先机;关系到代码细枝末节
的优化还是要放到后面的过程中进行,要不然就本末倒置了.主要还是一些权衡的考虑
这些问题.不能一概而论!</p>
<p><a href="https://www.ibm.com/developerworks/cn/linux/l-cn-python-optim/">参考链接</a></p>
<hr />
<h2>layout: post
title: Pyton Unittest 小记
category: python
tag: test
date: 2017-02-01</h2>
<p><strong>摘要:</strong>
个人觉得测试在项目的进行中是很重要的.
好的测试代码可以减少上线前的bug数量,提高项目的稳定性.
还可以给持续集成作为铺垫;同样一份好的测试代码还可以当做一份好的文档来使用;
在测试代码上面花去的时间是有价值,并且不是单方面的测试价值,还有整个项目整体价值的提升.
大量的黑盒测试不单消耗人力物力还很浪费时间且没有重复利用的空间.</p>
<h4><a class="header" href="#test-case" id="test-case">test case</a></h4>
<p>通过继承unittest的TestCase可以实现一个测试或者一组测试代码
测试方法必须是test开头.</p>
<pre><code>import unittest

class TestExample(unittest.TestCase):
    def test_one_is_one(self):
        self.assertEqual(1, 1)

    def test_two_is_two(self):
        self.assertEqual(2, 1)

if __name__ == '__main__':
    unittest.main()

</code></pre>
<h4><a class="header" href="#命令行执行test" id="命令行执行test">命令行执行test</a></h4>
<p><code>python -m unittest -h</code></p>
<p>其中可以制定测试的模块,指定测试的方法和测试类.</p>
<h4><a class="header" href="#test-fixtures" id="test-fixtures">test fixtures</a></h4>
<p>固定装置的测试,防止重复代码,准备测试环境,测试完成清理.</p>
<pre><code>import unittest

class TestExample(unittest.TestCase):

    @classmethod
    def setUpClass(cls):
        cls.database = 'mysql'

    def test_db(self):
        self.assertEqual(self.database, 'mysql')


    @classmethod
    def tearDownClass(cls):
        cls.clean = True

if __name__ == '__main__':
    unittest.main()
</code></pre>
<h4><a class="header" href="#test-suite" id="test-suite">test suite</a></h4>
<p>测试套件, 用来组装你需要的测试代码,有些情况并不是所有的测试代码都要执行.
可以使用test suite来处理.</p>
<pre><code># tt is a module, test_upper is a test case func

suite = unittest.TestSuite(map(tt.TestString, ['test_upper']))
suite.addTest(tt.TestString.test_upper)
# 可以使用addTest往测试套件中添加测试方法
suite = unittest.TestLoader().loadTestsFromTestCase(tt.TestString)
# 使用TestLoader实例化后方法loadTestsFromTestCase来将指定的
# testcase类中方法全部导入
</code></pre>
<h4><a class="header" href="#跳过测试" id="跳过测试">跳过测试</a></h4>
<pre><code>@unittest.skipIf(1==1, '1 == 1') 
def test_skipif(self):
    print 'if has skip decorator this not be print'
</code></pre>
<h4><a class="header" href="#runner" id="runner">runner</a></h4>
<p>实例化runner运行测试组件</p>
<pre><code>runner = unittest.runner.TextTestRunner()
runner.run(suite)
</code></pre>
<h4><a class="header" href="#test-discover" id="test-discover">test discover</a></h4>
<p>测试方法的发现.
可以通过discover发现测试的项目中的testcase, 指定测试代码目录.
如果存在多级包目录的话建议添加top_level_dir,注意一定要有&quot;<strong>init</strong>.py&quot;的才可以发现
的testcase.</p>
<pre><code>test_dir = 'path_to_pro'
suite = unittest.defaultTestLoader.discover(test_dir, top_level_dir='path_to_top')

</code></pre>
<hr />
<h2>layout: post
title: request基础笔记
category: http
tag: requests
date: 2016-12-27</h2>
<p><strong>摘要:</strong>
平时使用requests模块的基础内容,多用在爬虫或者http请求当中.</p>
<p><a href="http://docs.python-requests.org/zh_CN/latest/user/quickstart.html">Reques</a>
<a href="https://zh.wikipedia.org/zh/HTTP%E7%8A%B6%E6%80%81%E7%A0%81">状态码</a></p>
<h5><a class="header" href="#基础使用" id="基础使用">基础使用</a></h5>
<pre><code>#coding=utf-8
import json
import requests
from requests import exceptions

URL = 'https://api.github.com'

def build_uri(endpoint):
    return '/'.join([URL, endpoint])

def better_print(json_str):
    return json.dumps(json.loads(json_str), indent=4)

def request_method():
    response = requests.get(build_uri('users/ahlinjie'))
    print better_print(response.text)

def params_request():
    response = requests.get(build_uri('users'), params={'since': 11})
    print better_print(response.text)
    print response.request.headers
    print response.url


def timeout_request():
    try:
        response = requests.get(build_uri('user/emails'), timeout=10)
        response.raise_for_status() # 状态码异常处理
    except exceptions.Timeout as e:
        print e.message
    except exceptions.HTTPError as e:
        print e.message
    else:
        print response.text
        print response.status_code

def hard_request():
    &quot;&quot;&quot;
    自定义request
    &quot;&quot;&quot;
    from requests import Request, Session

    s = Session()
    headers = {'User-Agent': 'fake1.3.4'}
    req = Request('GET', build_uri('users/ahlinjie'), headers=headers)
    prepped = req.prepare()
    print prepped.body
    print prepped.headers
    
    # 发送请求
    resp = s.send(prepped, timeout=5)
    print resp.status_code
    print resp.request.headers
    print resp.text
    
</code></pre>
<h5><a class="header" href="#下载图片的两种方法" id="下载图片的两种方法">下载图片的两种方法</a></h5>
<ol>
<li>方法1</li>
</ol>
<pre><code>def download_image():
    url = 'http://img3.imgtn.bdimg.com/it/u=2228635891,3833788938&amp;fm=21&amp;gp=0.jpg'
    headers = {'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/55.0.2883.87 Safari/537.36'}
    # headers 不管用还是403
    headers_1 = {'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/55.0.2883.87 Safari/537.36','Referer': 'https://www.baidu.com'}
    # 经过测试 这里需要在headers 中添加Referer 并且是一个可以访问的

    response = requests.get(url, headers=headers_1, stream=True)
    print response.status_code # 403
    with open('demo.jpg', 'wb') as fd:
        for chunk in response.iter_content(128):
            fd.write(chunk)
</code></pre>
<ol start="2">
<li>方法2</li>
</ol>
<pre><code>def download_img_improved():
    # 伪造headers信息
    headers = {'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/55.0.2883.87 Safari/537.36','Referer': 'https://www.baidu.com'}

    # 图片地址
    url = 'http://img3.imgtn.bdimg.com/it/u=2228635891,3833788938&amp;fm=21&amp;gp=0.jpg'

    from contextlib import closing
    
    # 及时关闭释放stream占用的资源
    with closing(requests.get(url, headers=headers, stream=True)) as response:
        # 写入文件
        with open('demo1.jpg', 'wb') as fd:
            # 每128个字节写入一次
            for chunk in response.iter_content(128):
                fd.write(chunk)
</code></pre>
<h5><a class="header" href="#hook回调" id="hook回调">hook回调</a></h5>
<pre><code>def get_key_info(response, *args, **kwargs):
    # 回调执行
    print response.headers['Content-Type']

def event_hooks():
    requests.get('https://www.baidu.com', hooks=dict(response=get_key_info))

</code></pre>
<h5><a class="header" href="#oauth认证" id="oauth认证">oauth认证</a></h5>
<pre><code>from requests.auth import AuthBase


class GithubOauth(AuthBase):
    def __init__(self, token):
        self.token = token

    def __call__(self, r):
        r.headers['Authorization'] = ' '.join(['token', self.token])
        return r


def oauth_advanced():
    github_token = ''  # 在自己的github setting 中生成一个
    auth = GithubOauth(github_token)
    response = requests.get(build_uri('user/emails'), auth=auth)
    print response.text

</code></pre>
<pre><code>import base64
base64.b64decode('')  #这里的字符串是一般的基础验证的利用base64编码的字符串
# 使用b64decode就可以查看编码前的信息了
</code></pre>
<h5><a class="header" href="#requests学习工具" id="requests学习工具">requests学习工具</a></h5>
<pre><code>gunicorn==19.6.0
httpbin==0.5.0
requests==2.12.5

</code></pre>
<p>启动学习使用的服务器:
gunicorn httpbin:app</p>
<hr />
<h2>layout: post
title: 定时爬虫任务实验
date: 2016-10-05
category: python
tag: scrapy</h2>
<p><strong>摘要:</strong>
最近有个自己写代码需求,就是需要定时执行爬虫任务去爬去网页的信息,写在这里做备忘.
使用的是scrapy和django,其实里面的item还是很好用的有空可以深入研究下.django配合
python-scrapyd-api触发scrapyd爬虫服务器执行爬虫代码,django-celery-beat来做定时
还是很方便的.</p>
<h4><a class="header" href="#打包爬虫代码提交到爬虫服务器" id="打包爬虫代码提交到爬虫服务器">打包爬虫代码提交到爬虫服务器</a></h4>
<ol>
<li>
<p>安装setuptools
wget https://bootstrap.pypa.io/ez_setup.py -O - | python
<a href="https://pypi.python.org/pypi/setuptools">参考网址</a></p>
</li>
<li>
<p>egg打包方法：
<a href="http://setuptools.readthedocs.io/en/latest/setuptools.html">参考网址</a></p>
</li>
<li>
<p>添加setup.py文件到项目目录中
编辑该文件：</p>
</li>
</ol>
<pre><code>from setuptools import setup, find_packages

setup(
            name=&quot;govbuyscrapy&quot;,
                version=&quot;0.1&quot;,
                    packages=find_packages(),
                        entry_points={'scrapy': ['settings = govbuyscrapy.settings']},
                            # to make sure scrapyd can import you &quot;scrapy&quot; package and set you project setting file
     )
</code></pre>
<ol start="4">
<li>
<p>打包项目生成egg文件
4.1 python setup.py bdist_egg 将会在dist目录生成egg文件
4.2 python setup.py bdist 是生成tar.ge文件但是不生成egg文件</p>
</li>
<li>
<p>像scrapyd服务器提交爬虫项目
curl http://localhost:6800/addversion.json -F project=govbuyscrapy -F version=0.1 -F egg=@govbuyscrapy-0.1-py2.7.egg
在终端看到下面的表示提交成功
{&quot;status&quot;: &quot;ok&quot;, &quot;project&quot;: &quot;govbuyscrapy&quot;, &quot;version&quot;: &quot;0.1&quot;, &quot;spiders&quot;: 3, &quot;node_name&quot;: &quot;jeep&quot;}</p>
</li>
<li>
<p>测试执行爬虫
命令scrapyd服务器执行指定爬虫 
curl http://localhost:6800/schedule.json -d project=govbuyscrapy -d spider=govbuy_wan_huoshan
执行结果:
{&quot;status&quot;: &quot;ok&quot;, &quot;jobid&quot;: &quot;0c838fd4b9f111e6abcc14dda97ae760&quot;, &quot;node_name&quot;: &quot;jeep&quot;}
可以在浏览器里面(爬虫服务器)查看执行结果和log记录
http://localhost:6800/jobs</p>
</li>
</ol>
<h4><a class="header" href="#在django项目中使用python-scrapyd-api来操作爬虫的活动" id="在django项目中使用python-scrapyd-api来操作爬虫的活动">在django项目中使用python-scrapyd-api来操作爬虫的活动</a></h4>
<ol>
<li>
<p>安装python-scrapyd-api
pip install -i http://pypi.douban.com/simple/ python-scrapyd-api  --trusted-host pypi.douban.com
<a href="https://pypi.python.org/pypi/python-scrapyd-api#downloads">参考文档地址</a>
这里有一个奇怪的事情： 我以为每次改动爬虫项目代码的之后倒要去打包生成新的egg并上
传到scrapyd服务器，但是没有这样做新写的代码也生效了</p>
</li>
<li>
<p>安装rabbitmq（消息队列）
http://www.rabbitmq.com/download.html  下载deb点击安装即可(ubuntu系统)</p>
</li>
<li>
<p>了解下celery（任务队列）
任务队列是一种在线程或机器间分发任务的机制。
消息队列的输入是工作的一个单元，称为任务，独立的职程（Worker）进程持续监视队列中
是否有需要处理的新任务。Celery 用消息通信，通常使用中间人（Broker）在客户端和职程
间斡旋。这个过程从客户端向队列添加消息开始，之后中间人把消息派送给职程。
Celery 系统可包含多个职程和中间人，以此获得高可用性和横向扩展能力。
3.1 启动celery :
<code>celery -A gadmin worker -B -l info</code> # 注意部署的时候不要使用 -l info  -B表示 --beat
<strong>注意:</strong> celery 4.0 开始支持定时任务了 不需要djcelery</p>
</li>
</ol>
<p>3.2 在项目目录添加tasks包（含__init__.py）
3.3 添加配置文件celerycfg.py
<code>CELERY_IMPORTS = (&quot;tasks&quot;,) CELERY_TASK_RESULT_EXPIRES = 300</code>
3.4 import到django项目setting.py中
可以在shell中执行测试的task.delay()</p>
<h4><a class="header" href="#定时任务" id="定时任务">定时任务</a></h4>
<p><a href="https://github.com/celery/django-celery-beat">参考网址</a></p>
<ol>
<li>安装django-celery-beat
<code>pip install -U django-celery-beat</code></li>
<li>添加install_app到django INSTALL_APPS中</li>
<li>创建数据库表
<code>python manage.py migrate</code></li>
</ol>
<hr />
<h2>layout: post
title: python代码片段
date: 2015-9-28
category: python
tag: python</h2>
<p><strong>摘要:</strong>
Python代码片段摘抄,一些基础内容和一些常用的脚本,方便以后使用查阅.</p>
<h4><a class="header" href="#python-stamp" id="python-stamp">Python Stamp</a></h4>
<ul>
<li>stamp to datetime</li>
</ul>
<pre><code>import datetime
import time
timeStamp = 1381419600
In [130]: date_time
Out[130]: datetime.datetime(2013, 10, 10, 15, 40)
</code></pre>
<ul>
<li>stamp output str</li>
</ul>
<pre><code>timeStamp = 1381419600
timeArray = time.localtime(timeStamp)
time_output = time.strftime(&quot;%Y-%m-%d %H:%M:%S&quot;, timeArray)
time_output == &quot;2013-10-10 23:40:00&quot;
</code></pre>
<ul>
<li>stamp save to database</li>
</ul>
<pre><code>set_time = datetime.datetime.strptime(time_str, '%Y-%m-%d %H:%M:%S')
</code></pre>
<ul>
<li>date converse to datetime</li>
</ul>
<pre><code>datetime.datetime.combine(instance.sale_time, datetime.time(0, 0))
</code></pre>
<hr />
<h4><a class="header" href="#python-basestring" id="python-basestring">Python Basestring</a></h4>
<pre><code>          object
             |
         basestring
            / \
           /   \
         str  unicode
         
&gt;&gt;&gt; string1 = &quot;I am a plain string&quot;
&gt;&gt;&gt; string2 = u&quot;I am a unicode string&quot;
&gt;&gt;&gt; isinstance(string1, str)
True
&gt;&gt;&gt; isinstance(string2, str)
False
&gt;&gt;&gt; isinstance(string1, unicode)
False
&gt;&gt;&gt; isinstance(string2, unicode)
True
&gt;&gt;&gt; isinstance(string1, basestring)
True
&gt;&gt;&gt; isinstance(string2, basestring)
True
</code></pre>
<hr />
<h4><a class="header" href="#python-list-dict" id="python-list-dict">Python List Dict</a></h4>
<pre><code>a=range(10)
b={}
b=b.fromkeys(a)
c=list(b.keys())
</code></pre>
<hr />
<h4><a class="header" href="#python-class-attribute" id="python-class-attribute">Python Class Attribute</a></h4>
<pre><code>class Student(object):
    @property
    def score(self):
        return self._score

    @score.setter
    def score(self, value):
        if not isinstance(value, int):
            raise ValueError('score must be an integer!')
        if value &lt; 0 or value &gt; 100:
            raise ValueError('score must between 0 ~ 100!')
        self._score = value
</code></pre>
<ul>
<li>
<p>Python <code>@property</code> make a self function to a attribute to call</p>
</li>
<li>
<p><code>@property</code> gen a decrator <code>@score.setter</code>, the score is decratored by '@property', setter is '@property' to control the value for that attribute.</p>
</li>
<li>
<p>before st.score assignment</p>
</li>
</ul>
<pre><code>In [54]: st._
st.__class__         st.__format__        st.__module__        st.__repr__          st.__subclasshook__
st.__delattr__       st.__getattribute__  st.__new__           st.__setattr__       st.__weakref__
st.__dict__          st.__hash__          st.__reduce__        st.__sizeof__        
st.__doc__           st.__init__          st.__reduce_ex__     st.__str__           

In [54]: st.score = 60
</code></pre>
<ul>
<li>after st.score assignment gen a _score attribute</li>
</ul>
<pre><code>In [55]: st._
st.__class__         st.__format__        st.__module__        st.__repr__          st.__subclasshook__
st.__delattr__       st.__getattribute__  st.__new__           st.__setattr__       st.__weakref__
st.__dict__          st.__hash__          st.__reduce__        st.__sizeof__        st._score
st.__doc__           st.__init__          st.__reduce_ex__     st.__str__           
</code></pre>
<ul>
<li>assignment test</li>
</ul>
<pre><code>In [55]: st._score=101

In [56]: st.score = 101
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
&lt;ipython-input-56-c8cebab0a5ba&gt; in &lt;module&gt;()
----&gt; 1 st.score = 600

&lt;ipython-input-50-363f41b24e8b&gt; in score(self, value)
      8             raise ValueError(&quot;not int type&quot;)
      9         if value &lt;0 or value&gt;100:
---&gt; 10             raise ValueError(&quot;out range 0-100&quot;)
     11         self._score = value
     12 

ValueError: out range 0-100
</code></pre>
<hr />
<h5><a class="header" href="#dict-list-summation" id="dict-list-summation">Dict List Summation</a></h5>
<ul>
<li><a href="http://stackoverflow.com/questions/3490738/how-to-sum-dict-elements">from</a> </li>
</ul>
<pre><code>&gt;&gt;&gt; dict1 = [{'a':2, 'b':3},{'a':3, 'b':4}]
&gt;&gt;&gt; from operator import itemgetter
&gt;&gt;&gt; {k:sum(map(itemgetter(k), dict1)) for k in dict1[0]}        # Python2.7+
{'a': 5, 'b': 7}
&gt;&gt;&gt; dict((k,sum(map(itemgetter(k), dict1))) for k in dict1[0])  # Python2.6
{'a': 5, 'b': 7}
</code></pre>
<hr />
<h4><a class="header" href="#sort" id="sort">Sort</a></h4>
<ol>
<li>Dict List Sort</li>
</ol>
<pre><code>a = sorted(dict_list, key=lambda k: k[sort_field], reverse=True)
</code></pre>
<ol start="2">
<li>Dict Sort</li>
</ol>
<pre><code>import operator
x = {1: 2, 3: 4, 4: 3, 2: 1, 0: 0}
sorted_x = sorted(x.items(), key=operator.itemgetter(1))
</code></pre>
<hr />
<h4><a class="header" href="#float-amount-decimal" id="float-amount-decimal">Float Amount Decimal</a></h4>
<pre><code>  amount = int(decimal.Decimal(cashout_amount) * 100)
</code></pre>
<hr />
<h4><a class="header" href="#about-object-copy" id="about-object-copy">About Object Copy</a></h4>
<pre><code>from copy import deepcopy
t = ModeleName.objects.get(id=1)
t1 = deepcopy(t)
t1.id = None
t1.save()  # save the object as a django model instance
</code></pre>
<hr />
<h4><a class="header" href="#python-map" id="python-map">Python Map</a></h4>
<ul>
<li>usually</li>
</ul>
<pre><code>def printlog(x):
    print &quot;log&quot;, x
    return 
map(printlog, range(10))
</code></pre>
<ul>
<li>take a arg</li>
</ul>
<pre><code>def test(message):
    def _wrapper(x):
    	print &quot;log&quot;, x , message
    	return 
    return _wrapper

map(test('hello world'), range(10))

</code></pre>
<hr />
<h4><a class="header" href="#pickle-serializer" id="pickle-serializer">pickle serializer</a></h4>
<ul>
<li>write the memory data to hard disk</li>
<li>get the same data in memory by call pickle again</li>
</ul>
<pre><code>import pickle

a = {
    &quot;linjie&quot;: [170,120,31],
    &quot;zhangwei&quot;: [176,140,34],
    &quot;lintao&quot;: [170,120,30]
}# prepare data stracture

with file('pickle_test.pkl', 'wb') as f:
    pickle.dump(a, f) # serialize

f = file('pickle_test.pkl') # open a file
x = pickle.load(f)  # unserialize to load the data
f.close()   # close file
x == a
True
</code></pre>
<pre><code>import pickle
         
data = {'foo': [1,2,3],
        'bar': ('Hello','world!'),
        'baz': True}
jar = open('data.pk1', 'wb')
pickle.dump(data, jar) # write pickle data to jar
jar.close()


import pickle
      
pk1_file = open('data.pk1','rb') # connect the pickle data
data = pickle.load(pk1_file) # loada data to var
print data
pk1_file.close()
</code></pre>
<ul>
<li><code>attention１：</code> Dump could be many times，but store the last time data</li>
<li><code>attention２：</code> Throw a error when dump data is None</li>
<li><code>attention３：</code> Do close file when </li>
</ul>
<hr />
<h4><a class="header" href="#python-mysql" id="python-mysql">Python Mysql</a></h4>
<pre><code>import MySQLdb 
try: 
    conn=MySQLdb.connect(host='localhost',user='root',passwd='root',db='test',port=3306) 
    cur=conn.cursor() 
    cur.execute('select * from user') 
    cur.close() 
    conn.close() 
except MySQLdb.Error,e: 
    print &quot;Mysql Error %d: %s&quot; % (e.args[0], e.args[1])

</code></pre>
<pre><code>
import MySQLdb

try: 
    conn=MySQLdb.connect(host='localhost',user='root',passwd='root',port=3306) 
    cur=conn.cursor() 

    cur.execute('create database if not exists python') 
    conn.select_db('python') 
    cur.execute('create table test(id int,info varchar(20))') 

    value=[1,'hi rollen'] 
    cur.execute('insert into test values(%s,%s)',value) 

    values=[] 
    for i in range(20): 
        values.append((i,'hi rollen'+str(i))) 
        cur.executemany('insert into test values(%s,%s)',values) 
        cur.execute('update test set info=&quot;I am rollen&quot; where id=3') 

    conn.commit() 
    cur.close() 
    conn.close() 

except MySQLdb.Error,e: 
    print &quot;Mysql Error %d: %s&quot; % (e.args[0], e.args[1])

</code></pre>
<hr />
<h4><a class="header" href="#python-connect-ssh" id="python-connect-ssh">Python Connect SSH</a></h4>
<pre><code>#!/usr/bin/python
#-*- coding:utf-8 -*-
import sys, time, os

try:
    import pexpect
except ImportError:
    print &quot;You must install pexpect module&quot;
    sys.exit(1)

addr_map = {
'v3' :('root@192.168.1.162', 'sina@2009'),
'dev':('test016@192.168.1.136', 'test016'),
}

try:
    key = sys.argv[1]
    host = addr_map[key]
except:
    print &quot;argv error, use it link jssh v3, v3 must defined in addr_map&quot;
    sys.exit(1)
server = pexpect.spawn('/usr/bin/ssh %s' % host[0])
server.expect('.*ssword:')
server.sendline(host[1])
server.interact()

</code></pre>
<pre><code># coding=utf-8

import sys, time, os
try:
    import pexpect
except ImportError:
    print &quot;You must install pexpect module&quot;
    sys.exit(1)

git_map = {
    'dbnote': 'dbnote',
    'jsnote': 'jsnote',
    'ljnote': 'ljnote',
    'pynote': 'pynote',
    'other': 'other',
}

def main():
    try:
        key = sys.argv[1]
        git_dir = git_map[key]
    except:
        print &quot;argv error&quot;
        sys.exit(1)
    os.chdir('/home/jielin/workspace/gitbooks/%s' % git_dir)
    child = pexpect.spawn('git push origin master')
    child.expect('Username for .*:')
    child.sendline('you account for gitbook')
    child.expect('Password for .*:')
    child.sendline('you passwd for gitbook')
    child.expect(pexpect.EOF)
    print &quot;push result: &quot;, child.before

if __name__ == '__main__':
    try:
        main()
    except Exception, e:
        print str(e.message)
        sys.exit(0)

</code></pre>
<p><a href="http://blog.csdn.net/lwnylslwnyls/article/details/8239791">Reference Link1</a></p>
<p><a href="http://blog.csdn.net/lwnylslwnyls/article/details/8239791">Reference Link2</a></p>
<p><a href="http://www.thinksaas.cn/topics/0/164/164786.html">Reference Link2</a></p>
<hr />
<h4><a class="header" href="#dict-list-groupby" id="dict-list-groupby">Dict List GroupBy</a></h4>
<pre><code>from itertools import groupby
from operator import itemgetter
x = [
    {'group': 'b', 'num': 4},
    {'group': 'a', 'num': 1},
    {'group': 'b', 'num': 3},
    {'group': 'b', 'num': 5},
    {'group': 'c', 'num': 6},
    {'group': 'a', 'num': 2},
]
x.sort(key=itemgetter('group'))  # must sort the list before groupby

groups = []
for g, items in groupby(x, key=itemgetter('group')):
    cate = {
        'name': g,
        'values': []
    }
    for i in items:
        cate['values'].append(i)
    groups.append(cate)
    
    
Out[5]: 
[{'name': 'a', 'values': [{'group': 'a', 'num': 1}, {'group': 'a', 'num': 2}]},
 {'name': 'b',
  'values': [{'group': 'b', 'num': 4},
   {'group': 'b', 'num': 3},
   {'group': 'b', 'num': 5}]},
 {'name': 'c', 'values': [{'group': 'c', 'num': 6}]}]

</code></pre>
<hr />
<p>Python Email</p>
<pre><code># coding=utf-8
from __future__ import unicode_literals, absolute_import
import imaplib
import smtplib
import email
from email.header import decode_header
from email.mime.text import MIMEText


def fetch_mail():
    conn = imaplib.IMAP4_SSL(&quot;imap.exmail.qq.com&quot;, 993)
    conn.login(&quot;jie.lin@xiaolumeimei.com&quot;, &quot;password&quot;)
    conn.list()
    conn.select(&quot;INBOX&quot;)
    type, data = conn.search(None, 'ALL')
    msgList = data[0].split()
    last = msgList[len(msgList) - 1]
    type, data = conn.fetch(last, '(RFC822)')
    msg = email.message_from_string(data[0][1])

    # print msg.keys()
    # ['Received', 'X-QQ-FEAT',
    # 'X-QQ-MAILINFO', 'X-QQ-mid',
    # 'X-QQ-ORGSender', 'DKIM-Signature', 'X-EnvId',
    # 'Received', 'Date', 'From', 'To', 'Message-ID',
    # 'Subject', 'MIME-Version', 'Content-Type']
    msg_from = decode_header(msg.get('From'))
    print msg_from, msg_from[0][0]
    # [('\xe9\x98\xbf\xe9\x87\x8c\xe4\xba\x91', 'utf-8'), ('&lt;monitor@monitor.aliyun.com&gt;', None)] 阿里云
    print msg.get_payload()
    # [&lt;email.message.Message instance at 0x7f9b05fd4170&gt;]
    msg = msg.get_payload()[0]
    content = msg.get_payload(decode=True)
    print content


def send_mail():
    # Open a plain text file for reading.  For this example, assume that
    # the text file contains only ASCII characters.
    # fp = open(textfile, 'rb')
    # Create a text/plain message
    # msg = MIMEText(fp.read())
    msg = MIMEText('hello world')
    # fp.close()

    # me == the sender's email address
    # you == the recipient's email address
    msg['Subject'] = 'The contents of %s' % 'www'
    msg['From'] = 'jie.lin@xiaolumeimei.com'
    msg['To'] = '1051631394@qq.com'

    # Send the message via our own SMTP server, but don't include the
    # envelope header.
    s = smtplib.SMTP_SSL('smtp.exmail.qq.com', 465)
    s.login(&quot;jie.lin@xiaolumeimei.com&quot;, &quot;password&quot;)
    s.sendmail('jie.lin@xiaolumeimei.com', ['1051631394@qq.com'], msg.as_string())
    s.quit()

if __name__ == '__main__':
    fetch_mail()
    send_mail()

</code></pre>
<hr />
<h4><a class="header" href="#脚本输入用户明密码" id="脚本输入用户明密码">脚本输入用户明密码</a></h4>
<pre><code># coding=utf-8

import sys, time, os
try:
    import pexpect
except ImportError:
    print &quot;You must install pexpect module&quot;
    sys.exit(1)

git_map = {
    'dbnote': 'dbnote',
    'jsnote': 'jsnote',
    'ljnote': 'ljnote',
    'pynote': 'pynote',
    'other': 'other',
}

def main():
    try:
        key = sys.argv[1]
        git_dir = git_map[key]
    except:
        print &quot;argv error&quot;
        sys.exit(1)
    os.chdir('/home/jielin/workspace/gitbooks/%s' % git_dir)
    child = pexpect.spawn('git pull origin master')
    child.expect('Username for .*:')
    child.sendline('username')
    child.expect('Password for .*:')
    child.sendline('password here')
    child.expect(pexpect.EOF)
    print &quot;pull result is :&quot;, child.before

    child = pexpect.spawn('git push origin master')
    child.expect('Username for .*:')
    child.sendline('username')
    child.expect('Password for .*:')
    child.sendline('password here')
    child.expect(pexpect.EOF)
    print &quot;push result: &quot;, child.before

if __name__ == '__main__':
    try:
        main()
    except Exception, e:
        print str(e.message)
        sys.exit(0)

</code></pre>
<h4><a class="header" href="#目录扫描-1" id="目录扫描-1">目录扫描</a></h4>
<pre><code>import os
import sys

  
def scan_files(directory,prefix=None,postfix=None):
  files_list=[]

  for root, sub_dirs, files in os.walk(directory):
    for special_file in files:
      if postfix:
        if special_file.endswith(postfix):
          files_list.append(os.path.join(root,special_file))
      elif prefix:
        if special_file.startswith(prefix):
          files_list.append(os.path.join(root,special_file))
      else:
        files_list.append(os.path.join(root,special_file))  
  return files_list

if __name__ == '__main__':
    directory = sys.argv[1]
    l = scan_files(directory)
    print l
</code></pre>
<hr />
<h2>layout: post
title: python 排序
date: 2015-06-01
tag: 算法</h2>
<p><strong>摘要:</strong>
排序在编程中经常用到,这里有些以前学过的排序算法，使用Python实现的。
封装在一个class中.以便查阅.</p>
<pre><code>#coding=utf-8
import sys

class Xsort(object):
    def __init__(self, s):
        self.source = s 
        self.target = s

    def bubble_sort(self):
        # 冒泡排序O(n^2): 遍历序列长度,便利每一个元素与相邻元素比较交换
        l = len(self.target)

        while l &gt; 0:
            for i in xrange(l - 1):
                # 交换位置
                if self.target[i] &gt; self.target[i + 1]:
                    self.target[i] = self.target[i] + self.target[i + 1]
                    self.target[i + 1] = self.target[i] - self.target[i + 1]
                    self.target[i] = self.target[i] - self.target[i + 1]
            l -= 1
        return self.target

    def insert_sort(self):
        # 插入排序O(n^2)
        l = len(self.target)
        if l &lt;= 1:
            return self.target

        for i in xrange(1, l):
            j = i -1
            if self.target[i] &lt; self.target[j]:
                tmp = self.target[i]
                self.target[i] = self.target[j]

                # 向前找 插入到合适位置
                j = j - 1
                while j &gt;= 0 and self.target[j] &gt; tmp:
                    self.target[j + 1] = self.target[j]
                    j = j - 1

                self.target[j + 1] = tmp
        return self.target

    def selection_sort(self):
        # 选择排序
        l = len(self.target)

        for i in xrange(0, l):
            mi = i
            for j in xrange(i + 1, l):
                if self.target[j] &lt; self.target[mi]:
                    mi = j 
                    self.target[i], self.target[mi] = self.target[mi], self.target[i]
        return self.target

    def heap_sort(self):
        # 堆排序O(nlog(n))
        l = len(self.target)

        def heaping(a, k, n):  # 堆处理
            N = n - 1
            while 2 * k &lt;= N:
                j = 2 * k
                if j &lt; N and a[j] &lt; a[j + 1]:
                    j += 1
                if a[k] &lt; a[j]:
                    a[k], a[j] = a[j], a[k]
                    k = j
                else:
                    break

        for i in range(l / 2, 0, -1):
            heaping(self.target, i, l)

        n = l - 1
        while n &gt; 1:
            self.target[1], self.target[n] = self.target[n], self.target[1]
            heaping(self.target, 1, n)
            n -= 1
        return self.target[1:]
    
    def quick_sort(self, low=None, high=None):
        # 快速排序: 大小二分,递归调用
        i = 0 if low is None else low
        j = len(self.target) -1 if high is None else high
        
        if i &gt;= j:
            return self.target
        key = self.target[i]

        while i &lt; j:
            # 从后往前找, 直到一个元素大于等于 关键元素
            while i &lt; j and self.target[j] &gt;= key:
                j = j - 1
            self.target[i] = self.target[j]
            # 从前往后找, 直到一个元素小于等于 关键元素
            while i &lt; j and self.target[i] &lt;= key:    
                i = i + 1 
            self.target[j] = self.target[i]
        self.target[i] = key 

        self.quick_sort(low, i-1)
        self.quick_sort(j+1, high)

        return self.target


if __name__ == '__main__':
    source = [int(i) for i in sys.argv[1].split(',')]
    x = Xsort(source)
    # print x.bubble_sort()
    # print x.insert_sort()
    # print x.selection_sort()
    # print x.heap_sort()
    print x.quick_sort()

</code></pre>
<hr />
<h2>layout: post
title: python 一些工具
date: 2015-11-24
category: python</h2>
<p><strong>摘要:</strong>
Python中有很多的包可以使用,防止造轮子提高开发效率,降低bug数量.这里贴
一些链接和一些使用简介内容.</p>
<h4><a class="header" href="#gevent" id="gevent">Gevent</a></h4>
<ul>
<li>协程不是进程或线程，其执行过程更类似于子例程，或者说不带返回值的函数调用</li>
<li>多个线程相对独立，有自己的上下文，切换受系统控制</li>
<li>协程相对独立，有自己的上下文，其切换由自己控制，由当前协程切换到其他协程由当前协程来控制。没有了线程所谓的安全问题</li>
<li>一个程序可以包含多个协程，可以对比与一个进程包含多个线程，因而下面我们来比较协程和线程</li>
<li>gevent是第三方库，通过greenlet实现协程
<ul>
<li>greenlet 包是 Stackless 的副产品，其将微线程称为 “tasklet” </li>
<li>tasklet运行在伪并发中，使用channel进行同步数据交换。一个”greenlet”，是一个更加原始的微线程的概念，但是没有调度，或者叫做协程。这在你需要控制你的代码时很有用。你可以自己构造微线程的 调度器；也可以使用”greenlet”实现高级的控制流。例如可以重新创建构造器；不同于Python的构造器，我们的构造器可以嵌套的调用函数，而被 嵌套的函数也可以 yield 一个值。Greenlet是作为一个C扩展模块给未修改的解释器的</li>
<li>每个greenlet都只是heap(堆内存)中的一个python object(PyGreenlet).所以对于一个进程你创建百万甚至千万个greenlet都没有问题.</li>
<li>每一个greenlet其实就是一个函数,以及保存这个函数执行时的上下文.对于函数来说上下文也就是其stack(栈).同一个进程的所有的greenlets共用一个共同的操作系统分配的用户栈.所以同一时刻只能有栈数据不冲突的greenlet使用这个全局的栈.</li>
<li>Simple case of greenlet</li>
<li>
<pre><code></code></pre>
</li>
</ul>
from greenlet import greenlet
def test1():
print 12
gr2.switch()
print 34
def test2():
print 56
gr1.switch()
print 78
gr1 = greenlet(test1)
gr2 = greenlet(test2)
gr1.switch()
<pre><code>
</code></pre>
</li>
<li>gevent 使用</li>
</ul>
<ol>
<li>说明：
<ul>
<li>使用gevent，可以获得极高的并发性能</li>
<li>gevent只能在Unix/Linux下运行</li>
<li>在Windows下不保证正常安装和运行</li>
<li>由于gevent是基于IO切换的协程，所以最神奇的是，我们编写的Web App代码，不需要引入gevent的包，也不需要改任何代码，仅仅在部署的时候，用一个支持gevent的WSGI服务器，立刻就获得了数倍的性能提升。</li>
</ul>
</li>
</ol>
<ul>
<li>总结一下：</li>
</ul>
<ol>
<li>多进程能够利用多核优势，但是进程间通信比较麻烦，另外，进程数目的增加会使性能下降，进程切换的成本较高。程序流程复杂度相对I/O多路复用要低。</li>
<li>I/O多路复用是在一个进程内部处理多个逻辑流程，不用进行进程切换，性能较高，另外流程间共享信息简单。但是无法利用多核优势，另外，程序流程被事件处理切割成一个个小块，程序比较复杂，难于理解。</li>
<li>线程运行在一个进程内部，由操作系统调度，切换成本较低，另外，他们共享进程的虚拟地址空间，线程间共享信息简单。但是线程安全问题导致线程学习曲线陡峭，而且易出错。</li>
<li>协程由编程语言提供，由程序员控制进行切换，所以没有线程安全问题，可以用来处理状态机，并发请求等。但是无法利用多核优势。</li>
</ol>
<ul>
<li><strong>上面的四种方案可以配合使用，我比较看好的是进程+协程的模式。</strong></li>
</ul>
<hr />
<h4><a class="header" href="#about-monkey-patch" id="about-monkey-patch">About Monkey Patch</a></h4>
<ul>
<li>monkey patch指在运行时动态替换,一般是在startup的时候.</li>
<li>例如：gevent会在最开头的地方gevent.monkey.patch_all();把标准库中的thread/socket等给替换掉.这样我们在后面使用socket的时候可以跟平常一样使用,无需修改任何代码,但是它变成非阻塞的了.</li>
<li>Example:
import json,后来发现ujson比自带json快了N倍,于是问题来了,难道几十个文件要一个个把import json改成import ujson as json吗?
其实只需要在进程startup的地方monkey patch就行了.是影响整个进程空间的.同一进程空间中一个module只会被运行一次.下面是代码.</li>
</ul>
<p><code>main.py</code></p>
<pre><code>import json
import ujson
def monkey_patch_json():
  json.__name__ = 'ujson'
  json.dumps = ujson.dumps
  json.loads = ujson.loads

monkey_patch_json()
print 'main.py',json.__name__
import sub
</code></pre>
<p><code>sub.py</code></p>
<pre><code>import json
print 'sub.py',json.__name__
</code></pre>
<p>运行main.py,可以看到都是输出'ujson',说明后面import的json是被patch了的. </p>
<p><strong>最后注意不能单纯的json = ujson来替换</strong></p>
<hr />
<h4><a class="header" href="#scrapy" id="scrapy">Scrapy</a></h4>
<ol>
<li>
<p>install
<code>sudo pip install scrapy</code></p>
</li>
<li>
<p>Create A Project
<code>scrapy startproject tutorial</code></p>
</li>
</ol>
<ul>
<li>目录结构</li>
</ul>
<pre><code>tree tutorial/  
tutorial/  
├── scrapy.cfg  
└── tutorial  
    ├── __init__.py  
    ├── items.py  
    ├── pipelines.py  
    ├── settings.py  
    └── spiders  
        └── __init__.py  
</code></pre>
<ul>
<li>items.py: 定义项目的抓取条款准则（模型）　　</li>
<li>spiders: 处理抓取实现　　</li>
<li>piplines.py: 设计管道存储以及过滤抓取内容　　</li>
</ul>
<ol start="3">
<li>shell中操作</li>
</ol>
<p><code>scrapy shell &quot;http://www.dmoz.org/Computers/Programming/Languages/Python/Books/&quot;</code></p>
<p><a href="http://doc.scrapy.org/en/latest/intro/tutorial.html">Doc Address</a>
<a href="http://scrapy-chs.readthedocs.org/zh_CN/latest/intro/tutorial.html">Reference Link</a></p>
<hr />
<h4><a class="header" href="#spynner包支持ajax动态加载web浏览python包" id="spynner包支持ajax动态加载web浏览python包">spynner包支持ajax动态加载web浏览python包</a></h4>
<ul>
<li>version: spynner 2.5 python &gt;=26  PyQt &gt; 443</li>
<li><a href="https://pypi.python.org/pypi/spynner/2.5">Download</a></li>
<li>Spynner Requirement<a href="http://baike.baidu.com/link?url=8s5iBLGKeZiJ0moKSmV5QSJbX2hwK14vqvHF0oL3S7IvzJPFFU6CYg4MdeRpa71UkpgQ_vNVD9w4DJOFcPRoy_">x11</a></li>
</ul>
<ol>
<li>install x11  method :</li>
</ol>
<ul>
<li>
<p>sudo apt-get install xorg-dev, libxtst-dev</p>
</li>
<li>
<p>sudo pip install spynner</p>
</li>
</ul>
<ol start="3">
<li>
<p>download the pyqt<a href="https://sourceforge.net/projects/pyqt/?source=typ_redirect">pyqt</a></p>
</li>
<li>
<p>sudo apt-get install libqt4-dev</p>
</li>
<li>
<p>sudo pip install PyQt</p>
</li>
<li>
<p>sudo pip install sip</p>
</li>
</ol>
<p><strong>WARING</strong>: Then run ipython or python with sudo if in vitrualevn source, OR you will be found the promote you PyQt4 not found!!!</p>
<hr />
<h4><a class="header" href="#pypi-server" id="pypi-server">pypi-server</a></h4>
<p><code>注意：</code>pip install pypiserver，　安装后会有报错　import sets as Set 的错误 </p>
<ul>
<li>
<p>解决办法：　<a href="https://pypi.python.org/pypi/pypiserver#downloads">Download</a></p>
</li>
<li>
<p>安装 解压后的　requirements文件夹中的包</p>
</li>
</ul>
<pre><code>user1@localhost:~$ sudo pypi-server -p 7001 ~/simple/
serving on http://0.0.0.0:7001
</code></pre>
<hr />
<h4><a class="header" href="#pil-histogram-统计的理解" id="pil-histogram-统计的理解">pil histogram 统计的理解</a></h4>
<pre><code>    if the mode is RGB to open a image, 768 mean is Red grey list[0-255 pixs nums]+
    Green grey list[0-255 pix nums]+ Blue grey list[0-255 pix numbs]
    im is a Image object by RGB
    In [59]: x = reduce(lambda x,y:x+y,im.histogram())
    In [60]: x Out[60]: 47191725
    In [61]: im.size Out[61]: (4731, 3325)
    In [62]: 4731*3325 Out[62]: 15730575
    In [63]: 4731*3325*3 Out[63]: 47191725
    In [64]:
    or other way:
    r, g, b = im.split()
    len(r.histogram()) = 256
    len(g.histogram()) = 256
    len(b.histogram()) = 256
</code></pre>
<hr />
<h4><a class="header" href="#install-kivy-for-python-gui-aplication-develop" id="install-kivy-for-python-gui-aplication-develop">Install Kivy For Python GUI Aplication Develop</a></h4>
<ol>
<li>install cpython to support
<code>sudo pip install cpython</code></li>
<li>install pygame to support
<code>sudo apt-get install python-pygame</code></li>
<li>download the install file . <a href="https://kivy.org/">Adress</a></li>
<li>install kivy
<code>sudo python setup.py install</code></li>
<li><a href="http://inclem.net/pages/kivy-crash-course/">Reference Link</a></li>
</ol>
<hr />
<h4><a class="header" href="#sklearn-installdata-analysis" id="sklearn-installdata-analysis">Sklearn Install(Data Analysis)</a></h4>
<p><a href="http://blog.sina.com.cn/s/blog_67331d610102vkvx.html">Reference Link</a></p>
<hr />
<h4><a class="header" href="#python-request" id="python-request">Python Request</a></h4>
<p>[Reference Link]http://docs.python-requests.org/zh_CN/latest/user/quickstart.html</p>
<hr />
<h4><a class="header" href="#python-logging" id="python-logging">Python Logging</a></h4>
<p><a href="https://www.loggly.com/docs/django-logs/">Reference Link</a></p>
<hr />
<h4><a class="header" href="#flask-study" id="flask-study">Flask Study</a></h4>
<p><a href="http://www.pythondoc.com/flask-mega-tutorial/">Reference Link</a></p>
<hr />
<h4><a class="header" href="#django-celery" id="django-celery">Django Celery</a></h4>
<p>python manage.py celery worker --loglevel=info </p>
<hr />
<h4><a class="header" href="#excel-handler" id="excel-handler">Excel handler</a></h4>
<p>关于excel 模块</p>
<pre><code>sudo pip install xlrd
sudo pip install xlwt
sudo pip install xlsxwriter
</code></pre>
<hr />
<h4><a class="header" href="#virtualenv-python3--pip-install-pyton3-package" id="virtualenv-python3--pip-install-pyton3-package">VirtualEnv python3 &amp; Pip install pyton3 package</a></h4>
<ol>
<li><code>virtualenv -p python3 envname</code></li>
<li><code>python -m pip install &lt;package-name&gt;</code></li>
</ol>
<hr />
<h2>layout: post
title: tornado基础
category: webframework
tag: tornado
date: 2017-2-14</h2>
<p><strong>摘要：</strong>
tornado是一个异步非阻塞的web开发框架，这里添加一些基础的代码，学习ing.
不断更新吧。模板和django的还是很相似的。
<a href="https://github.com/tornadoweb/tornado">github</a>
<a href="py/docs.pythontab.com/tornado/introduction-to-tornado">中文基础教程</a></p>
<h5><a class="header" href="#web-requesthandler" id="web-requesthandler">web requesthandler</a></h5>
<ol>
<li>hello.py</li>
</ol>
<pre><code>#coding=utf-8
import textwrap
import tornado.options
import tornado.ioloop
import tornado.web

from tornado.options import define, options


define(&quot;port&quot;, default=8888, help='run on the given port', type=int)


class MainHandler(tornado.web.RequestHandler):
    def get(self):
        self.write(&quot;Hello, world&quot;)


class StoryHandler(tornado.web.RequestHandler):
    def get(self, story_id):
        self.write(&quot;You request the story id is: %s&quot; % story_id)
        print self.get_argument('user_name', 'nobody')  # ?user_name=abcdef


class ReverseHandler(tornado.web.RequestHandler):
    def get(self, input_str):
        self.write(&quot;reserves result is: %s&quot; % input_str[::-1])


class WrapHandler(tornado.web.RequestHandler):
    def get(self):
        self.write('this is get method')

    # http post 方法
    def post(self):
        text = self.get_argument('text')
        print 'text is:', text
        width = self.get_argument('width', 40)
        print 'width is:', width
        self.write(textwrap.fill(text, int(width)))


class FrobHandler(tornado.web.RequestHandler):
    def get(self, frob_id):
        # frob = retrive_from_db(frob_id)
        # self.write(frob.serialize()) 
        self.write('after')
        
    # http head 方法
    def head(self, frob_id):
        if frob_id:
            self.set_status(200)  # 使用set_status 设置请求头
        else:
            self.set_status(404)


class RewriteErrorHandler(tornado.web.RequestHandler):
    def get(self):
        self.write('get example')

    # 重写错误相应方法
    def write_error(self, status_code, **kwargs):  # 注意这里的参数
        self.write('this is rewrite the write_error func')


def make_app():
    return tornado.web.Application([
        (r&quot;/&quot;, MainHandler),
        (r&quot;/story/([0-9]+)&quot;, StoryHandler),
        (r&quot;/wrap&quot;, WrapHandler),
        (r&quot;/reverse/(\w+)&quot;, ReverseHandler),
        (r&quot;/frob/([0-9]+)&quot;, FrobHandler),
        (r&quot;/werror&quot;, RewriteErrorHandler),
    ])

if __name__ == &quot;__main__&quot;:
    tornado.options.parse_command_line()
    app = make_app()
    app.listen(options.port)
    tornado.ioloop.IOLoop.instance().start()
</code></pre>
<h5><a class="header" href="#templates" id="templates">templates</a></h5>
<ol>
<li>后台代码</li>
</ol>
<pre><code>#coding=utf-8
import os.path

import tornado.httpserver
import tornado.ioloop
import tornado.options
import tornado.web

from tornado.options import define, options


define('port', default=8888, help='run on the give port', type=int)


class IndexHandler(tornado.web.RequestHandler):

    def get(self):
        self.render('index.html')


class PoemHandler(tornado.web.RequestHandler):

    def post(self):
        noun1 = self.get_argument('noun1')
        noun2 = self.get_argument('noun2')
        noun3 = self.get_argument('noun3')
        verb = self.get_argument('verb')
        self.render('poem.html', 
                    roads=noun1, 
                    wood=noun2, 
                    made=verb,
                    difference=noun3)

# 模板中使用模块
class HelloModule(tornado.web.UIModule):

    def render(self):
        return '&lt;h2&gt;this is a uimodule render&lt;/h2&gt;'
    

def make_app():
    return tornado.web.Application(
            [
                (r'/', IndexHandler),
                (r'/poem', PoemHandler),
            ],
            template_path=os.path.join(os.path.dirname(__file__), 'templates'),
            static_path=os.path.join(os.path.dirname(__file__), 'static'),
            ui_modules = {'hello': HelloModule}, ## 模板中使用module
        )


if __name__ == '__main__':
    tornado.options.parse_command_line()
    app = make_app()
    app.listen(options.port)
    tornado.ioloop.IOLoop.instance().start()
</code></pre>
<ol start="2">
<li>templates/poem.html</li>
</ol>
<pre><code>&lt;!DOCTYPE html&gt;
&lt;html&gt;
    &lt;head&gt;&lt;title&gt;Poem Maker Pro&lt;/title&gt;&lt;/head&gt;
    &lt;body&gt;
        &lt;h1&gt;Your poem&lt;/h1&gt;
	&lt;p&gt;
	Two {{roads}} diverged in a {{wood}}, and I—&lt;br&gt;
	I took the one less travelled by,&lt;br&gt;
	And that has {{made}} all the {{difference}}.
	&lt;/p&gt;
    &lt;/body&gt;
&lt;/html&gt;
</code></pre>
<ol start="4">
<li>template/index.html</li>
</ol>
<pre><code>&lt;!DOCTYPE html&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;title&gt;Poem Maker Pro&lt;/title&gt;
        &lt;script type=&quot;text/javascript&quot; src=&quot;{{static_url(&quot;console.js&quot;) }}&quot;&gt;&lt;/script&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;h1&gt;Enter terms below.&lt;/h1&gt;
        &lt;form method=&quot;post&quot; action=&quot;/poem&quot;&gt;
        &lt;p&gt;Plural noun&lt;br&gt;&lt;input type=&quot;text&quot; name=&quot;noun1&quot;&gt;&lt;/p&gt;
        &lt;p&gt;Singular noun&lt;br&gt;&lt;input type=&quot;text&quot; name=&quot;noun2&quot;&gt;&lt;/p&gt;
        &lt;p&gt;Verb (past tense)&lt;br&gt;&lt;input type=&quot;text&quot; name=&quot;verb&quot;&gt;&lt;/p&gt;
        &lt;p&gt;Noun&lt;br&gt;&lt;input type=&quot;text&quot; name=&quot;noun3&quot;&gt;&lt;/p&gt;
        &lt;input type=&quot;submit&quot;&gt;
        &lt;/form&gt;


        &lt;div&gt;
            &lt;h1&gt;模板中使用模块&lt;/h1&gt;
            {% module hello() %}
        &lt;/div&gt;
    &lt;/body&gt;
&lt;/html&gt;
</code></pre>
<ol start="5">
<li>console.js</li>
</ol>
<pre><code>console.log('console active')
</code></pre>
<hr />
<h2>layout: post
title: virtualenv使用
date: 2015-03-10
category: python
tag: virtualenv</h2>
<p><strong>摘要:</strong>
使用virtualenv可以有效的隔离开发环境,方便开发使用不同的包!</p>
<ol>
<li>virtualenv ve // use default python</li>
<li>virtualenv --python=/usr/bin/python3 ve // assign python</li>
</ol>
<ul>
<li><a href="https://virtualenv.pypa.io/en/stable/">参考文档</a></li>
</ul>
<h1><a class="header" href="#other" id="other">Other</a></h1>
<hr />
<h2>layout: post
title: curl 的使用
category: tools
tag: curl
date: 2016-8-10</h2>
<p><strong>摘要:</strong>
curl可以用来发送一些客户端请求,http,ftp等等，可以指定http的版本等等。
这里做一些记录。不断更新中。</p>
<h5><a class="header" href="#get" id="get">GET</a></h5>
<p>curl http://localhost:8888/test/?username=linjie&amp;password=123455</p>
<h5><a class="header" href="#post" id="post">POST</a></h5>
<p>curl -X POST -F 'username=linjie' -F 'password=123456' http://localhost:8888/test/</p>
<h5><a class="header" href="#head" id="head">HEAD</a></h5>
<p>curl -I http://localhost:8888/test/</p>
<h4><a class="header" href="#cookie-以及-post-json-文件" id="cookie-以及-post-json-文件">cookie 以及　post json 文件</a></h4>
<p>curl -b &quot;@hrcommon/login_d1_main_cookie.txt&quot;  -H &quot;Content-Type: application/json&quot; -X PUT -d &quot;@hr35/impression.json&quot; http://localhost:8000/api/account/template/company_impression</p>
<hr />
<h2>layout: post
title: EasyTalk
date: 1991-01-01
category: Nothing
tag: None</h2>
<p><strong>摘要:</strong>
我只是想有那么一个角落可耍耍疯!
所以我在这里添加了个文档,反正没有人发现,如果你发现了;请您什么也不要说!
我不知道一个开发人员为什么要有一个blog,我就是记录下笔记!有人看也不知道
好不好.
有时候觉得笔记有些多余,因为官网的文档比自己的笔记更全面想怎么看怎么看.
而且更加的权威,笔记只是为了自己有时候偷懒下,有写小方法直接可以copy完结.
做个code monkey也不是一件不好的事情,坚持每天学习新东西,新事物!
写写笔记!</p>
<hr />
<h4><a class="header" href="#性能调优" id="性能调优">性能调优</a></h4>
<ul>
<li>注意要在不加cache的情况下调优代码</li>
</ul>
<hr />
<h4><a class="header" href="#weichart-pay" id="weichart-pay">WeiChart Pay</a></h4>
<ul>
<li>微信支付需要配置（微信后台）指定支付的链接地址</li>
</ul>
<hr />
<h4><a class="header" href="#about-seivice-rigister" id="about-seivice-rigister">About Seivice Rigister</a></h4>
<ul>
<li>注意注册流程的可控性，账号的可控性，数据的产生要绝对的干净，逻辑清晰！</li>
</ul>
<p>页面要求用户填写要验证的手机，服务器得到用户提交的手机号码后给用户手机号发送验证信息，用户收到验证码后，在页面输入并提交，服务器获得验证码和数据库的发送内容进行对比，以此来验证用户手机的有效性和唯一性．</p>
<hr />
<h4><a class="header" href="#about-coding--business" id="about-coding--business">About Coding &amp; Business</a></h4>
<ul>
<li>脱离代码本身，关注业务逻辑</li>
<li>各个办公环节的定义及, 企业操作流水线系统</li>
</ul>
<hr />
<h4><a class="header" href="#about-idea" id="about-idea">About Idea</a></h4>
<ul>
<li>创建一个消息换消息的网站！</li>
</ul>
<hr />
<h4><a class="header" href="#about-database" id="about-database">About DataBase</a></h4>
<ul>
<li>容灾 预案 迁移数据库准备</li>
<li>代码层级减少操作数据库的次数</li>
<li>数据库操作频繁,导致脚本执行时间过长被killed;可以采用分段执行来处理.</li>
</ul>
<hr />
<h4><a class="header" href="#双十一记录" id="双十一记录">双十一记录</a></h4>
<p>重要活动之前要去检查服务器的状态是否稳定，缓存 ，代码， 数据库 ，服务器；
按照预期进行有必要的升级，维护
尽量减少活动期间的代码更新
出台紧急状况应急预案， 例如服务器瘫痪情况
缩短网页的访问时间， 比如页面的加载时间，细化分配接口字段， 压缩网页浏览  降低 页面图片的数据量的大小。</p>
<p>准备产品宣传推广（流量不足，销量不高， 发现新的流量入口，YY代理培训等等（处理负面内容））
准备好库存（有超卖现象-修改库存导致，双十一  仓储一定库存  下单即发 是一个打好口碑的机会）
准备活动数据以及数据分析
准备活动售后服务内容
做好售后服务公关</p>
<hr />
<h4><a class="header" href="#about-buyer" id="about-buyer">About Buyer</a></h4>
<p>线下买手为你选货，有佣金， 当买手的数量很大的时候，他们都选择自己的想要的款式 
这些数据就可以预测流行的趋势  ，通过这些数据 就可以筛选出大于某一个阀值的 流行性数据</p>
<hr />
<h2>layout: post
title: Emacs配置及插件
date: 2015-02-08
category: Edit
tag: Emacs</h2>
<p><strong>摘要:</strong>
有人说emacs是神的编辑器,很是羡慕那些大神用这么牛逼的编辑器,还可以配置成牛逼的ide
都无法直视那些用emacs的开发者,给你们点赞;我以前的一个公司CEO用的就是emacs写代码;
这里是我用过的配置文件和快捷键内容,保留在这里,以供查阅.</p>
<h4><a class="header" href="#emacs-config" id="emacs-config">Emacs Config</a></h4>
<pre><code>;;打开emacs 交互解释器
;;M+x ielm
(let ((default-directory &quot;~/.emacs.d/el-get/&quot;))
  (normal-top-level-add-subdirs-to-load-path))

(add-to-list 'load-path &quot;~/.emacs.d/el-get/yasnippet/&quot;)
(add-to-list 'load-path &quot;~/.emacs.d/el-get/rope/&quot;)
(add-to-list 'load-path &quot;~/.emacs.d/el-get/pymacs/&quot;)
(add-to-list 'load-path &quot;~/.emacs.d/el-get/ropemacs/&quot;)
(add-to-list 'load-path &quot;~/.emacs.d/el-get/ropemode/&quot;)
(add-to-list 'load-path &quot;~/.emacs.d/el-get/auto-complete/&quot;)
(add-to-list 'load-path &quot;~/.emacs.d/el-get/virtualenvwrapper/&quot;)
(add-to-list 'load-path &quot;~/.emacs.d/el-get/virtualenv.el-master/&quot;)
(add-to-list 'load-path &quot;~/.emacs.d/el-get/python-django/&quot;)

(load &quot;~/.emacs.d/el-get/el-get/el-get.el&quot;)
(load &quot;~/.emacs.d/el-get/python-django/python-django.el&quot;)
(load &quot;~/.emacs.d/el-get/virtualenv.el-master/virtualenv.el&quot;)
(load &quot;~/.emacs.d/el-get/auto-complete/auto-complete.el&quot;)

(tool-bar-mode 0) 
(menu-bar-mode 0) 
(scroll-bar-mode 0)
(custom-set-variables
 ;; custom-set-variables was added by Custom.
 ;; If you edit it by hand, you could mess it up, so be careful.
 ;; Your init file should contain only one such instance.
 ;; If there is more than one, they won't work right.
 '(virtualenv-root &quot;~/workspace/taobao-backend/shopmanager/ve/lib/python2.7/&quot;))
(custom-set-faces
 ;; custom-set-faces was added by Custom.
 ;; If you edit it by hand, you could mess it up, so be careful.
 ;; Your init file should contain only one such instance.
 ;; If there is more than one, they won't work right.
 )

;;关闭启动页面
(setq inhibit-startup-message t)
;;设置备份保存路径
(setq backup-directory-alist (quote ((&quot;.&quot; . &quot;~/.backups&quot;))))

;;配置virtualenv

(setenv &quot;PATH&quot; (concat (getenv &quot;PATH&quot;) &quot;:&quot; &quot;~/path to you virtual env example: /ve/bin&quot;))
(add-to-list 'exec-path &quot;~/path to you virtual env example: /ve/bin&quot;)

;;speedbar 配置 下载的el文件在el-get/sr-speedbar
(require 'sr-speedbar)

;; 配置显示行号
(global-linum-mode t)
;;窗口切换
(global-set-key (kbd &quot;C-S-j&quot;) 'windmove-down)
(global-set-key (kbd &quot;C-S-k&quot;) 'windmove-up)
(global-set-key (kbd &quot;C-S-h&quot;) 'windmove-left)
(global-set-key (kbd &quot;C-S-l&quot;) 'windmove-right)
</code></pre>
<hr />
<h4><a class="header" href="#emacs-virtualenv-config" id="emacs-virtualenv-config">emacs virtualenv config</a></h4>
<p><a href="http://stackoverflow.com/questions/17759610/use-el-get-to-install-jedi-for-emacs-on-mac">Referance Link</a></p>
<hr />
<h4><a class="header" href="#webkit-in-emacs" id="webkit-in-emacs">webkit in emacs</a></h4>
<p>M+x</p>
<p>el-get-install webkit</p>
<p>sudo apt-get install qt5-default</p>
<hr />
<h4><a class="header" href="#emacs-short-cuts" id="emacs-short-cuts">Emacs Short Cuts</a></h4>
<table><thead><tr><th>category</th><th>cmd</th><th>explain</th></tr></thead><tbody>
<tr><td>打开</td><td>emacs -nw</td><td>命令行打开emacs</td></tr>
<tr><td>文件操作</td><td>C-x C-f</td><td>打开文件,出现提示时输入/username@host:filepath可编辑FTP文件</td></tr>
<tr><td></td><td>C-x C-v</td><td>打开一个文件，取代当前缓冲区</td></tr>
<tr><td></td><td>C-x C-s</td><td>保存文件</td></tr>
<tr><td></td><td>C-x C-w</td><td>存为新文件</td></tr>
<tr><td></td><td>C-x i</td><td>插入文件</td></tr>
<tr><td></td><td>C-x C-q</td><td>切换为只读或者读写模式</td></tr>
<tr><td></td><td>C-x C-c</td><td>退出Emacs</td></tr>
<tr><td>编辑操作</td><td>C-f</td><td>前进一个字符</td></tr>
<tr><td></td><td>C-b</td><td>后退一个字符</td></tr>
<tr><td></td><td>M-f</td><td>前进一个字</td></tr>
<tr><td></td><td>M-b</td><td>后退一个字</td></tr>
<tr><td></td><td>C-a</td><td>移到行首</td></tr>
<tr><td></td><td>C-e</td><td>移到行尾</td></tr>
<tr><td></td><td>M-a</td><td>移到句首</td></tr>
<tr><td></td><td>M-e</td><td>移到句尾</td></tr>
<tr><td></td><td>C-p</td><td>后退一行</td></tr>
<tr><td></td><td>C-n</td><td>前进一行</td></tr>
<tr><td></td><td>M-x goto-line</td><td>跳到指定行</td></tr>
<tr><td></td><td>C-v</td><td>向下翻页</td></tr>
<tr><td></td><td>M-v</td><td>向上翻页</td></tr>
<tr><td></td><td>M-&lt;</td><td>缓冲区头部</td></tr>
<tr><td></td><td>M-&gt;</td><td>缓冲区尾部</td></tr>
<tr><td></td><td>C-M-f</td><td>向前匹配括号</td></tr>
<tr><td></td><td>C-M-b</td><td>向后匹配括号</td></tr>
<tr><td></td><td>C-l</td><td>当前行居中</td></tr>
<tr><td></td><td>M-n or C-u n</td><td>重复操作随后的命令n次</td></tr>
<tr><td></td><td>C-u</td><td>重复操作随后的命令4次</td></tr>
<tr><td></td><td>C-u C-u</td><td>重复操作随后的命令8次</td></tr>
<tr><td></td><td>C-x ESC ESC</td><td>执行历史命令记录，M-p选择上一条命令，M-n选择下一条命令</td></tr>
<tr><td></td><td>C-d</td><td>删除一个字符</td></tr>
<tr><td></td><td>M-d</td><td>删除一个字</td></tr>
<tr><td></td><td>C-k</td><td>删除一行</td></tr>
<tr><td></td><td>M-k</td><td>删除一句</td></tr>
<tr><td></td><td>C-w</td><td>删除标记区域</td></tr>
<tr><td></td><td>C-y</td><td>粘贴删除的内容</td></tr>
<tr><td></td><td>C-@</td><td>标记开始区域</td></tr>
<tr><td></td><td>C-x h</td><td>标记所有文字</td></tr>
<tr><td></td><td>C-x C-x</td><td>交换光标位置和区域标记区开头</td></tr>
<tr><td></td><td>M-w</td><td>复制标记区域</td></tr>
<tr><td></td><td>C-_ or C-x u</td><td>撤消操作</td></tr>
<tr><td></td><td>M-x shell</td><td>打开SHELL	执行SHELL命令</td></tr>
<tr><td></td><td>M-!</td><td>执行SHELL命令 (shell-command)</td></tr>
<tr><td></td><td>M-1 M-!</td><td>执行SHELL命令,命令输出插入光标位置,不打开新输出窗口</td></tr>
<tr><td></td><td>C-x r t</td><td>输入注释内容	多行注释（光标起始列到光标结束列之间填充注释内容）</td></tr>
<tr><td></td><td>c-x r k</td><td>反多行注释(选中到最后一行紧挨着注释字符之后的位置按)</td></tr>
<tr><td></td><td>M C-\</td><td>自动缩进光标和标记间的区域</td></tr>
<tr><td></td><td>M-m</td><td>移动光标到行首第一个(非空格)字符</td></tr>
<tr><td></td><td>M-^</td><td>将当前行接到上一行末尾处</td></tr>
<tr><td></td><td>M-;</td><td>添加缩进并格式化的注释</td></tr>
<tr><td></td><td>C-c C-q</td><td>根据缩进风格缩进整个函数</td></tr>
<tr><td></td><td>C-c C-a</td><td>切换自动换行功能</td></tr>
<tr><td></td><td>C-c C-d</td><td>一次性删除光标后的一串空格(greedy delete)</td></tr>
<tr><td></td><td>M-</td><td></td></tr>
<tr><td>窗口操作</td><td>C-x 0</td><td>关闭本窗口</td></tr>
<tr><td></td><td>C-x 1</td><td>只留下一个窗口</td></tr>
<tr><td></td><td>C-x 2 </td><td>垂直均分窗口</td></tr>
<tr><td></td><td>C-x 3 </td><td>水平均分窗口</td></tr>
<tr><td></td><td>C-x o</td><td>切换到别的窗口</td></tr>
<tr><td></td><td>C-x s</td><td>保存所有窗口的缓冲</td></tr>
<tr><td></td><td>C-x b</td><td>选择当前窗口的缓冲区</td></tr>
<tr><td></td><td>C-x ^</td><td>纵向扩大窗口</td></tr>
<tr><td></td><td>C-x }</td><td>横向扩大窗口</td></tr>
<tr><td></td><td>C-x {</td><td>横向缩小窗口</td></tr>
<tr><td>缓冲区列表操作</td><td>C-x C-b</td><td>打开缓冲区列表</td></tr>
<tr><td></td><td>d or k</td><td>标记为删除</td></tr>
<tr><td></td><td>~</td><td>标记为未修改状态</td></tr>
<tr><td></td><td>%</td><td>标记为只读</td></tr>
<tr><td></td><td>s</td><td>保存缓冲</td></tr>
<tr><td></td><td>u</td><td>取消标记</td></tr>
<tr><td></td><td>x</td><td>执行标记的操作</td></tr>
<tr><td></td><td>f</td><td>在当前窗口打开该缓冲区</td></tr>
<tr><td></td><td>o</td><td>在其他窗口打开该缓冲区</td></tr>
<tr><td>目录操作说明：</td><td>目录模式中，如果输入!，在命令行中包含*或者?，有特殊的含义。*匹配当前光标所在的文件和所有标记的文件，?分别在每一个标记的文件上 执行该命令。</td><td></td></tr>
<tr><td></td><td>C-x d</td><td>打开目录模式</td></tr>
<tr><td></td><td>s</td><td>按日期/文件名排序显示</td></tr>
<tr><td></td><td>v</td><td>阅读光标所在的文件</td></tr>
<tr><td></td><td>q</td><td>退出阅读的文件</td></tr>
<tr><td></td><td>d</td><td>标记为删除</td></tr>
<tr><td></td><td>x</td><td>执行标记</td></tr>
<tr><td></td><td>D</td><td>马上删除当前文件</td></tr>
<tr><td></td><td>C</td><td>拷贝当前文件</td></tr>
<tr><td></td><td>R</td><td>重名名当前文件</td></tr>
<tr><td></td><td>＋</td><td>新建文件夹</td></tr>
<tr><td></td><td>Z</td><td>压缩文件</td></tr>
<tr><td></td><td>!</td><td>对光标所在的文件执行SHELL命令</td></tr>
<tr><td></td><td>g</td><td>刷新显示</td></tr>
<tr><td></td><td>i</td><td>在当前缓冲区的末尾插入子目录的内容</td></tr>
<tr><td></td><td>[n]m</td><td>标记光标所在的文件，如果指定n，则从光标所在的文件起后n个文件被标记</td></tr>
<tr><td></td><td>[n]u</td><td>取消当前光标标记的文件，n的含义同上</td></tr>
<tr><td></td><td>t</td><td>反向标记文件</td></tr>
<tr><td></td><td>%-m</td><td>正则标记</td></tr>
<tr><td></td><td>q</td><td>退出目录模式</td></tr>
<tr><td>程序编译</td><td></td><td>M-x compile </td></tr>
<tr><td></td><td>M-x gdb</td><td>GDB排错</td></tr>
<tr><td></td><td>M-x dbx</td><td>DBX排错</td></tr>
<tr><td></td><td>M-x xdb</td><td>XDB排错</td></tr>
<tr><td></td><td>M-x sdb</td><td>SDB排错</td></tr>
<tr><td>搜索模式</td><td>C-s key</td><td>向前搜索</td></tr>
<tr><td></td><td>C-s</td><td>查找下一个</td></tr>
<tr><td></td><td>ENTER</td><td>停止搜索</td></tr>
<tr><td></td><td>C-r key </td><td>反向搜索</td></tr>
<tr><td></td><td>C-s C-w</td><td>以光标所在位置的字为关键字搜索</td></tr>
<tr><td></td><td>C-s C-s</td><td>重复上次搜索</td></tr>
<tr><td></td><td>C-r C-r</td><td>重复上次反向搜索</td></tr>
<tr><td></td><td>C-s ENTER C-w</td><td>进入单词搜索模式</td></tr>
<tr><td></td><td>C-r ENTER C-w</td><td>进入反向单词搜索模式</td></tr>
<tr><td></td><td>M-x replace-string ENTER search-string ENTER</td><td>替换(选中的)不选中则从光标位置替换到结尾</td></tr>
<tr><td></td><td>M-% search-string ENTER replace-string ENTER</td><td>交互替换（空格则跳过y则替换，无需选中）</td></tr>
<tr><td></td><td>C-r</td><td>在进入单词搜索(查找/替换)模式后，该命令进入迭代编辑模式</td></tr>
<tr><td></td><td>C-M-x</td><td>退出迭代编辑模式，返回到查找/替换模式</td></tr>
<tr><td></td><td>C-M- s</td><td>向前正则搜索</td></tr>
<tr><td></td><td>C-M-r</td><td>向后正则搜索</td></tr>
<tr><td></td><td>M-,(逗号)</td><td>在tags-search里跳至下一个匹配处</td></tr>
<tr><td></td><td>M-x tags-query-replace</td><td>在设置过标签的所有文件里替换文本</td></tr>
<tr><td></td><td>M-x tags-search ENTER</td><td>在所有标签里搜索(使用正则表达式)</td></tr>
<tr><td></td><td>M-.(点)</td><td>搜索标签</td></tr>
<tr><td></td><td>C-M-%</td><td>正则交互替换</td></tr>
<tr><td>shell</td><td>C-c C-c</td><td>相当于Bash下的C-c</td></tr>
<tr><td></td><td>C-c C-z</td><td>相当于Bash下的C-z</td></tr>
<tr><td></td><td>C-c C-d</td><td>相当于Bash下的C-d</td></tr>
<tr><td></td><td>M-p</td><td>执行前一条命令</td></tr>
<tr><td></td><td>C-n</td><td>执行下一条命令</td></tr>
<tr><td></td><td>C-c C-o</td><td>删除最后一条命令产生的输出</td></tr>
<tr><td></td><td>C-c C-r</td><td>屏幕滚动到最后一条命令输出的开头</td></tr>
<tr><td></td><td>C-c C-e</td><td>屏幕滚动到最后一套命令输出的结尾</td></tr>
<tr><td></td><td>C-c C-p</td><td>查看前一条命令的输出</td></tr>
<tr><td></td><td>C-c C-n</td><td>查看后一条命令的输出</td></tr>
<tr><td>打印资料</td><td>M-x print-buffer</td><td>先使用pr,然后使用lpr</td></tr>
<tr><td></td><td>M-x lpr-buffer</td><td>直接使用lpr</td></tr>
<tr><td></td><td>M-x print-region</td><td></td></tr>
<tr><td></td><td>M-x lpr-region</td><td></td></tr>
<tr><td>收发邮件</td><td>M-x mail</td><td>发送邮件, C-c C-s 发送,C-c C-c 发送并退出</td></tr>
<tr><td></td><td>M-x rmail</td><td>接受邮件</td></tr>
<tr><td>版本控制</td><td>C-x v d</td><td>显示当前目录下所有注册过的文件(show all registered files in this dir)</td></tr>
<tr><td></td><td>C-x v =</td><td>比较不同版本间的差异(show diff between versions)</td></tr>
<tr><td></td><td>C-x v u</td><td>移除上次提交之后的更改(remove all changes since last checkin)</td></tr>
<tr><td></td><td>C-x v ~</td><td>在不同窗格中显示某个版本(show certain version in different window)</td></tr>
<tr><td></td><td>C-x v l</td><td>打印日志(print log)</td></tr>
<tr><td></td><td>C-x v i</td><td>标记文件等待添加版本控制(mark file for version control add)</td></tr>
<tr><td></td><td>C-x v h</td><td>给文件添加版本控制文件头(insert version control header into file)</td></tr>
<tr><td></td><td>C-x v r</td><td>获取命名过的快照(check out named snapshot)</td></tr>
<tr><td></td><td>C-x v s</td><td>创建命名的快照(create named snapshot)</td></tr>
<tr><td></td><td>C-x v a</td><td>创建gnu风格的更改日志(create changelog file in gnu-style)</td></tr>
</tbody></table>
<hr />
<h2>layout: post
title: Git命令
date: 2015-07-23
category: 版本控制
tag: git</h2>
<p><strong>摘要:</strong>
传说林纳斯嫌弃svn不好用就自己写了一个版本控制器叫做git.然后git成了很多人使用的
版本控制器,当然排除他的个人影响力之外git是一个非常了不起的版本控制工具.当然git
好用还是在命令行里面,一下是在命令行里面的一些命令,方便自己查阅用到.git还有很多
很特别和使用的功能.比如subtree等等.</p>
<hr />
<h4><a class="header" href="#global-config" id="global-config">global config</a></h4>
<ul>
<li>git config --global color.ui true # show the color in ui </li>
<li>git config --global user.name &quot;youname&quot; </li>
<li>git config --global user.email &quot; xxxx@xx.com&quot; vjknct</li>
<li>git config -u-list  # show the git config list</li>
</ul>
<hr />
<h4><a class="header" href="#config-ignore-file" id="config-ignore-file">Config Ignore File</a></h4>
<p>Touch a file with named <code>.gitignore</code>  and save in git init dir .
edit the file you want to ignore </p>
<hr />
<h4><a class="header" href="#git-usually-command" id="git-usually-command">Git Usually Command</a></h4>
<ul>
<li>
<p>cd adir</p>
</li>
<li>
<p>git init # init a git dit</p>
</li>
<li>
<p>git add readme.txt # 添加文件（修改的文件或者新的文件）到暂存区 </p>
</li>
<li>
<p>git commit -m &quot;wrote a readme file&quot; # 提交暂存区中所有文件到当前分支中 -m标注提交信息 </p>
</li>
<li>
<p>git status # 查看仓库状态 </p>
</li>
<li>
<p>git commit readme.txt -m &quot;commit the modefied file&quot; </p>
</li>
</ul>
<hr />
<h4><a class="header" href="#git-log" id="git-log">Git Log</a></h4>
<ul>
<li>git log # 查看git操作的日志信息（提交信息 </li>
<li>git log -5 # the last 5 logs</li>
<li>git log --pretty=oneline # show log main commit info in oneline by every log</li>
<li>git log --graph --pretty=oneline --abbrev-commit # 查看分支合并情况 </li>
<li>git log --graph # 查看分支合并图（左侧的那条线或者分支线） </li>
</ul>
<hr />
<h4><a class="header" href="#about-reset-command" id="about-reset-command">About reset command</a></h4>
<ul>
<li>git reset --hard HEAD^ # 版本回退到上一个版本 </li>
<li>git reset --hard HEAD~3 # 版本回退3次的版本 </li>
<li>git reflog # 查看 commit-id 以及操作信息 </li>
<li>git reset --hard <commit-id> # 版本回退找回新版本 </li>
<li>git reset HEAD filename # 将已经添加到暂存区的撤销到工作区 </li>
<li>git reset HEAD filename # 移动指向被删除的文件的指针到删除前 </li>
</ul>
<hr />
<h4><a class="header" href="#git-diff" id="git-diff">Git Diff</a></h4>
<p>git diff # 查看工作区的文件内容和暂存区文件内同的不同部分 
git diff HEAD -- <filename> # 查看暂存区和版本库中文件内容的不同部分 </p>
<hr />
<h4><a class="header" href="#git-checkout" id="git-checkout">Git Checkout</a></h4>
<ul>
<li>git checkout -- filename # remove you modify</li>
<li>git checkout f5810e08df0cb7cf82608d65cdb709cb430df2ea path/to/file # assagin a file conten to the commit id</li>
</ul>
<hr />
<h4><a class="header" href="#git-rm" id="git-rm">Git rm</a></h4>
<ul>
<li>git rm filename 
删除和git库的关联，同时删除文件,如果通过 rm 直接删除的则 利用git status 查看时候回有提醒删除文件，touch一个同名的文件则git status 则会取消提醒了 </li>
</ul>
<hr />
<h4><a class="header" href="#about-github" id="about-github">About Github</a></h4>
<ul>
<li>
<p>ssh-keygen -t rsa -C &quot; xxx@xx.com&quot; # create file cmd by ssh
add the ssh puh key file into github setting
注册github的账号：AHLinJie 
在github中新建test文件夹 </p>
</li>
<li>
<p>git remote add origin  https://github.com/AHLinJie/test.git # 添加远程仓库名称为origin </p>
</li>
<li>
<p>git remote # 查看远程仓库名称 </p>
</li>
<li>
<p>git remote -v # 查询更详细的远程仓库信息 </p>
</li>
<li>
<p>git push -u origin master # 将本地库推送到远程仓库中 并建立本地与远程的master分支的关联  随后再次推送的时候就没必要用-u 参数 </p>
</li>
<li>
<p>git push origin dev # 推送dev分支到远程仓库 </p>
</li>
<li>
<p>git clone  https://github.com/AHLinJie/test2.git # 克隆github上面的远程文件到本地  前提是有远程的存在 </p>
</li>
</ul>
<p>注意： 
1. 远程克隆的文件包含了.git的文件，status是clean的 
2. 克隆到本地的文件夹都是没有提交的，但是在克隆的文件夹内是提交的，这里要注意区分版本库的范围，可以对应的目录下status查看下 </p>
<hr />
<h4><a class="header" href="#git-branch" id="git-branch">Git Branch</a></h4>
<ul>
<li>git checkout -b dev # 创建名称为dev的分支，并且切换到该分支 </li>
<li>git branch dev # 创建名称为dev的分支 </li>
<li>git branch # 查看当前分支 * 表示的分支 </li>
<li>git branch --all # 查看所有包括远程的分支 </li>
<li>git checkout master # 回到master分支 </li>
<li>git merge dev # 合并dev分支到master分支 </li>
<li>git merge --no-ff -m &quot;merge with no-f&quot; dev  # 或者使用--no-ff模式来提交保留分支历史信息 </li>
<li>git branch -d dev # 删除dev分支</li>
<li>git push origin --delete branchname  # 删除远程分支</li>
</ul>
<p>注意合并冲突内容： 
在合并的分支中处理冲突的内容（手动修改） </p>
<hr />
<h4><a class="header" href="#branch-strategy" id="branch-strategy">Branch Strategy：</a></h4>
<ul>
<li>
<p>branch master: </p>
<ol>
<li>非常稳定，时刻要和远程保持同步 </li>
<li>用来发布新版本 </li>
<li>禁止其他操作 
-branch dev： </li>
<li>用于开发测试，团队开发 </li>
<li>保持与远程同步 </li>
</ol>
</li>
<li>
<p>bug branch:</p>
<ol>
<li>git checkout -b issure-101 # 新建一个bug处理分支 </li>
<li>在dev分支 git stash # 存储工作现场，等处理bug后继续开发工作时恢复现场用 </li>
<li>选择要修复bug用的分支去处理bug问题 </li>
<li>等问题处理好了 </li>
<li>处理好后，回到工作现场所在的分支 </li>
<li>git stash list # 查看保存的现场信息 </li>
<li>git stash pop # 恢复现场（删除stash的信息） </li>
</ol>
</li>
<li>
<p>feature branch: </p>
<ol>
<li>开发过程中添加新特性、新功能 </li>
<li>git checkout -b feature-weixin </li>
<li>新建文件、编码开发、添加、提交、合并 </li>
<li>git branch -d feature-weixin # 删除该分区 </li>
<li>如果因为经费不足等问题要中止该功能开发 git branch -D feature-weixin # 强行删除该分支 </li>
</ol>
</li>
</ul>
<hr />
<h4><a class="header" href="#多人协作开发" id="多人协作开发">多人协作开发：</a></h4>
<ul>
<li>git branch --set-upstream dev origin/dev # 指定本地dev分支与远程origin/dev分支的链接 </li>
<li>git checkout -b dev origin/dev # 创建远程的origin dev分支到本地，如果有dev存在，则可以-d后重新建立 </li>
<li>git push origin dev # 推送本地分支到远程分支 </li>
</ul>
<hr />
<h4><a class="header" href="#git-tag" id="git-tag">Git Tag</a></h4>
<ul>
<li>git tag v1.01 # 为当前的commit id （版本）设置标签 切换到对应分支 </li>
<li>git log --pretty=oneline --abbrev-commit # 查询历史版本的commit id 设置标签 </li>
<li>git tag commit-id # 指定历史commit记录打标签 </li>
<li>git tag -a v1.03 -m &quot;create a ......&quot; commit-id # 指定commit-id 和注释的版本标签 </li>
<li>git show <tag-name> # 查看标签信息 </li>
<li>git tag -s v1.05 -m &quot;......&quot; <commit-id> # 使用秘钥签名一个标签 前提是安装了PGP(GnuPG) 没有安装则会报错 </li>
<li>git tag -d <tagname> # 删除tag标签 </li>
<li>git push origin <tagname> # 推送标签到远程仓库 </li>
<li>git push origin --tags # 推送本地所有标签到远程仓库 </li>
<li><strong>删除远程tag标签操作 首先删除本地的然后删除远程的</strong></li>
<li>git tag -d <tagname> # 删除本地的tag标签 </li>
<li>git push origin :refs/tags/<tagname> # 删除远程的tag标签 </li>
</ul>
<hr />
<h4><a class="header" href="#搭建git服务器" id="搭建git服务器">搭建git服务器：</a></h4>
<p>/home/lijie/gitbar # 远程仓库目录，这里是Ubuntu虚拟机中的目录 </p>
<ol>
<li>
<p>sudo apt-get install git </p>
</li>
<li>
<p>sudo adduser git  # 创建用户 </p>
</li>
<li>
<p>sudo git init --bare sample.git # 创建裸仓库（没有工作区：服务器是纯粹共享用的） </p>
</li>
<li>
<p>edit /etc/passwd
4.1 git:x:1001:1001:,,,:/home/git:/bin/bash 改为： 
git:x:1001:1001:,,,:/home/git:/usr/bin/git-shell # 禁用shell登陆 </p>
</li>
<li>
<p>sae git server certificate verification failed</p>
</li>
<li>
<p>edit file ～/.bashrc
add the line: <code>export GIT_SSL_NO_VERIFY=1</code>end of the file and source ~/.bashrc</p>
</li>
</ol>
<hr />
<h4><a class="header" href="#git-submodel" id="git-submodel">Git Submodel</a></h4>
<p>....</p>
<hr />
<h4><a class="header" href="#git-fetch" id="git-fetch">Git Fetch</a></h4>
<ul>
<li>git fetch origin  # 是将远程的代码pull下来在对应的分支　不去merge</li>
</ul>
<h4><a class="header" href="#git-blame" id="git-blame">Git Blame</a></h4>
<ul>
<li>git blame 
<ul>
<li><code>git blame -L 569,+10 models.py</code></li>
</ul>
</li>
</ul>
<hr />
<h2>layout: post
title: 前端开发实时工具
date: 2017-01-01
category: tools</h2>
<p><strong>摘要:</strong>
在前端样式以及页面甚至是js文件的开发过程中需要不断的刷新浏览器来查看执行效果;这里
介绍一些工具来帮助提高开发效率.</p>
<h5><a class="header" href="#livestyle" id="livestyle">livestyle</a></h5>
<ol>
<li>安装livestyle chrome 插件</li>
<li>在sublime中安装livestyle插件(如果有旧版本先卸载掉重新安装)</li>
<li>根据插件使用方法使用.</li>
</ol>
<h5><a class="header" href="#livereload" id="livereload">livereload</a></h5>
<ol>
<li>使用pip install livereload</li>
<li>运行命令livereload &lt;目录&gt;,制定目录做实时的修改加载
<a href="https://github.com/lepture/python-livereload">Github</a></li>
</ol>
<h5><a class="header" href="#browsersync工具" id="browsersync工具">browsersync工具</a></h5>
<p><a href="https://browsersync.io/">WEBSITE</a></p>
<hr />
<h2>layout: post
title: RESTFUL API
category: norm
tag: restful
date: 2016-7-1</h2>
<p><strong>摘要:</strong>
REST: Representational State Transfer</p>
<p>restful是一种设计规范．</p>
<p><a href="https://www.processon.com/mindmap/589ff5cbe4b0999184959471">思维导图</a></p>
<p><a href="http://www.ruanyifeng.com/blog/2014/05/restful_api.html">参考链接</a></p>
<h5><a class="header" href="#思维导图-1" id="思维导图-1">思维导图</a></h5>
<p><img src="other//images/restful.png" alt="" /></p>
<hr />
<h2>layout: post
title: ubuntu 开发中需要安装的依赖包
category: system
date: 2015-1-1</h2>
<p>sudo apt-get install</p>
<p>libssl-dev
libcurl4-openssl-dev
python-dev
libmysqlclient-dev
libjpeg8 
libjpeg62-dev 
libfreetype6 
libfreetype6-dev</p>
<hr />
<h2>layout: post
title: Vim配置及插件
date: 2015-08-09
category: Edit
tag: vim</h2>
<p><strong>摘要:</strong>
我喜欢vim了,现在!
不是我朝三暮四哈,确实是vim很好用,现在又有很多的插件可以使用,还有结合github的包
管理工具,简直是太人性化了已经.因为之前插件的问题一直没有使用的好,一直没有用.
我都觉得是个遗憾了, 不过学习总是不迟的,从现在开始我就尽量使用vim来写代码和文档了
加油!</p>
<p>工具及插件：
https://github.com/tpope/vim-pathogen  # vim 插件管理工具
https://github.com/fatih/vim-go  # go语言高亮插件
https://github.com/rking/ag.vim  # 搜索插件</p>
<p>https://github.com/majutsushi/tagbar.git  # tagbar插件
sudo apt-get install exuberant-ctags  # 系统要安装ctags 注意版本
go get -u github.com/jstemmer/gotags # 让vim支持golang的tagbar</p>
<p>还有gocode代补全插件 这里暂时不使用</p>
<p>https://github.com/vim-scripts/The-NERD-tree.git # 目录插件</p>
<p>快捷键：</p>
<ol>
<li>
<p>ctrl+w  后 hjkl选则窗口</p>
</li>
<li>
<p>ctrl+w  后 c </p>
</li>
<li>
<p>ctrl+f   向前翻页</p>
</li>
<li>
<p>ctrl+b  向后翻页</p>
</li>
<li>
<p>z 重画页面</p>
</li>
<li>
<p>r  在NERDTree页面按r键刷新目录显示新创建的文件</p>
</li>
<li>
<p>ctrl+v   后 jk选择行  I  后 输入注释内容  后 esc     #  多行注释</p>
</li>
<li>
<p>ctrl+v  后 I  左右移动要注释的字符串  jk上下选中取消注释的行   后   d   删除注释    # 取消多行注释 </p>
</li>
<li>
<p>d$  光标到行尾剪切  d^ 光标到行首剪切</p>
</li>
<li>
<p>10, 20 s/A/B  # 多行替换,10行到20行 替换A为B</p>
</li>
<li>
<p>ctrl + r  # 反撤销</p>
</li>
</ol>
<p>配置文件：
if has(&quot;gui_running&quot;)
set lines=999 columns=999
endif</p>
<p>&quot;可以在buffer的任何地方使用鼠标
set mouse=a
set selection=exclusive
set selectmode=mouse,key</p>
<p>&quot;设置编码
set encoding=utf-8
set fencs=utf-8,ucs-bom,shift-jis,gb18030,gbk,gb2312,cp936
set fileencodings=utf-8,ucs-bom,chinese</p>
<p>&quot;语言设置
set langmenu=zh_CN.UTF-8</p>
<p>&quot;设置语法高亮
syntax enable
syntax on</p>
<p>&quot;高亮当前行
set cursorline
hi CursorLine  cterm=NONE   ctermbg=darkred ctermfg=white
hi CursorColumn cterm=NONE ctermbg=darkred ctermfg=white</p>
<p>&quot;80列提示
au BufWinEnter * let w:m2=matchadd('Underlined', '%&gt;' . 80 . 'v.+', -1)</p>
<p>&quot;启用状态栏信息
set laststatus=2
&quot;设置命令行的高度为2，默认为1
set cmdheight=2</p>
<p>&quot; 把空格键映射成:
nmap <space> :
&quot;设置配色方案
colorscheme torte</p>
<p>&quot;改变输入状态光标的颜色为白色
hi Cursor guibg=white
set cursorline
hi CursorLine guifg=red guibg=blue
set cursorcolumn
set wildmenu</p>
<p>&quot;高亮显示匹配的括号
set showmatch
set number
set showcmd
set lazyredraw</p>
<p>&quot;去掉vi一致性
set nocompatible</p>
<p>&quot;设置缩进
set tabstop=4
set softtabstop=4
set shiftwidth=4
set expandtab
set autoindent
set cindent
if &amp;term==&quot;xterm&quot;
set t_Co=8
set t_Sb=^[[4%dm
set t_Sf=^[[3%dm
endif</p>
<p>&quot;不要备份文件
set nobackup
set nowb
&quot;不要生成swp文件（多人修改产生）
set noswapfile</p>
<p>&quot;python 语法校验
let g:pyflakes_use_quickfix = 0
filetype plugin indent on</p>
<p>&quot; searching
set incsearch
set hlsearch</p>
<p>&quot;folding 
set foldenable
set foldlevelstart=10
set foldnestmax=10
set foldmethod=indent</p>
<p>&quot;movement
nnoremap B ^
nnoremap E $
nnoremap gV <code>[v</code>]</p>
<p>&quot;vim-pathogen
execute pathogen#infect()
syntax on
filetype plugin indent on</p>
<p>set runtimepath^=~/</p>
<p>nmap <F8> :TagbarToggle<CR></p>
<p>&quot;nerd tree config
autocmd vimenter * NERDTree
autocmd StdinReadPre * let s:std_in=1
autocmd VimEnter * if argc() == 0 &amp;&amp; !exists(&quot;s:std_in&quot;) | NERDTree | endif
map <F7> :NERDTreeToggle<CR>
autocmd bufenter * if (winnr(&quot;$&quot;) == 1 &amp;&amp; exists(&quot;b:NERDTreeType&quot;) &amp;&amp; b:NERDTreeType == &quot;primary&quot;) | q | endif
let g:NERDTreeDirArrows = 1
let g:NERDTreeDirArrowExpandable = '▸'
let g:NERDTreeDirArrowCollapsible = '▾'
let NERDTreeIgnore = ['.pyc$']</p>
<hr />
<h2>layout: post
title: URL服务器访问流程整理
category: http
tag: http
date: 2016-10-10</h2>
<p><strong>摘要:</strong>
粗略整理的,浏览器访问网址的过程,以备后来深入学习.</p>
<p><a href="http://igoro.com/archive/what-really-happens-when-you-navigate-to-a-url/">参考地址</a></p>
<p><a href="https://www.processon.com/mindmap/58997b73e4b0c738ed115bfd">思维导图地址</a></p>
<h5><a class="header" href="#思维导图-2" id="思维导图-2">思维导图</a></h5>
<p><img src="other//images/web-url-flow.png" alt="" /></p>
<hr />
<h2><a class="header" href="#title-关于我" id="title-关于我">title: 关于我</a></h2>
<p>我不知道一个博客站点对一个开发人员有多重要。
我经常去看其他人的博客。</p>
<p>看很多童鞋都有自己的博客，而且里面还有很多深奥的文章，很羡慕。
就自己弄了这个博客，希望自己看着开心。</p>
<p>习惯使用python，学习golang过程中。
喜欢使用vim,emacs,当然还有Pycharm。
喜欢看书，看电影，写写不太深奥的代码。</p>
<p>这里写的都是自己能弄明白的，试验过的。
希望自己以后能看看。</p>
<p>如果有朋友想联系我，可以发邮件给我。</p>
<ol>
<li>dev.linjie@gmail.com</li>
<li>dev.linjie@yahoo.com</li>
</ol>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                

                
            </nav>

        </div>

        

        

        
        
        
        <script type="text/javascript">
            window.playpen_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        
        
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
        
        

    </body>
</html>
